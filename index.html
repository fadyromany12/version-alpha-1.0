<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>KOMPASS (Konecta Operations, Management & Personnel Self-Service)</title>
    
    <!-- Fonts and Chart Libraries (Unaltered) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'table']});
      google.charts.setOnLoadCallback(() => { chartsLoaded = true; }); 
    </script>
    
    <!-- 
    ==================================================================
    == NEW: KOMPASS PRO STYLESHEET
    == A complete redesign by a professional web app designer.
    == This single <style> block contains all new layouts, colors,
    == and responsive rules for the premium Konecta-themed UI.
    ==================================================================
    -->
    <style>
      /* --- Part 1: Color Palette & Root Variables --- */
      :root {
        /* Konecta Branding */
        --konecta-dark: #2900c9; 
        --konecta-blue: #00a9e0;
        --konecta-yellow: #f0fa00; 

        /* Core UI - NEW LIGHT MODE (Default for Agents) */
        --font-sans: 'Inter', Arial, sans-serif;
        --page-bg: #f4f6f8;             /* Clean, very light grey/blue */
        --card-bg: #ffffff;
        --header-bg: var(--konecta-dark);/* Branded header */
        --sidebar-bg: #ffffff;
        --text-color: #111827;           /* Dark, legible text */
        --text-color-secondary: #6b7280;
        --border-color: #e5e7eb;
        --input-bg: #f9fafb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --radius: 8px;

        /* Status Colors (Light) */
        --status-pending-bg: #fefce8; 
        --status-pending-text: #a16207;
        --status-success-bg: #f0fdf4; 
        --status-success-text: #166534;
        --status-info-bg: #eff6ff; 
        --status-info-text: #1d4ed8;
        --status-error-bg: #fef2f2; 
        --status-error-text: #b91c1c;
      }

      /* --- Part 2: Premium Dark Mode (Default for Admins) --- */
      body.dark-mode {
        --page-bg: #111827;              /* Deep, sophisticated navy/charcoal */
        --card-bg: #1f2937;              /* Lighter card background */
        --header-bg: #1f2937;            /* Header blends with card */
        --sidebar-bg: #1f2937;
        --text-color: #f9fafb;
        --text-color-secondary: #9ca3af;
        --border-color: #374151;
        --input-bg: #374151;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);

        /* Status Colors (Dark) */
        --status-pending-bg: #423b0b; 
        --status-pending-text: #fef08a;
        --status-success-bg: #14361e; 
        --status-success-text: #bbf7d0;
        --status-info-bg: #1e3a8a; 
        --status-info-text: #bfdbfe;
        --status-error-bg: #5f1414; 
        --status-error-text: #fecaca;
      }
      
      
      

      /* --- Global Styles --- */
      *, *::before, *::after {
        box-sizing: border-box;
      }
      
      body, html {
        font-family: var(--font-sans);
        margin: 0; 
        padding: 0;
        background-color: var(--page-bg);
        color: var(--text-color);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      body {
        display: flex;
        flex-direction: column;
      }
      
      h1, h2, h3, h4, strong {
        color: var(--text-color);
        font-weight: 600;
      }
      h2 { font-size: 1.5rem; margin: 0 0 1rem 0; }
      h3 { font-size: 1.25rem; margin: 1.5rem 0 1rem 0; color: var(--konecta-blue); }

      /* --- App Loader --- */
      #app-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--page-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }
      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border-color);
        border-top-color: var(--konecta-blue); /* Use bright blue for spinner */
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* --- Main Header --- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        background-color: var(--header-bg);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
        height: 75px; /* MODIFIED: Increased height for new logo */
      }
      body[data-role="agent"] header {
        border-bottom-color: var(--konecta-dark);
      }
      body.dark-mode header {
        background-color: var(--header-bg);
      }
      
      .header-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        overflow: hidden;
      }
      .logo-container {
        width: 150px; /* MODIFIED: Increased width */
        height: 50px; /* MODIFIED: Increased height */
        border-radius: 6px;
        overflow: hidden;
        background-color: #ffffff; /* Always white for logo BG */
        flex-shrink: 0; 
      }
      .header-logo {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 4px; 
        box-sizing: border-box; 
      }
      
      header h1 { 
        color: #ffffff; /* White title on dark header */
        font-size: 1.25rem;
        font-weight: 600; 
        margin: 0;
        white-space: nowrap;
      }
      body.dark-mode header h1 {
        color: var(--text-color);
      }
      
      .header-kap {
        color: var(--konecta-blue); /* Bright blue KAP */
        font-weight: 400;
        font-size: 0.8rem;
        margin-left: 8px;
        opacity: 0.8;
      }
      body.dark-mode .header-kap {
        color: var(--konecta-blue);
      }
      
      .header-controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      #header-refresh-button, #header-role-request-button {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color-secondary);
        cursor: pointer;
        height: 36px;
        width: 36px;
        padding: 0;
        border-radius: var(--radius); 
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-sm);
      }
      body[data-role="agent"] #header-refresh-button,
      body[data-role="agent"] #header-role-request-button {
         border-color: #ffffff44;
         color: #ffffffcc;
      }
      body[data-role="agent"] #header-refresh-button:hover,
      body[data-role="agent"] #header-role-request-button:hover {
         background-color: #ffffff1a;
      }
      
      #header-role-request-button { display: none; }
      
      #header-refresh-button:hover, #header-role-request-button:hover {
        background-color: var(--card-bg);
        border-color: var(--konecta-blue);
      }
      #header-role-request-button img, #header-refresh-button img {
        width: 18px; 
        height: 18px;
      }
      body[data-role="agent"] #header-role-request-button img,
      body[data-role="agent"] #header-refresh-button img {
        filter: invert(1);
      }
      body.dark-mode #header-role-request-button img,
      body.dark-mode #header-refresh-button img {
        filter: invert(1);
      }

      #header-refresh-button.loading img { animation: spin 1s linear infinite; }
      #header-role-request-button.loading img { animation: spin 1s linear infinite; }
      #header-role-request-button { position: relative; }
      #header-role-request-button.has-notification::after {
        content: '';
        position: absolute;
        top: 6px; right: 6px;
        width: 8px; height: 8px;
        background-color: #ea4335; 
        border-radius: 50%;
        border: 2px solid var(--header-bg);
      }

      /* Dark Mode Toggle */
      .dark-mode-toggle-wrapper {
        display: flex;
        align-items: center;
        height: 34px;
      }
      #dark-mode-toggle { opacity: 0; width: 0; height: 0; }
      .switch-label {
        position: relative;
        display: block;
        width: 52px;
        height: 28px;
        border-radius: 14px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        cursor: pointer;
        box-shadow: var(--shadow-sm);
      }
      body[data-role="agent"] .switch-label {
        background-color: #ffffff22;
        border-color: #ffffff44;
      }
      .switch-label:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background-color: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }
      .sun-icon, .moon-icon {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        transition: opacity 0.3s ease;
        color: var(--konecta-yellow);
      }
      .sun-icon { left: 6px; opacity: 1; color: #f59e0b; }
      .moon-icon { right: 6px; opacity: 0; color: var(--konecta-blue); }
      #dark-mode-toggle:checked + .switch-label { background-color: var(--konecta-dark); }
      #dark-mode-toggle:checked + .switch-label:before { transform: translateX(24px); }
      #dark-mode-toggle:checked + .switch-label .sun-icon { opacity: 0; }
      #dark-mode-toggle:checked + .switch-label .moon-icon { opacity: 1; }

      /* --- Part 4: New App Layout (Sidebar + Content) --- */
      .app-container {
        display: flex;
        flex-grow: 1;
        height: calc(100vh - 75px); /* MODIFIED: Full height minus new header height */
      }
      
      #app-sidebar {
        width: 240px;
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        padding: 16px;
        overflow-y: auto;
        flex-shrink: 0;
        transition: width 0.3s ease;
      }
      
      #app-content {
        flex-grow: 1;
        padding: 32px;
        overflow-y: auto;
      }
      
      .tab-panel {
      display: none;
      max-width: 1280px; /* Max content width for readability */
      margin: 0 auto;
      
      /* --- ADD THESE LINES --- */
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-sm);
    }
      #punch-panel { display: block; }

      /* --- Part 5: New Vertical Navigation --- */
      .nav-group {
        margin-bottom: 16px;
      }
      .nav-group-title {
        padding: 0 12px;
        margin-bottom: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-color-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .tab-button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: transparent;
      color: var(--text-color);
      width: 100%;
      margin-bottom: 4px;
      text-align: left;
      transition: background-color 0.2s ease, color 0.2s ease;
      justify-content: flex-start; /* <-- ADD THIS LINE */
    }
      .tab-button .nav-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        stroke-width: 2;
        color: var(--text-color-secondary);
        margin: 0;
      }
      .tab-button:hover {
        background-color: var(--input-bg);
        color: var(--text-color);
      }
      .tab-button:hover .nav-icon {
        color: var(--text-color);
      }
      
      .tab-button.active {
        background-color: var(--konecta-blue);
        color: white;
        font-weight: 600;
      }
      body.dark-mode .tab-button.active {
        background-color: var(--konecta-blue);
        color: white;
      }
      .tab-button.active .nav-icon {
        color: white;
      }
      
      /* Hide nav buttons by default, JS will show them */
      #dashboard-tab-button, #my-schedule-tab-button,
      #leave-approval-tab-button, #history-report-tab-button, #schedule-tab-button,
      #admin-tools-tab-button, #reporting-line-tab-button, #coaching-tab-button,
      #coaching-admin-tab-button, #registration-admin-tab-button, #announcements-admin-tab-button {
        display: none;
      }
      
      /* --- Part 6: New Button Styles --- */
      button, .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0; /* Remove default margin */
        padding: 10px 16px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: var(--radius);
        transition: all 0.2s ease;
        border: 1px solid transparent;
        min-width: 100px;
        white-space: nowrap;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      /* Primary Button (Konecta Dark) */
      button.btn-primary, .submit-btn-green, .approve-btn {
        background-color: var(--konecta-dark);
        color: white;
        border-color: var(--konecta-dark);
        box-shadow: var(--shadow-sm);
      }
      button.btn-primary:hover, .submit-btn-green:hover, .approve-btn:hover {
        background-color: #3a00e0;
        border-color: #3a00e0;
      }
      
      /* Secondary Button (Konecta Blue) */
      button.btn-secondary, .view-btn, .load-btn, .team-btn, .save-btn {
        background-color: var(--konecta-blue);
        color: white;
        border-color: var(--konecta-blue);
        box-shadow: var(--shadow-sm);
      }
      button.btn-secondary:hover, .view-btn:hover, .load-btn:hover, .team-btn:hover, .save-btn:hover {
        background-color: #0095c7;
        border-color: #0095c7;
      }

      /* Destructive Button (Red) */
      button.btn-danger, .deny-btn {
        background-color: #dc2626;
        color: white;
        border-color: #dc2626;
        box-shadow: var(--shadow-sm);
      }
      button.btn-danger:hover, .deny-btn:hover {
        background-color: #b91c1c;
        border-color: #b91c1c;
      }

      /* Ghost/Outline Button (Default) */
      #other-buttons button, .export-btn {
        background-color: transparent;
        color: var(--text-color-secondary);
        border-color: var(--border-color);
        box-shadow: var(--shadow-sm);
      }
      #other-buttons button:hover, .export-btn:hover {
        background-color: var(--input-bg);
        color: var(--text-color);
        border-color: var(--border-color);
      }
      
      /* Specific button groups */
      #buttons, #other-buttons {
        text-align: center;
        padding: 0;
        background: none;
        box-shadow: none;
      }
      #buttons button, #other-buttons button {
        margin: 5px;
      }
      
      .button-group {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .button-group:last-of-type { border-bottom: none; }
      
      button:disabled {
        background-color: var(--border-color);
        color: var(--text-color-secondary);
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: var(--border-color);
      }
      body.dark-mode button:disabled {
        background-color: var(--input-bg);
      }

      /* --- Status & Alert Messages --- */
      .status-message {
        margin: 16px 0;
        padding: 12px 16px;
        border-radius: var(--radius);
        font-size: 0.9rem;
        font-weight: 500;
        text-align: center;
        border: 1px solid transparent;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        transform: translateY(10px);
      }
      .status-message.visible {
        visibility: visible;
        opacity: 1;
        transform: translateY(0);
      }
      .status-message.success { background-color: var(--status-success-bg); color: var(--status-success-text); border-color: var(--status-success-text); }
      .status-message.error { background-color: var(--status-error-bg); color: var(--status-error-text); border-color: var(--status-error-text); }
      .status-message.processing { background-color: var(--status-info-bg); color: var(--status-info-text); border-color: var(--status-info-text); }
      .status-message.warning { background-color: var(--status-pending-bg); color: var(--status-pending-text); border-color: var(--status-pending-text); }

      #announcement-banner {
        background-color: var(--status-pending-bg) !important;
        color: var(--status-pending-text) !important;
        border-color: var(--status-pending-text) !important;
      }
      #announcement-banner strong,
      #announcement-banner button {
        color: var(--status-pending-text) !important;
      }
      
      /* --- Form & Input Styles --- */
      .form-container {
        padding: 24px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
      }
      .form-group { margin-bottom: 16px; }
      .form-group label {
        display: block;
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 6px;
        color: var(--text-color);
      }
      .form-group select, .form-group input, .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        box-sizing: border-box;
        background-color: var(--input-bg);
        color: var(--text-color);
        font-family: var(--font-sans);
        box-shadow: var(--shadow-sm);
      }
      .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
        outline: 2px solid var(--konecta-blue);
        outline-offset: 1px;
        border-color: var(--konecta-blue);
      }
      .form-group input[type="date"], .form-group input[type="time"] {
        color-scheme: var(--dark-mode-scheme, light); 
      }
      body.dark-mode { --dark-mode-scheme: dark; }
      .form-row { display: flex; flex-wrap: wrap; gap: 16px; }
      .form-row .form-group { flex: 1; min-width: 150px; }
      .form-group small {
        display: block;
        margin-top: 6px;
        font-size: 0.8rem;
        color: var(--text-color-secondary);
      }
      
      /* --- Section divider --- */
      .section-divider {
        border: 0;
        border-top: 1px solid var(--border-color);
        margin: 32px 0;
      }
      
      /* --- Card, List & Table Styles --- */
      .info-card {
        margin-bottom: 20px; 
        padding: 16px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        text-align: center;
        font-size: 1rem;
        font-weight: 500;
      }
      #admin-panel {
         background-color: var(--input-bg);
         border: 1px solid var(--border-color);
         border-radius: var(--radius);
      }
      
      #leave-balances {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }
      .balance-item {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 16px;
        text-align: center;
      }
      .balance-item p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-color-secondary);
        font-weight: 500;
      }
      .balance-item .balance-days {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--konecta-dark);
        display: block;
        margin-top: 4px;
      }
      body.dark-mode .balance-item .balance-days {
        color: var(--konecta-blue);
      }

      .request-list {
        margin-top: 24px;
        padding-top: 0;
      }
      .request-list-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 16px;
        box-shadow: var(--shadow-sm);
      }
      .request-list-item .item-details { flex: 1; min-width: 250px; }
      .request-list-item .item-details h4 {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
      }
      .request-list-item .item-details p {
        margin: 4px 0;
        font-size: 0.9rem;
        color: var(--text-color-secondary);
      }
      .request-list-item .item-actions {
        min-width: 150px;
        text-align: right;
        flex-shrink: 0;
      }
      
      /* Status Badges */
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 99px;
        text-transform: uppercase;
      }
      .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
      .status-approved { background-color: var(--status-success-bg); color: var(--status-success-text); }
      .status-denied { background-color: var(--status-error-bg); color: var(--status-error-text); }
      .status-Logged-In { background-color: var(--status-success-bg); color: var(--status-success-text); }
      .status-On-Break-Other { background-color: var(--status-info-bg); color: var(--status-info-text); }
      .status-On-Leave { background-color: var(--status-error-bg); color: var(--status-error-text); }
      .status-Absent { background-color: var(--status-error-bg); color: var(--status-error-text); }
      .status-Pending-Login { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
      .status-Logged-Out { background-color: var(--status-error-bg); color: var(--status-error-text); }

      /* Report Tables */
      #history-report-display, #my-schedule-display {
        margin-top: 20px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        overflow-x: auto; 
        box-shadow: var(--shadow-sm);
      }
      .report-table, .schedule-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      .report-table th, .report-table td, .schedule-table th, .schedule-table td {
        border-bottom: 1px solid var(--border-color);
        padding: 12px 16px;
        text-align: left;
        color: var(--text-color);
      }
      .report-table th, .schedule-table th {
        background-color: var(--input-bg);
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--text-color-secondary);
        text-transform: uppercase;
      }
      .report-table tr:last-child td, .schedule-table tr:last-child td {
        border-bottom: none;
      }
      .report-table tr:hover, .schedule-table tr:hover {
        background-color: var(--input-bg);
      }
      .schedule-table .day-today {
        font-weight: 600;
        background-color: var(--konecta-yellow);
        color: #333;
      }
      body.dark-mode .schedule-table .day-today {
        color: #111827;
      }
      
      /* --- Dashboard Styles --- */
      #dashboard-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
          gap: 24px;
      }
      .dashboard-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow-md);
      }
      .dashboard-card.full-width { grid-column: 1 / -1; }
      .dashboard-card h3 {
        margin: 0 0 16px 0;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 1.1rem;
      }
      .chart-container, .table-container {
        width: 100%;
        min-height: 350px;
        overflow-y: auto;
      }
      .dashboard-list-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-top: 0; 
      }
      .dashboard-detail-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px 16px;
        font-size: 0.9rem;
      }
      .dashboard-detail-item .detail-label {
        font-weight: 500;
        color: var(--text-color-secondary);
      }
      .dashboard-detail-item .detail-value {
        font-weight: 600;
        color: var(--text-color);
        text-align: right;
      }
      .dashboard-detail-item h4 {
        grid-column: 1 / -1;
        margin: 0;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
        color: var(--konecta-blue);
        font-size: 1rem;
      }
      .dashboard-leave-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }
      .dashboard-leave-item .item-details h4 {
        margin: 0 0 4px 0;
        font-size: 0.95rem;
      }
      .dashboard-leave-item .item-details p { margin: 0; font-size: 0.85rem; }
      
      .agent-status-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .agent-status-item strong { font-size: 0.95rem; font-weight: 500; }
      .status-tag {
        padding: 4px 10px;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 99px;
      }

      /* --- Hierarchy Tree View Styles --- */
      #dashboard-hierarchy-container { flex: 2; min-width: 300px; }
      #hierarchy-tree-view {
          padding: 8px;
          max-height: 250px;
          overflow-y: auto;
          border: 1px solid var(--border-color);
          border-radius: var(--radius);
          background-color: var(--card-bg);
      }
      .tree-node {
          padding: 6px;
          cursor: pointer;
          user-select: none;
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 0.9rem;
          border-radius: 4px;
      }
      .tree-node:hover { background-color: var(--input-bg); }
      .tree-node.selected {
          background-color: var(--konecta-dark);
          color: white;
          font-weight: 500;
      }
      .tree-node.selected .tree-label { color: white !important; }
      .tree-node.selected .role-icon { filter: brightness(0) invert(1); }
      .tree-label { flex-grow: 1; display: flex; align-items: center; gap: 6px; }
      .toggle-icon {
          width: 16px;
          height: 16px;
          transition: transform 0.2s;
          flex-shrink: 0;
          opacity: 0.5;
      }
      .collapsed .toggle-icon { transform: rotate(-90deg); }
      .tree-node[data-has-children="false"] .toggle-icon { visibility: hidden; }
      .subordinates-list {
          margin-left: 14px;
          padding-left: 8px;
          border-left: 1px solid var(--border-color);
          display: none;
      }
      .role-icon { width: 14px; height: 14px; }
      .role-icon.agent { color: var(--konecta-blue); }
      .role-icon.admin { color: var(--konecta-yellow); }
      .role-icon.superadmin { color: var(--konecta-dark); }
      body.dark-mode .role-icon.admin { color: #facc15; } /* Brighter yellow for dark bg */

      /* --- Coaching & Admin Panel Styles --- */
      .qa-category {
        margin-top: 16px;
        padding: 16px;
        background-color: var(--input-bg);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
      }
      .qa-category h4 { margin: 0 0 12px 0; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
      .qa-criterion { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
      .qa-criterion:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
      .qa-criterion p { margin: 0 0 8px 0; font-weight: 500; }
      .qa-criterion-inputs { display: flex; flex-wrap: wrap; gap: 12px; }
      .qa-criterion-inputs select { flex: 1; min-width: 150px; background-color: var(--card-bg); }
      .qa-criterion-inputs textarea { flex: 2; min-width: 200px; height: 50px; min-height: 50px; background-color: var(--card-bg); }
      #coaching-overall-score {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--konecta-dark);
        margin-top: 10px;
      }
      body.dark-mode #coaching-overall-score { color: var(--konecta-yellow); }
      .coaching-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .coaching-list-header .export-btn { display: none; }
      
      /* --- Premium Modal Styles --- */
      .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(17, 24, 39, 0.7); /* Dark bg */
        backdrop-filter: blur(4px);
        z-index: 199;
      }
      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px; /* Default max width */
        max-height: 90vh;
        background-color: var(--card-bg);
        border-radius: var(--radius);
        z-index: 200;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        flex-direction: column;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--konecta-dark);
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.15rem;
        color: white;
      }
      .modal-header .close-btn {
        background: none;
        border: none;
        font-size: 1.75rem;
        cursor: pointer;
        color: #ffffff99;
        padding: 0;
        margin: 0;
        line-height: 1;
        min-width: auto;
        box-shadow: none;
      }
      .modal-header .close-btn:hover {
        color: white;
        transform: none;
      }
      
      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex-grow: 1;
      }
      .modal-body p {
        margin: 0 0 16px 0;
        color: var(--text-color-secondary);
      }
      .modal-body .form-container {
        padding: 0;
        border: none;
        box-shadow: none;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background-color: var(--input-bg);
        text-align: right;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }
      .modal-footer button {
        margin: 0;
      }
      .modal-footer .btn-secondary { /* Cancel button */
        background-color: transparent;
        color: var(--text-color-secondary);
        border-color: var(--border-color);
        box-shadow: var(--shadow-sm);
      }
      .modal-footer .btn-secondary:hover {
        background-color: var(--input-bg);
        color: var(--text-color);
      }

      /* Specific modal sizes */
      #coaching-detail-modal { max-width: 800px; }
      #confirm-modal { max-width: 450px; }

      /* --- Responsive --- */
      @media (max-width: 1024px) {
        #app-sidebar {
          width: 68px; /* Collapse sidebar */
          padding: 16px 8px;
        }
        #app-sidebar .nav-button-text {
          display: none; /* Hide text */
        }
        #app-sidebar .nav-icon {
          margin: 0; /* MODIFIED: Left-align icon */
        }
        #app-sidebar .nav-group-title {
          text-align: center;
        }
        #app-sidebar .nav-group-title span {
          display: none;
        }
        #app-sidebar .nav-group-title::before {
          content: '‚Ä¢ ‚Ä¢ ‚Ä¢'; /* Show dots for section */
          font-size: 1rem;
        }
        .header-kap { display: none; }
      }

      @media (max-width: 768px) {
        /* On mobile, sidebar goes away, content is full screen */
        .app-container {
          flex-direction: column;
        }
        #app-sidebar {
          width: 100%;
          height: auto;
          border-right: none;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          overflow-x: auto;
          padding: 8px;
        }
        .nav-group {
          display: flex;
          margin-bottom: 0;
        }
        .nav-group-title { display: none; }
        .tab-button {
          flex-direction: column;
          gap: 4px;
          padding: 8px;
          min-width: 80px;
        }
        #app-sidebar .nav-icon {
          margin: 0 auto; /* MODIFIED: Re-center icon for mobile bottom-bar view */
        }
        .tab-button .nav-button-text {
          display: block;
          font-size: 0.75rem;
        }

        #app-content {
          padding: 20px;
        }
        .content-container {
          padding: 0; /* Remove old padding */
        }
        
        .form-row {
          flex-direction: column;
          gap: 16px;
        }
        .request-list-item {
            flex-direction: column;
            align-items: stretch;
        }
        .request-list-item .item-actions {
            text-align: left;
            margin-top: 10px;
        }
        .dashboard-detail-item {
           grid-template-columns: 1fr 1fr;
        }
        .dashboard-detail-item .detail-value {
           grid-column: span 1;
           text-align: left;
        }
        .qa-criterion-inputs {
          flex-direction: column;
        }
        .coaching-list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }
      }
      
      /* --- Footer --- */
      footer {
        text-align: center;
        padding: 20px;
        background-color: var(--page-bg);
        color: var(--text-color-secondary);
        border-top: 1px solid var(--border-color);
        font-size: 0.8rem;
      }
      footer p {
        margin: 0;
      }
      /* --- New Searchable Multi-Select Styles --- */
.multi-select-wrapper {
  position: relative;
  width: 100%;
  font-family: var(--font-sans);
}

.multi-select-trigger {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background-color: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  user-select: none;
  min-height: 42px;
}

.multi-select-trigger:hover {
  border-color: var(--konecta-blue);
}

.selected-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  overflow: hidden;
  max-height: 60px;
}

.select-tag {
  background-color: var(--konecta-blue);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  gap: 4px;
}

.select-tag .remove-tag {
  cursor: pointer;
  font-weight: bold;
}

.multi-select-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  display: none; /* Hidden by default */
  margin-top: 4px;
  max-height: 300px;
  overflow-y: auto;
}

.multi-select-dropdown.open {
  display: block;
}

.dropdown-search-container {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
  position: sticky;
  top: 0;
  background-color: var(--card-bg);
  z-index: 1001;
}

.dropdown-search-input {
  width: 100%;
  padding: 8px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 0.9rem;
  background-color: var(--input-bg);
  color: var(--text-color);
}

.dropdown-options-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.dropdown-option {
  padding: 10px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border-color);
}

.dropdown-option:hover {
  background-color: var(--input-bg);
}

.dropdown-option.selected {
  background-color: #eff6ff; /* Light Blue */
}
body.dark-mode .dropdown-option.selected {
  background-color: #1e3a8a;
}

.dropdown-option input[type="checkbox"] {
  pointer-events: none; /* Let the row click handle it */
}

.dropdown-actions {
  padding: 8px;
  display: flex;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-color);
  font-size: 0.8rem;
}

.dropdown-action-btn {
  background: none;
  border: none;
  color: var(--konecta-blue);
  cursor: pointer;
  font-weight: 600;
}

/* --- Phase 7: Command Center Styles --- */
      #command-center-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .metric-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s;
      }
      .metric-card:hover { transform: translateY(-2px); }
      .metric-title { font-size: 0.85rem; color: var(--text-color-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
      .metric-value { font-size: 2rem; font-weight: 700; color: var(--text-color); margin: 8px 0; }
      .metric-sub { font-size: 0.8rem; color: var(--text-color-secondary); }
      
      /* Color coding for metrics */
      .metric-good { color: #16a34a; } /* Green */
      .metric-warn { color: #ca8a04; } /* Yellow */
      .metric-bad { color: #dc2626; }  /* Red */

.status-offline { background-color: #e5e7eb; color: #374151; }
body.dark-mode .status-offline { background-color: #374151; color: #9ca3af; }

.read-only-field { background-color: #f3f4f6 !important; color: #6b7280 !important; cursor: not-allowed; }
.profile-subview { animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      
    #mobile-blocker {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--page-bg);
        z-index: 2147483647; /* Max z-index */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px;
      }

      /* 1. Standard CSS Check (for normal mobile view)
         2. JS-Enforced Class (for "Desktop Site" bypassers)
      */
      @media (max-width: 768px) {
        body .app-container, body header, body footer, body #app-loader, body .modal-backdrop, body .modal { display: none !important; }
        body #mobile-blocker { display: flex !important; }
        body { overflow: hidden !important; }
      }

      /* Force block if JS detects mobile device regardless of screen width */
      body.force-mobile-block .app-container, 
      body.force-mobile-block header, 
      body.force-mobile-block footer, 
      body.force-mobile-block #app-loader,
      body.force-mobile-block .modal-backdrop,
      body.force-mobile-block .modal { 
        display: none !important; 
      }
      
      body.force-mobile-block #mobile-blocker { 
        display: flex !important; 
      }
      
      body.force-mobile-block { 
        overflow: hidden !important; 
      }
      /* [END] NEW: Mobile Restriction Styles */

      /* Heatmap Styles */
.heatmap-row {
    margin-bottom: 15px;
    background: var(--card-bg);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
}
.heatmap-header {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
}
.timeline-track {
    position: relative;
    height: 30px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    width: 100%;
}
.timeline-bar {
    position: absolute;
    height: 100%;
    top: 0;
    font-size: 0.7rem;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    white-space: nowrap;
}
/* Colors */
.bar-Work { background-color: #10b981; z-index: 1; }
.bar-Break { background-color: #f59e0b; z-index: 2; }
.bar-Lunch { background-color: #f59e0b; z-index: 2; }
.bar-Aux { background-color: #3b82f6; z-index: 2; }


/* --- NEW TIMELINE GRID STYLES --- */
.timeline-container {
    position: relative;
    width: 100%;
    overflow-x: auto;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding-bottom: 10px;
}

/* The Time Scale Header (00:00 - 23:00) */
.timeline-scale {
    display: flex;
    height: 30px;
    border-bottom: 1px solid var(--border-color);
    background: var(--input-bg);
    min-width: 800px; /* Force scroll on small screens */
    position: relative;
}
.scale-hour {
    flex: 1; /* Distribute evenly */
    border-right: 1px solid #e5e7eb;
    font-size: 0.7rem;
    color: var(--text-color-secondary);
    display: flex;
    align-items: center;
    justify-content: left;
    padding-left: 4px;
}
/* 30-min Grid Lines Background */
.timeline-grid-bg {
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    display: flex;
    z-index: 0;
    pointer-events: none;
}
.grid-col {
    flex: 1;
    border-right: 1px dashed #f3f4f6; /* Subtle 30min line */
}
.grid-col:nth-child(even) {
    border-right: 1px solid #e5e7eb; /* Stronger Hour line */
}

/* Agent Row */
.timeline-agent-row {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    min-width: 800px;
}
.timeline-agent-info {
    width: 180px;
    padding: 10px;
    border-right: 1px solid var(--border-color);
    background: var(--card-bg);
    flex-shrink: 0;
    position: sticky;
    left: 0;
    z-index: 10;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
}
.timeline-track-area {
    flex-grow: 1;
    position: relative;
    height: 50px;
    background: transparent;
}

/* Bars */
.t-bar {
    position: absolute;
    top: 10px;
    height: 30px;
    border-radius: 4px;
    font-size: 0.7rem;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    white-space: nowrap;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    z-index: 2;
    cursor: default;
}
.t-bar:hover { z-index: 5; transform: scaleY(1.1); }

/* Status Colors */
.t-work { background: #10b981; }
.t-break { background: #f59e0b; }
.t-lunch { background: #d97706; }
.t-aux { background: #3b82f6; }
.t-sched { 
    background: repeating-linear-gradient(
      45deg,
      #e5e7eb,
      #e5e7eb 10px,
      #f3f4f6 10px,
      #f3f4f6 20px
    );
    opacity: 0.6;
    z-index: 1;
    color: #666;
    border: 1px dashed #9ca3af;
}

/* Adherence Flags */
.t-flag {
    position: absolute;
    top: -5px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 6;
    cursor: help;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.flag-late { background: #dc2626; } /* Red */
.flag-early { background: #dc2626; }
.flag-window { background: #7c3aed; } /* Purple */
.flag-noshow { background: #000; } /* Black */

/* Tooltip on hover */
.t-flag:hover::after {
    content: attr(data-msg);
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 10;
}



    </style>
  </head>
  
  <!-- 
  ==================================================================
  == NEW: KOMPASS PRO HTML BODY
  == This body has a new layout:
  == 1. <header> (Sticky Topbar)
  == 2. <div class="app-container">
  ==    - <nav id="app-sidebar"> (Vertical Navigation)
  ==    - <main id="app-content"> (Main Content Area)
  == 3. Modals (Remain at the end)
  ==================================================================
  -->
  <body>
    
    <div id="mobile-blocker">
      <div class="logo-container" style="margin-bottom: 24px; width: 180px; height: 60px; background: #fff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
          <img class="header-logo" src="https://image2url.com/images/1762976595272-13dc7db5-88f2-48e6-bffb-39d4830812e5.png" alt="Konecta Logo">
      </div>
      <h2 style="font-size: 1.5rem; color: var(--text-color); margin-bottom: 12px;">Konecta PC Access Required</h2>
      <p style="color: var(--text-color-secondary); font-size: 1rem; max-width: 320px; line-height: 1.5;">
        KOMPASS is optimized for workstation use. <br>Please access this tool from a Konecta laptop or desktop computer.
      </p>
    </div>
    

    <!-- App Loader -->
    <div id="app-loader">
      <div class="spinner"></div>
    </div>

    <!-- Main Header -->
    <header>
      <div class="header-brand">
        <div class="logo-container">
          <img class="header-logo" src="https://image2url.com/images/1762976595272-13dc7db5-88f2-48e6-bffb-39d4830812e5.png" alt="Konecta Logo">
        </div>
        <h1>KOMPASS <span class="header-kap">Konecta Operations, Management & Personnel Self-Service</span></h1>
      </div>

      <div class="header-controls">
        <div class="dark-mode-toggle-wrapper" title="Toggle Dark Mode">
            <input type="checkbox" id="dark-mode-toggle">
            <label for="dark-mode-toggle" class="switch-label">
                <span class="sun-icon">‚òÄÔ∏è</span>
                <span class="moon-icon">üåô</span>
            </label>
        </div>
        
        <button id="header-refresh-button" title="Refresh Data" onclick="refreshCurrentData()">
          <!-- Inline SVG Icon -->
          <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
        </button>

        <button id="header-role-request-button" title="Request Role Upgrade" onclick="showRoleRequestModal()">
          <!-- Inline SVG Icon -->
          <svg id="role-request-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
        </button>
      </div>
    </header>
    
    <!-- New Main App Layout Container -->
    <div class="app-container">
    
      <!-- New Vertical Sidebar Navigation -->
      <nav id="app-sidebar">
        
        <div class="nav-group">
          <div class="nav-group-title" title="Agent Tools"><span>Agent Tools</span></div>
          <button id="profile-tab-button" class="tab-button" onclick="showTab('profile')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span class="nav-button-text">My Profile</span>
          </button>
          <button id="punch-tab-button" class="tab-button active" onclick="showTab('punch')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            <span class="nav-button-text">Punch Clock</span>
          </button>
          
          <button id="my-schedule-tab-button" class="tab-button" onclick="showTab('my-schedule')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span class="nav-button-text">My Schedule</span>
          </button>
          <button id="leave-request-tab-button" class="tab-button" onclick="showTab('leave-request')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect x="3" y="4" width="18" height="18" rx="2"></rect><path d="M3 10h18"></path><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M12 18h.01"></path><path d="M16 18h.01"></path></svg>
            <span class="nav-button-text">My Leave</span>
          </button>
          <button id="history-report-tab-button" class="tab-button" onclick="showTab('history-report')">
             <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>
            <span class="nav-button-text">History Report</span>
          </button>
          <!-- MODIFIED: Coaching tab moved here -->
          <button id="coaching-tab-button" class="tab-button" onclick="showTab('coaching')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <span class="nav-button-text">Coaching</span>
          </button>
          <button id="performance-tab-button" class="tab-button" onclick="showTab('performance')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
            <span class="nav-button-text">Performance</span>
          </button>

          <button id="offboarding-tab-button" class="tab-button" onclick="showTab('offboarding')">
            <span class="nav-icon">üö©</span>
            <span class="nav-button-text">Offboarding</span>
          </button>

          <button id="overtime-tab-button" class="tab-button" onclick="showTab('overtime')">
            <span class="nav-icon">‚è±</span>
            <span class="nav-button-text">Overtime</span>
          </button>

        </div>
        
        <div class="nav-group">
          <div class="nav-group-title" title="Management"><span>Management</span></div>
          <button id="dashboard-tab-button" class="tab-button" onclick="showTab('dashboard')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
            <span class="nav-button-text">Dashboard</span>
          </button>
          <button id="leave-approval-tab-button" class="tab-button" onclick="showTab('leave-approval')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 9c0 .6-.4 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h9a1 1 0 0 1 1 1v5Z"></path><path d="M18 15c0 .6-.4 1-1 1h-3a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v3Z"></path><path d="M21 12v7a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1v-7"></path><path d="m10 10 3 3 3-3"></path></svg>
            <span class="nav-button-text">Approvals</span>
          </button>
          <button id="reporting-line-tab-button" class="tab-button" onclick="showTab('reporting-line')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
            <span class="nav-button-text">Reporting Line</span>
          </button>
        
          <!-- MODIFIED: Coaching tab removed from here -->
        </div>

        <div class="nav-group">
          <div class="nav-group-title" title="Admin"><span>Admin</span></div>

          <button id="finance-admin-tab-button" class="tab-button" onclick="showTab('finance-admin')">
            <span class="nav-icon">üí∞</span>
            <span class="nav-button-text">Finance Admin</span>
          </button>

          <button id="analytics-tab-button" class="tab-button" onclick="showTab('analytics')">
  <span class="nav-icon">üìä</span>
  <span class="nav-button-text">Analytics</span>
</button>
          <button id="schedule-tab-button" class="tab-button" onclick="showTab('schedule')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><path d="M12 12h-4v4h4v-4z"></path><path d="M16 2v4"></path><path d="M8 2v4"></path><path d="M3 10h18"></path></svg>
            <span class="nav-button-text">Schedule Editor</span>
          </button>
          <button id="project-admin-tab-button" class="tab-button" onclick="showTab('project-admin')">
           <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
           <span class="nav-button-text">Project Admin</span>
         </button>
          <button id="admin-tools-tab-button" class="tab-button" onclick="showTab('admin-tools')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
            <span class="nav-button-text">Admin Tools</span>
          </button>
          <button id="coaching-admin-tab-button" class="tab-button" onclick="showTab('coaching-admin')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20.94c1.5 0 2.85-.83 3.53-2.06"></path><path d="M12 3.06c-1.5 0-2.85.83-3.53 2.06"></path><path d="M18.94 12c0 1.5-.83 2.85-2.06 3.53"></path><path d="M5.06 12c0-1.5.83-2.85 2.06-3.53"></path><circle cx="12" cy="12" r="1"></circle><path d="M19 12a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"></path></svg>
            <span class="nav-button-text">Coaching Admin</span>
          </button>
          <button id="registration-admin-tab-button" class="tab-button" onclick="showTab('registration-admin')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
            <span class="nav-button-text">Registrations</span>
          </button>
          <button id="announcements-admin-tab-button" class="tab-button" onclick="showTab('announcements-admin')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
            <span class="nav-button-text">Announcements</span>
          </button>
          <button id="recruitment-tab-button" class="tab-button" onclick="showTab('recruitment')">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span class="nav-button-text">Recruitment</span>
          </button>
          <button id="hr-admin-tab-button" class="tab-button" onclick="showTab('hr-admin')">
            <span class="nav-icon">üë•</span>
            <span class="nav-button-text">HR Admin</span>
          </button>
        </div>

      </nav>
      
      <!-- Main Content Area -->
      <!-- All tab panels are moved inside here -->
      <main id="app-content">
        
        <!-- ================================== -->
        <!--      TAB 1: PUNCH PANEL            -->
        <!-- ================================== -->
        <div id="punch-panel" class="tab-panel">

  <div id="announcement-banner-container" style="display: none; margin-bottom: 20px;">
    <div id="announcement-banner" class="status-message warning" style="visibility: visible; opacity: 1; text-align: left; padding-right: 35px; position: relative;">
      <strong style="display: block; margin-bottom: 5px;">Announcements</strong>
      <div id="announcement-content-area"></div>
      <button onclick="dismissAnnouncements()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; color: var(--status-pending-text); cursor: pointer; padding: 0; margin: 0; line-height: 1;">&times;</button>
    </div>
  </div>

  <div id="agent-info" class="info-card">Loading user info...</div> 
  
  <div id="admin-panel" class="info-card" style="display: none; text-align: left; overflow: visible;">
    <div id="agent-select-container"></div>
  </div>

  <div id="project-selector-container" class="info-card" style="text-align: left; margin-bottom: 20px; background-color: var(--input-bg);">
    <label for="current-project-select" style="font-weight: 500; margin-right: 10px;">Select Project:</label>
    <select id="current-project-select" style="max-width: 300px; padding: 8px;">
      <option value="">-- Loading Projects... --</option>
    </select>
  </div>

  <div id="timers-grid" style="display:none; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    
    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 12px;">
      <div style="background: var(--konecta-blue); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">‚è±Ô∏è</div>
      <div>
        <div style="font-size: 0.75rem; color: var(--text-color-secondary); text-transform: uppercase; font-weight: 600;">Total Shift Time</div>
        <div id="shift-timer-value" style="font-size: 1.5rem; font-weight: 700; color: var(--text-color); font-variant-numeric: tabular-nums;">00:00:00</div>
        <div style="font-size: 0.75rem; color: var(--text-color-secondary);">Login: <span id="shift-start-time">--:--</span></div>
      </div>
    </div>

    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 12px;">
      <div id="status-icon-bg" style="background: #10b981; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">‚ö°</div>
      <div>
        <div id="status-timer-label" style="font-size: 0.75rem; color: var(--text-color-secondary); text-transform: uppercase; font-weight: 600;">Current Activity</div>
        <div id="status-timer-value" style="font-size: 1.5rem; font-weight: 700; color: var(--text-color); font-variant-numeric: tabular-nums;">00:00:00</div>
        <div id="status-current-name" style="font-size: 0.85rem; font-weight: 500; color: var(--konecta-dark);">Logged Out</div>
      </div>
    </div>

  </div>

  <div id="current-status-display" class="status-message" style="visibility: hidden; text-align: center; margin-top: 0; margin-bottom: 20px;"></div>
  
  <div id="status" class="status-message"></div>
  
  <div id="buttons">
    <div class="button-group"><button class="btn-primary" onclick="punch('Login')">Login</button></div>
    <div class="button-group">
      <button class="btn-primary" onclick="punch('First Break In')">1st Break In</button>
      <button class="btn-primary" onclick="punch('First Break Out')">1st Break Out</button>
    </div>
    <div class="button-group">
      <button class="btn-primary" onclick="punch('Lunch In')">Lunch In</button>
      <button class="btn-primary" onclick="punch('Lunch Out')">Lunch Out</button>
    </div>
    <div class="button-group">
      <button class="btn-primary" onclick="punch('Last Break In')">Last Break In</button>
      <button class="btn-primary" onclick="punch('Last Break Out')">Last Break Out</button>
    </div>
    <div class="button-group">
      <button class="btn-primary" onclick="punch('Logout')">Logout</button>
    </div>
  </div>

  <div id="other-buttons">
     <div class="button-group">
       <button onclick="punch('Coaching In')">Coaching In</button>
       <button onclick="punch('Coaching Out')">Coaching Out</button>
     </div>
    <div class="button-group">
      <button onclick="punch('Meeting In')">Meeting In</button>
      <button onclick="punch('Meeting Out')">Meeting Out</button>
    </div>
     <div class="button-group">
       <button onclick="punch('Personal In')">Personal In</button>
       <button onclick="punch('Personal Out')">Personal Out</button>
     </div>
     <div class="button-group">
       <button onclick="punch('System Down In')" style="color: #dc2626; border-color: #dc2626;">System Down In</button>
       <button onclick="punch('System Down Out')" style="color: #dc2626; border-color: #dc2626;">System Down Out</button>
     </div>
  </div>
</div>

        <!-- ================================== -->
        <!--      TAB 2: MY SCHEDULE PANEL      -->
        <!-- ================================== -->
        <div id="my-schedule-panel" class="tab-panel">
          <h2 id="my-schedule-title">My Upcoming Schedule</h2>
          <p class="text-color-secondary">Your schedule for the next 7 days.</p>
          <div id="my-schedule-status" class="status-message"></div>
          <div id="my-schedule-display">
            <!-- JS will populate this -->
          </div>
        </div>


        <!-- ================================== -->
        <!--      TAB 2.1: MY PROFILE PANEL      -->
        <!-- ================================== -->

        <div id="profile-panel" class="tab-panel">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h2>My Employee Profile</h2>
    <span id="prof-status-badge" class="status-tag">Active</span>
  </div>
  
  <div class="button-group" style="justify-content: flex-start; gap: 10px; border-bottom: none; padding-bottom: 0;">
    <button class="btn-secondary active" id="btn-prof-general" onclick="switchProfileSubTab('general')">General</button>
    <button class="btn-secondary" id="btn-prof-contract" onclick="switchProfileSubTab('contract')">Contract & Job</button>
    <button class="btn-secondary" id="btn-prof-personal" onclick="switchProfileSubTab('personal')">Personal & PII</button>
    <button class="btn-secondary" id="btn-prof-docs" onclick="switchProfileSubTab('docs')">Documents</button>
    <button class="btn-secondary" id="btn-prof-finance" onclick="switchProfileSubTab('finance')">Financials</button>
  </div>
  <hr class="section-divider" style="margin: 10px 0 20px 0;">

  <div id="prof-view-general" class="profile-subview">
    <form id="prof-form-general" class="form-container">
      <div class="form-row">
        <div class="form-group"><label>Full Name</label><input type="text" id="prof-name" readonly class="read-only-field"></div>
        <div class="form-group"><label>Employee ID</label><input type="text" id="prof-id" readonly class="read-only-field"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Konecta Email</label><input type="text" id="prof-email" readonly class="read-only-field"></div>
        <div class="form-group"><label>Personal Email</label><input type="text" id="prof-personal-email"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Phone Number</label><input type="text" id="prof-phone"></div>
        <div class="form-group"><label>Home Address</label><input type="text" id="prof-address"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Emergency Contact</label><input type="text" id="prof-emergency"></div>
        <div class="form-group"><label>Relationship</label><input type="text" id="prof-relation"></div>
      </div>
      <div style="text-align:right; margin-top:15px;">
        <button type="button" class="btn-primary" onclick="saveProfile()">Save Changes</button>
      </div>
    </form>
  </div>

  <div id="prof-view-contract" class="profile-subview" style="display:none;">
    <div class="form-container">
      <h3 style="margin-top:0; color:var(--konecta-blue);">Job Details</h3>
      <div class="form-row">
        <div class="form-group"><label>Title</label><input type="text" id="prof-title" readonly class="read-only-field"></div>
        <div class="form-group"><label>Department</label><input type="text" id="prof-dept" readonly class="read-only-field"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Direct Manager</label><input type="text" id="prof-direct-mgr" readonly class="read-only-field"></div>
        <div class="form-group"><label>Project Manager</label><input type="text" id="prof-proj-mgr" readonly class="read-only-field"></div>
      </div>
      
      <hr class="section-divider">
      
      <h3 style="margin-top:0; color:var(--konecta-blue);">Contract Info</h3>
      <div class="form-row">
        <div class="form-group"><label>Hiring Date</label><input type="text" id="prof-hiring" readonly class="read-only-field"></div>
        <div class="form-group"><label>Contract Type</label><input type="text" id="prof-contract-type" readonly class="read-only-field"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Salary (Confidential)</label><input type="text" id="prof-salary" readonly class="read-only-field"></div>
        <div class="form-group"><label>IBAN</label><input type="text" id="prof-iban" placeholder="Request change via HR"></div>
      </div>
    </div>
  </div>

  <div id="prof-view-personal" class="profile-subview" style="display:none;">
    <div class="form-container">
      <div class="form-row">
        <div class="form-group"><label>National ID</label><input type="text" id="prof-nat-id" readonly class="read-only-field"></div>
        <div class="form-group"><label>Social Insurance</label><input type="text" id="prof-social" readonly class="read-only-field"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Birth Date</label><input type="text" id="prof-dob" readonly class="read-only-field"></div>
        <div class="form-group"><label>Age</label><input type="text" id="prof-age" readonly class="read-only-field" style="width:80px;"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Marital Status</label><input type="text" id="prof-marital" readonly class="read-only-field"></div>
        <div class="form-group"><label>Dependents</label><input type="text" id="prof-dependents" readonly class="read-only-field"></div>
      </div>
    </div>
  </div>

  <div id="prof-view-docs" class="profile-subview" style="display:none;">
    <div id="doc-list-container" class="request-list">
      <p class="text-color-secondary">Loading documents...</p>
    </div>
  </div>
  <div id="prof-view-finance" class="profile-subview" style="display:none;">
  <div class="form-container">
    <h3 style="margin-top:0; color:var(--konecta-blue);">Compensation Structure</h3>
    <div class="leave-balances" style="grid-template-columns: repeat(3, 1fr); gap:15px; display:grid; margin-bottom:20px;">
        <div class="balance-item"><p>Basic Salary</p><span class="balance-days" id="fin-basic">--</span></div>
        <div class="balance-item"><p>Variable Pay</p><span class="balance-days" id="fin-variable">--</span></div>
        <div class="balance-item"><p>Total Gross</p><span class="balance-days" id="fin-total">--</span></div>
    </div>
    <hr class="section-divider">
    <h3>Upcoming Entitlements & Payouts</h3>
    <div id="my-entitlements-list" class="request-list">
        <p class="text-color-secondary">Loading financial data...</p>
    </div>
  </div>
</div>

  <div id="profile-status" class="status-message"></div>
</div>

        <!-- ================================== -->
        <!--     TAB 3: MY LEAVE PANEL          -->
        <!-- ================================== -->
        <div id="leave-request-panel" class="tab-panel">
          <h2>My Balances</h2>
          <div id="leave-balances">
            <div class="balance-item"><p>Annual</p><span class="balance-days" id="balance-annual">--</span></div>
            <div class="balance-item"><p>Sick</p><span class="balance-days" id="balance-sick">--</span></div>
            <div class="balance-item"><p>Casual</p><span class="balance-days" id="balance-casual">--</span></div>
          </div>

          <form id="leave-form" class="form-container">
            <h2>Submit Leave Request</h2>
            <div class="form-group"><label for="leave-type">Leave Type</label>
            <select id="leave-type" onchange="toggleSickNoteField()"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-row">
              <div class="form-group"><label for="leave-start-date">Start Date</label><input type="date" id="leave-start-date" required></div>
              <div class="form-group"><label for="leave-end-date">End Date</label><input type="date" id="leave-end-date"><small>Leave blank for a single-day request.</small></div>
            </div>
            <div class="form-group"><label for="leave-reason">Reason (Optional)</label><textarea id="leave-reason" rows="3"></textarea></div>
            <div id="sick-note-upload-group" class="form-group" style="display: none;">
              <label for="sick-note-file">Upload Sick Note (PDF Required)</label>
              <input type="file" id="sick-note-file" class="form-group" accept=".pdf" style="border: none; padding: 0;">
              <small>This is mandatory for all 'Sick' leave requests.</small>
            </div>
            
            <button type="button" class="btn-primary" onclick="submitLeaveRequest()">Submit Request</button>
          </form>
          <div id="leave-status" class="status-message"></div>
          
          <div class="request-list">
            <h2 style="margin: 0;">My Request History</h2>
            <div id="my-requests-list" class="request-list" style="margin-top: 16px;">
              <!-- JS will populate this -->
            </div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    TAB 4: HISTORY REPORT PANEL     -->
        <!-- ================================== -->
        <div id="history-report-panel" class="tab-panel">
          <h2>Adherence History Report</h2>
          <form id="history-report-form" class="form-container" style="background-color: var(--input-bg);">
            <div class="form-group" id="history-user-select-container" style="display: none;">
  <label>Select User(s)</label>
  <div id="history-user-select-wrapper"></div>
</div>
            <div class="form-group">
              <label for="history-start-date">Start Date</label>
              <input type="date" id="history-start-date" required>
            </div>
            <div class="form-group">
              <label for="history-end-date">End Date</label>
              <input type="date" id="history-end-date" required>
            </div>
            <button type="button" class="btn-primary" onclick="loadHistoryReport()">View History</button>
            <button type="button" class="export-btn" id="export-csv-btn" onclick="exportHistoryToCSV()">Export to CSV</button>
          </form>
          
          <div id="my-history-status" class="status-message"></div>
          <div id="history-report-display">
             <p class
="text-color-secondary" style="margin-top: 20px; text-align: center;">Select users and dates, then click "View History" to generate the report.</p>
          </div>
        </div>

        <!-- ================================== -->
        <!--    TAB 5: SCHEDULE EDITOR PANEL    -->
        <!-- ================================== -->
        <div id="schedule-panel" class="tab-panel">
          
          <form id="csv-import-form" class="form-container">
            <h2>Bulk Schedule Importer (CSV)</h2>
            <p class="text-color-secondary" style="font-size: 0.9rem;">
              Upload a CSV with headers: <code>Name</code>, <code>StartDate</code>, <code>ShiftStartTime</code>, <code>EndDate</code>, <code>ShiftEndTime</code>, <code>LeaveType</code>, <code>agent email</code>
            </p>
            <button 
              type="button" 
              class="btn-secondary" 
              style="margin-bottom: 20px; max-width: 300px;" 
              onclick="downloadScheduleTemplate()">
              Download CSV Template
            </button>
            <div class="form-group">
              <label for="csv-file-input">Select CSV File</label>
              <input type="file" id="csv-file-input" accept=".csv">
            </div>
            <button type="button" class="btn-primary" onclick="importScheduleCSV()">Import CSV</button>
          </form>
          <div id="csv-import-status" class="status-message"></div>
          
          <hr class="section-divider">
          
          <form id="schedule-form" class="form-container">
            <h2>Manual Schedule Editor</h2>
            <div class="form-group">
  <label>User</label>
  <div id="schedule-agent-select-container"></div>
</div>
            <div class="form-row">
              <div class="form-group"><label for="schedule-start-date">Start Date</label><input type="date" id="schedule-start-date" required></div>
              <div class="form-group"><label for="schedule-end-date">End Date (Optional)</label><input type="date" id="schedule-end-date"><small>Leave blank to submit for a single day.</small></div>
            </div>
            <div class="form-group"><label for="schedule-leave-type">Leave Type / Status</label><select id="schedule-leave-type" onchange="toggleTimeFields()"><option value="Present">Present</option><option value="Sick">Sick</option><option value="Annual">Annual</option><option value="Casual">Casual</option><option value="Absent">Absent</option><option value="Day Off">Day Off</option></select></div>
            
            <div id="time-fields" class="form-row">
              <div class="form-group">
                <label for="schedule-start-time">Shift Start Time</label>
                <input type="time" id="schedule-start-time">
              </div>
              <div class="form-group">
                <label for="schedule-end-date-shift">Shift End Date</label>
                <input type="date" id="schedule-end-date-shift">
                <small>Only fill if shift ends on a different day.</small>
              </div>
              <div class="form-group">
                <label for="schedule-end-time">Shift End Time</label>
                <input type="time" id="schedule-end-time">
              </div>
            </div>
            <button type="button" class="btn-primary" onclick="submitSchedule()">Submit Schedule(s)</button>
          </form>
          <div id="schedule-status" class="status-message"></div>
        </div>
        
        <!-- ================================== -->
        <!--   TAB 6: LEAVE APPROVALS PANEL     -->
        <!-- ================================== -->
        <div id="leave-approval-panel" class="tab-panel">
          <h2>Leave Request Management</h2>
          <form id="leave-report-form" class="form-container" style="background-color: var(--input-bg); display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
            <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
  <label>Select User</label>
  <div id="leave-report-user-container"></div>
</div>
            <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
              <label for="leave-report-status">Select Status</label>
              <select id="leave-report-status">
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Denied">Denied</option>
                <option value="All">All</option>
              </select>
            </div>
            <button type="button" class="btn-primary" onclick="loadLeaveReport()">Load Requests</button>
          </form>

          <div id="approval-status" class="status-message"></div>
          <div id="pending-requests-list" class="request-list" style="margin-top: 16px;">
            <!-- JS will populate this -->
          </div>
        </div>
        
        <!-- ================================== -->
        <!--     TAB 7: ADMIN TOOLS PANEL       -->
        <!-- ================================== -->
        <div id="admin-tools-panel" class="tab-panel">
  
  <form id="manual-punch-form" class="form-container">
    <h2>Manual Punch Editor</h2>
    <p class="text-color-secondary" style="margin: -16px 0 16px 0;">Manually add or overwrite a punch for a user. This will bypass duplicate/sequential checks and recalculate metrics.</p>
    <div class="form-group">
  <label>User</label>
  <div id="manual-punch-user-container"></div>
</div>
    <div class="form-group"><label for="manual-punch-action">Punch Action</label><select id="manual-punch-action" required><option value="">-- Select an action --</option><optgroup label="Adherence"><option value="Login">Login</option><option value="First Break In">First Break In</option><option value="First Break Out">First Break Out</option><option value="Lunch In">Lunch In</option><option value="Lunch Out">Lunch Out</option><option value="Last Break In">Last Break In</option><option value="Last Break Out">Last Break Out</option><option value="Logout">Logout</option></optgroup><optgroup label="Other Codes"><option value="Coaching In">Coaching In</option><option value="Coaching Out">Coaching Out</option><option value="Meeting In">Meeting In</option><option value="Meeting Out">Meeting Out</option><option value="Personal In">Personal In</option><option value="Personal Out">Personal Out</option></optgroup></select></div>
    <div class="form-row"><div class="form-group"><label for="manual-punch-date">Date of Punch</label><input type="date" id="manual-punch-date" required></div><div class="form-group"><label for="manual-punch-time">Time of Punch</label><input type="time" id="manual-punch-time" required></div></div>
    <button type="button" class="btn-primary" onclick="submitManualPunch()">Submit Manual Punch</button>
  </form>
  <div id="manual-punch-status" class="status-message"></div>
  
  <hr class="section-divider">

  <div id="break-config-section">
    <h2>Break Configuration (Global)</h2>
    <p class="text-color-secondary" style="margin: -16px 0 16px 0;">Define the standard and maximum allowed durations (in seconds) for breaks.</p>
    
    <div id="break-config-container" class="form-container">
      <p class="text-color-secondary">Loading configuration...</p>
    </div>
    <div style="margin-top: 10px; text-align: right;">
        <button type="button" class="btn-primary" onclick="saveBreakConfig()">Save Configuration</button>
    </div>
    <div id="break-config-status" class="status-message"></div>
  </div>
  
  <hr class="section-divider">
  
  <div id="balance-adjustment-section" style="display: none;"> 
      <form id="balance-adjustment-form" class="form-container">
      <h2>Leave Balance Management</h2>
      <p class="text-color-secondary" style="margin: -16px 0 16px 0;">Manually adjust a user's leave balance. Use a positive number (e.g., 2) to add days, and a negative number (e.g., -1) to remove days.</p>
      <div class="form-group">
  <label>Select User</label>
  <div id="balance-user-select-container"></div>
</div>
      <div class="form-row">
        <div class="form-group"><label for="balance-leave-type">Leave Type</label><select id="balance-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
        <div class="form-group"><label for="balance-amount">Amount to Adjust</label><input type="number" id="balance-amount" step="0.5" placeholder="e.g., -1 or 1.5" required></div>
      </div>
      <div class="form-group"><label for="balance-reason">Reason for Adjustment</label><textarea id="balance-reason" rows="2" required></textarea></div>
      <button type="button" class="btn-primary" style="background-color: var(--konecta-yellow); color: #111827;" onclick="submitBalanceAdjustment()">Submit Balance Adjustment</button>
    </form>
    <div id="balance-adjust-status" class="status-message"></div>
    <hr class="section-divider">
  </div>
  
  <form id="admin-leave-form" class="form-container">
    <h2>Submit Leave on Behalf of User</h2>
    <p class="text-color-secondary" style="margin: -16px 0 16px 0;">Submit a leave request for a user. This will check their balance and send it to their assigned supervisor for approval.</p>
    <div class="form-group">
  <label>Select User</label>
  <div id="admin-leave-user-container"></div>
</div>
    <div class="form-group"><label for="admin-leave-type">Leave Type</label><select id="admin-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
    <div class="form-row"><div class="form-group"><label for="admin-leave-start-date">Start Date</label><input type="date" id="admin-leave-start-date" required></div><div class="form-group"><label for="admin-leave-end-date">End Date</label><input type="date" id="admin-leave-end-date"><small>Leave blank for a single-day request.</small></div></div>
    <div class="form-group"><label for="admin-leave-reason">Reason (Optional)</label><textarea id="admin-leave-reason" rows="3"></textarea></div>
    <button type="button" class="btn-primary" onclick="submitAdminLeaveRequest()">Submit Request for User</button>
  </form>
  <div id="admin-leave-status" class="status-message"></div>

  <hr class="section-divider">

</div>

        <!-- ================================== -->
        <!--     TAB 8: DASHBOARD PANEL         -->
        <!-- ================================== -->
        <div id="dashboard-panel" class="tab-panel">
          <h2 id="dashboard-title">Team Dashboard</h2>
          <div id="dashboard-controls" class="form-container" style="background-color: var(--input-bg);">
            <form id="dashboard-form">
              <div class="form-group" id="dashboard-hierarchy-container">
                <label>Team Hierarchy (Click user to select)</label>
                <div id="hierarchy-tree-view">
                  <p class="text-color-secondary">Loading team structure...</p>
                </div>
                <small class="text-color-secondary">Selected: <strong id="selected-user-display">None</strong></small>
              </div>
              
              <div class="form-group">
                <label for="dashboard-date">Select Date</label>
                <input type="date" id="dashboard-date" required>
              </div>
              
              <div id="dashboard-filters">
                <button type="button" class="btn-primary" onclick="loadDashboard()">Load Dashboard for Selected</button>
                <button type="button" class="btn-secondary" onclick="loadMyFullHierarchy()">Load My Full Hierarchy</button>
                <button type="button" class="save-btn" onclick="saveCurrentSelection()">Save Current Selection</button>
              </div>
            </form>
          </div>
          <div id="dashboard-status" class="status-message"></div>
          
          <hr class="section-divider">

          <div id="command-center-stats">
            <div class="metric-card">
              <span class="metric-title">Real-Time Capacity</span>
              <span class="metric-value" id="metric-capacity">--%</span>
              <span class="metric-sub" id="metric-capacity-sub">0/0 Agents</span>
            </div>
            <div class="metric-card">
              <span class="metric-title">Schedule Adherence</span>
              <span class="metric-value" id="metric-adherence">--%</span>
              <span class="metric-sub">Target: 95%</span>
            </div>
            <div class="metric-card">
              <span class="metric-title">Current Shrinkage</span>
              <span class="metric-value" id="metric-shrinkage">--%</span>
              <span class="metric-sub" id="metric-shrinkage-sub">0 Unavailable</span>
            </div>
            <div class="metric-card" style="cursor: pointer;" onclick="exportDashboardCSV()">
              <span class="metric-title">Export Data</span>
              <span class="metric-value" style="font-size: 1.5rem;">üì• CSV</span>
              <span class="metric-sub">Download Report</span>
            </div>
          </div>

          <div id="dashboard-grid">
            <div class="dashboard-card full-width">
              <h3>Agent Status (Real-Time)</h3>
              <div id="status-agent-list" class="chart-container"></div>
            </div>
            <div class="dashboard-card full-width">
              <h3>Adherence Details (Today)</h3>
              <div id="adherence-detail-table" class="dashboard-list-container"></div>
            </div>
            <div class="dashboard-card full-width">
              <h3>Pending Leave Requests (for selected users)</h3>
              <div id="pending-leave-table" class="dashboard-list-container"></div>
            </div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    NEW TAB 9: REPORTING LINE       -->
        <!-- ================================== -->
        <div id="reporting-line-panel" class="tab-panel">

          <div id="pending-movements-section">
            <h2>Pending Reporting Line Approvals</h2>
            <p class="text-color-secondary">This section shows requests for you to approve, or requests pending for admins who report to you.</p>
            <div id="movement-approval-status" class="status-message"></div>
            <div id="pending-movements-list" class="request-list">
              <p class="text-color-secondary">Loading pending approvals...</p>
            </div>
          </div>
          
          <hr class="section-divider">

          <form id="reporting-line-form" class="form-container">
  <h2>Submit New Movement Request</h2>
  <p class="text-color-secondary" style="margin: -16px 0 16px 0;">Select a user to move. You will be prompted to confirm their Project Manager.</p>
  
  <div class="form-group">
    <label>Select User to Move</label>
    <div id="reporting-line-user-container" onchange="onReportingLineUserChange()"></div>
  </div>

  <div class="form-group">
    <label>Assign New Direct Manager</label>
    <div id="reporting-line-supervisor-container"></div>
  </div>

  <div id="pm-change-section" style="display:none; padding: 15px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 20px;">
    <label style="color: var(--konecta-blue); font-weight:600;">Project Manager Selection</label>
    <p style="margin: 5px 0 10px 0; font-size: 0.9rem;">
      Current Project Manager: <strong id="current-pm-display">Loading...</strong>
    </p>
    
    <div style="margin-bottom: 10px;">
      <label style="margin-right: 15px; cursor: pointer;">
        <input type="radio" name="pm-action" value="keep" checked onclick="togglePMDropdown(false)"> Keep Current
      </label>
      <label style="cursor: pointer;">
        <input type="radio" name="pm-action" value="change" onclick="togglePMDropdown(true)"> Change
      </label>
    </div>

    <div id="pm-dropdown-wrapper" style="display:none;">
      <label>Select New Project Manager</label>
      <div id="reporting-line-pm-container"></div>
    </div>
  </div>
  
  <button type="button" class="btn-primary" onclick="submitMovementRequest()">Submit Movement Request</button>
</form>
          <div id="movement-request-status" class="status-message"></div>

          <hr class="section-divider">

          <div id="movement-history-section">
            <h2>User Movement History</h2>
            <p classs="text-color-secondary">Select one of your subordinates to view their complete movement history.</p>
            <form id="movement-history-form" class="form-container" style="background-color: var(--input-bg); display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
              <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
  <label>Select User</label>
  <div id="movement-history-user-container"></div>
</div>
              <button type="button" class="btn-primary" onclick="loadMovementHistory()">Load History</button>
            </form>
            <div id="movement-history-status" class="status-message"></div>
            <div id="movement-history-list" class="request-list" style="margin-top: 16px;">
              <p class="text-color-secondary">Select a user to view their movement history.</p>
            </div>
          </div>

        </div>

        <!-- ================================== -->
        <!--    NEW TAB 10: COACHING PANEL      -->
        <!-- ================================== -->
        <div id="coaching-panel" class="tab-panel">
          
          <div id="coaching-form-container" class="form-container" style="display: none;">
            <h2>Submit New Coaching</h2>
            <div class="form-group">
  <label>Select User</label>
  <div id="coaching-agent-select-container"></div>
</div>
            <div class="form-group">
              <label for="coaching-template-select">Select Coaching Template</label>
              <select id="coaching-template-select" required onchange="loadCoachingForm()">
                <option value="">-- Select a template --</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="coaching-session-date">Session Date</label>
                <input type="date" id="coaching-session-date" required>
              </div>
              <div class="form-group">
                <label for="coaching-week-number">Week Number</label>
                <input type="text" id="coaching-week-number" readonly style="background-color: var(--border-color);">
              </div>
            </div>
            
            <h3>Quality Score
              <span id="coaching-overall-score" style="float: right;">N/A</span>
            </h3>
            <div id="quality-score-form">
              <!-- JS will populate this -->
            </div>
            
            <hr class="section-divider">

            <div class="form-group">
              <label for="coaching-follow-up">Follow-up / Comments</label>
              <textarea id="coaching-follow-up" rows="4"></textarea>
            </div>
            
            <div class="form-group">
              <label for="coaching-follow-up-date">Follow-up Date (Optional)</label>
              <input type="date" id="coaching-follow-up-date">
            </div>
            
            <button type="button" class="btn-primary" onclick="submitNewCoaching()">Submit Coaching</button>
            <div id="coaching-submit-status" class="status-message"></div>
          </div>

          <div id="coaching-list-container">
            <div class="coaching-list-header">
              <h2 id="coaching-list-title" style="margin: 0;">My Coaching History</h2>
              <button type="button" class="export-btn" id="export-coaching-btn" onclick="exportCoachingHistory()">Export History</button>
            </div>
            
            <div id="coaching-list-status" class="status-message"></div>
            <div id="coaching-list" class="request-list">
              <p class="text-color-secondary">Your coaching history will appear here.</p>
            </div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--   TAB 11: COACHING ADMIN PANEL     -->
        <!-- ================================== -->
        <div id="coaching-admin-panel" class="tab-panel" style="display:none;">
          <form id="template-create-form" class="form-container">
            <h2>Create New Coaching Template</h2>
            <p class="text-color-secondary" style="margin: -16px 0 16px 0;">Create a new template. Add categories and criteria below. All fields are required.</p>
            
            <div class="form-group">
              <label for="template-name">Template Name</label>
              <input type="text" id="template-name" placeholder="e.g., 'Q1 Sales Template'" required>
            </div>
            
            <div id="template-categories-container">
              <!-- JS will populate this -->
            </div>
            
            <button type="button" class="btn-secondary" onclick="addTemplateCategory()" style="margin: 10px 0;">+ Add Category</button>
            <hr class="section-divider">
            <button type="button" class="btn-primary" onclick="saveNewTemplate()">Save New Template</button>
          </form>
          <div id="coaching-admin-status" class="status-message"></div>
        </div>

        <!-- ================================== -->
        <!--  TAB 12: REGISTRATION ADMIN PANEL  -->
        <!-- ================================== -->
        <div id="registration-admin-panel" class="tab-panel">
          <h2>New User Registrations</h2>
          <p class="text-color-secondary">Approve or deny new users who have registered and selected their supervisor. Approving them will activate their account.</p>
          <div id="registration-admin-status" class="status-message"></div>
          <div id="registration-admin-list" class="request-list" style="margin-top: 16px;">
            <!-- JS will populate this -->
          </div>
        </div>

        <!-- ================================== -->
        <!--  TAB 12.1: PROJECT ADMIN PANEL  -->
        <!-- ================================== -->
        

        <div id="project-admin-panel" class="tab-panel">
  <h2>Project Dashboard</h2>
  
  <div class="form-group">
      <label>Select Project</label>
      <select id="project-admin-select" onchange="loadProjectDashboardData()">
          <option value="">-- Loading --</option>
      </select>
  </div>

  <div id="project-stats-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
      <div class="metric-card"><span class="metric-title">Total Staff</span><span class="metric-value" id="prj-stat-total">0</span></div>
      <div class="metric-card"><span class="metric-title">Agents</span><span class="metric-value" id="prj-stat-agents">0</span></div>
      <div class="metric-card"><span class="metric-title">Supervisors</span><span class="metric-value" id="prj-stat-supers">0</span></div>
      <div class="metric-card"><span class="metric-title">TLs</span><span class="metric-value" id="prj-stat-tls">0</span></div>
  </div>

  <hr class="section-divider">

  <h3>Recent Requests (Audit Log)</h3>
  <div id="project-requests-list" class="request-list">
      <p class="text-color-secondary">Select a project to view requests.</p>
  </div>
  
  <hr class="section-divider">
  
  <form id="project-form" class="form-container">
    <h3>Create/Edit Project</h3>
    <div class="form-group">
      <label>Project Name</label>
      <input type="text" id="proj-name" required>
    </div>
    <div class="form-group">
      <label>Project Manager Email</label>
      <input type="email" id="proj-manager">
    </div>
    <button type="button" class="btn-primary" onclick="saveProject()">Save Project</button>
  </form>
</div>
        <!-- ================================== -->
        <!--  TAB 13: ANNOUNCEMENTS ADMIN PANEL -->
        <!-- ================================== -->
        <div id="announcements-admin-panel" class="tab-panel">
          <h2>Manage Announcements</h2>
          <p class="text-color-secondary">Create, edit, or delete announcements that appear on the Punch Clock.</p>

          <form id="announcement-form" class="form-container">
            <input type="hidden" id="announcement-id" value="">
            <div class="form-group">
              <label for="announcement-content">Announcement Content</label>
              <textarea id="announcement-content" rows="3" placeholder="Enter announcement text..."></textarea>
            </div>
            <div class="form-group">
              <label for="announcement-status">Status</label>
              <select id="announcement-status">
                <option value="Active">Active (Show to users)</option>
                <option value="Archived">Archived (Hide from users)</option>
              </select>
            </div>
            <button type="button" class="btn-primary" onclick="saveAnnouncement()">Save Announcement</button>
            <button type="button" class="btn-secondary" style="background-color: transparent; color: var(--text-color-secondary); border-color: var(--border-color);" onclick="clearAnnouncementForm()">Clear Form</button>
          </form>
          <div id="announcement-admin-status" class="status-message"></div>

          <hr class="section-divider">

          <h3>Existing Announcements</h3>
          <div id="announcement-admin-list" class="request-list" style="margin-top: 16px;">
            <p class="text-color-secondary">Loading announcements...</p>
          </div>
        </div>

        <!-- ================================== -->
        <!--  TAB 14: Recruitment PANEL -->
        <!-- ================================== -->

        <div id="recruitment-panel" class="tab-panel">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Recruitment & Hiring</h2>
    <div>
        <button class="btn-secondary" onclick="toggleJobBoard()">Manage Job Board</button>
        <button class="btn-primary" onclick="showRequisitionModal()">+ Open Requisition</button>
    </div>
  </div>

  <div id="job-board-view" style="display:none; margin-bottom: 20px; background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
    <h3>Active Job Requisitions</h3>
    <div id="job-list-container">Loading jobs...</div>
  </div>

  <div class="form-group">
    <input type="text" id="candidate-search" placeholder="Search candidates..." onkeyup="filterCandidates()" style="max-width: 300px;">
  </div>

  <div id="candidate-list" class="request-list">
    <p class="text-color-secondary">Loading pipeline...</p>
  </div>
</div>

        <!-- ================================== -->
        <!--  TAB 15: Performance PANEL -->
        <!-- ================================== -->


<div id="performance-panel" class="tab-panel">
  <h2>Performance Management</h2>
  
  <div id="manager-review-section" style="display:none; margin-bottom:30px; background:var(--input-bg); padding:20px; border-radius:8px; border:1px solid var(--border-color);">
    <h3 style="margin-top:0; color:var(--konecta-blue);">Submit New Review</h3>
    <form id="perf-form">
      <div class="form-row">
        <div class="form-group">
  <label>Select Employee</label>
  <div id="perf-employee-select-container"></div>
</div>
        <div class="form-group">
          <label>Review Period</label>
          <select id="perf-period">
            <option value="Q1">Q1</option>
            <option value="Q2">Q2</option>
            <option value="Q3">Q3</option>
            <option value="Q4">Q4</option>
            <option value="Annual">Annual</option>
            <option value="Probation">Probation</option>
          </select>
        </div>
        <div class="form-group">
          <label>Year</label>
          <input type="number" id="perf-year" value="2025">
        </div>
      </div>
      <div class="form-group">
        <label>Rating (1 - Poor to 5 - Excellent)</label>
        <div style="display:flex; gap:15px; align-items:center;">
          <input type="range" id="perf-rating" min="1" max="5" step="1" oninput="document.getElementById('rating-val').innerText = this.value">
          <span id="rating-val" style="font-weight:bold; font-size:1.2rem; color:var(--konecta-dark);">3</span>
        </div>
      </div>
      <div class="form-group">
        <label>Manager Comments</label>
        <textarea id="perf-comments" rows="3" placeholder="Highlight achievements and areas for improvement..."></textarea>
      </div>
      <button type="button" class="btn-primary" onclick="submitPerformanceReview()">Submit Review</button>
    </form>
    <div id="perf-submit-status" class="status-message"></div>
  </div>

  <h3 style="margin-bottom:15px;">My Performance History</h3>
  <div id="perf-history-list" class="request-list">
    <p class="text-color-secondary">Loading reviews...</p>
  </div>
</div>


        <!-- ================================== -->
        <!--  TAB 16: Finance ADMIN PANEL -->
        <!-- ================================== -->


<div id="finance-admin-panel" class="tab-panel">
  <h2>Financial Management</h2>
  
  <div class="button-group">
      <button class="btn-secondary" onclick="document.getElementById('fin-create-tmpl').style.display='block'">Create Template</button>
      <button class="btn-secondary" onclick="loadEntitlementTemplates()">Load Templates</button>
  </div>

  <div id="fin-create-tmpl" class="form-container" style="display:none; margin-bottom:20px;">
      <h3>New Entitlement Template</h3>
      <div class="form-row">
          <div class="form-group"><label>Template Name</label><input type="text" id="tmpl-name" placeholder="e.g. Q1 Performance Bonus"></div>
          <div class="form-group">
            <label>Type</label>
            <input type="text" id="tmpl-type" list="entitlement-types" placeholder="Select or type custom...">
            <datalist id="entitlement-types">
                <option value="Bonus">Bonus</option>
                <option value="Deduction">Deduction</option>
                <option value="Allowance">Allowance</option>
                <option value="Variable Pay">Variable Pay</option>
                <option value="One Time Payment">One Time Payment</option>
                <option value="Overtime Payout">Overtime Payout</option>
            </datalist>
          </div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Default Amount</label><input type="number" id="tmpl-amount"></div>
          <div class="form-group"><label>Currency</label><input type="text" id="tmpl-curr" value="EGP"></div>
      </div>
      <button class="btn-primary" onclick="saveEntitlementTemplate()">Save Template</button>
  </div>

  <hr class="section-divider">

  <h3>Apply Template to Employees</h3>
  <div class="form-container">
      <div class="form-group">
          <label>Select Template</label>
          <select id="fin-apply-tmpl-select"><option>-- Load Templates First --</option></select>
      </div>
      <div class="form-group">
          <label>Select Users</label>
          <div id="fin-apply-users-container"></div> </div>
      <button class="btn-primary" onclick="applyTemplateToUsers()">Apply to Selected</button>
  </div>
</div>

        <!-- ================================== -->
        <!--  TAB 16: Finance ADMIN PANEL -->
        <!-- ================================== -->

<div id="hr-admin-panel" class="tab-panel">
  <h2>HR Administration</h2>

  <div class="info-card" style="text-align: left; background-color: var(--status-info-bg); border-color: var(--status-info-text);">
    <h3 style="margin-top: 0; font-size: 1rem; color: var(--status-info-text);">Pending Data Change Requests</h3>
    <div id="hr-data-requests-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
      <p class="text-color-secondary">Loading requests...</p>
    </div>
  </div>

  <hr class="section-divider">

  <div class="form-container">
    <h3>Employee PII Editor</h3>
    <div class="form-group" style="display: flex; gap: 10px;">
      <input type="text" id="hr-pii-search" placeholder="Search by Name or Email..." style="flex: 1;">
      <button class="btn-primary" onclick="searchEmployeePII()">Search</button>
    </div>
    <div id="hr-pii-search-status" class="status-message"></div>

    <div id="hr-pii-form-container" style="display: none; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
      <input type="hidden" id="hr-pii-empid">
      <h4 id="hr-pii-header" style="color: var(--konecta-blue);"></h4>
      
      <div class="form-row">
        <div class="form-group"><label>National ID</label><input type="text" id="hr-pii-natid"></div>
        <div class="form-group"><label>Passport No.</label><input type="text" id="hr-pii-passport"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Social Insurance</label><input type="text" id="hr-pii-social"></div>
        <div class="form-group"><label>IBAN</label><input type="text" id="hr-pii-iban"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Personal Email</label><input type="email" id="hr-pii-pemail"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="hr-pii-phone"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Address</label><input type="text" id="hr-pii-address"></div>
        <div class="form-group"><label>Marital Status</label>
          <select id="hr-pii-marital">
            <option value="Single">Single</option>
            <option value="Married">Married</option>
            <option value="Divorced">Divorced</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Basic Salary</label><input type="number" id="hr-pii-basic"></div>
        <div class="form-group"><label>Variable Pay</label><input type="number" id="hr-pii-variable"></div>
      </div>

      <button class="btn-primary" onclick="saveEmployeePII()">Save Changes</button>
    </div>
  </div>

  <hr class="section-divider">

  <div class="form-container">
    <h3>Leave Balance Adjustment</h3>
    <div class="form-group">
      <label>Select User</label>
      <div id="hr-balance-user-select-container"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Type</label><select id="hr-balance-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
      <div class="form-group"><label>Amount (+/-)</label><input type="number" id="hr-balance-amount" step="0.5"></div>
    </div>
    <div class="form-group"><label>Reason</label><input type="text" id="hr-balance-reason"></div>
    <button class="btn-primary" style="background-color: var(--konecta-yellow); color: #000;" onclick="submitHrBalanceAdjustment()">Adjust Balance</button>
    <div id="hr-balance-status" class="status-message"></div>
  </div>

  <br>
  

</div>

        <!-- ================================== -->
        <!--  TAB 17: Overtime PANEL -->
        <!-- ================================== -->


<div id="overtime-panel" class="tab-panel">
  <h2>Overtime & Day Off Management</h2>
  
  <div class="form-container">
    <div style="display:flex; justify-content:space-between;">
        <h3>Request / Assign Hours</h3>
        <div id="ot-assign-toggle" style="display:none;">
            <label><input type="checkbox" id="ot-is-assignment" onchange="toggleOtAssignment()"> Assign to Agent</label>
        </div>
    </div>

    <div id="ot-employee-select-wrapper" style="display:none; margin-bottom:15px; padding:10px; background:#f3f4f6; border-radius:6px;">
        
        <div id="ot-employee-select-container"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>Date</label><input type="date" id="ot-req-date"></div>
      <div class="form-group">
        <label>Type</label>
        <select id="ot-req-type">
          <option value="Post-Shift">Post-Shift (Stay Late)</option>
          <option value="Pre-Shift">Pre-Shift (Come Early)</option>
          <option value="Work Day Off">Work Day Off (Cancel Off)</option>
        </select>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group"><label>Start</label><input type="time" id="ot-req-start"></div>
      <div class="form-group"><label>End</label><input type="time" id="ot-req-end"></div>
    </div>

    <div class="form-group"><label>Reason</label><input type="text" id="ot-req-reason" placeholder="Reason..."></div>
    <button class="btn-primary" onclick="submitOtRequest()">Submit</button>
    <div id="ot-status" class="status-message"></div>
  </div>

  <hr class="section-divider">

  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px;">
    <h3 style="margin: 0;">Request History</h3>
    <div class="form-group" style="margin: 0; min-width: 180px;">
        <label for="ot-filter-status" style="font-size: 0.8rem; margin-bottom: 4px;">Filter Status</label>
        <select id="ot-filter-status" onchange="loadOvertimeRequests()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); width: 100%;">
            <option value="Pending">‚ö° Pending Actions</option>
            <option value="Approved">‚úÖ Approved</option>
            <option value="Denied">‚ùå Denied</option>
            <option value="All">üìÇ All History</option>
        </select>
    </div>
  </div>
  <div id="ot-request-list" class="request-list">Loading...</div> </div>

        <!-- ================================== -->
        <!--  TAB 18: offboarding PANEL -->
        <!-- ================================== -->

  <div id="offboarding-panel" class="tab-panel">
  <h2>Offboarding & Exits</h2>
  
  <div id="offboard-initiate-section" class="form-container" style="margin-bottom:20px; border-color: #dc2626;">
      <h3 style="color:#dc2626; margin-top:0;">‚ö† Initiate Termination</h3>
      <p class="text-color-secondary">Submit a request to terminate an employee. Requires HR Approval.</p>
      <div class="form-row">
          <div class="form-group">
              <label>Select Employee</label>
              <div id="offboard-term-user-container"></div>
          </div>
          <div class="form-group"><label>Exit Date</label><input type="date" id="term-date"></div>
      </div>
      <div class="form-group"><label>Reason</label><textarea id="term-reason" rows="2"></textarea></div>
      <button class="btn-danger" onclick="submitTermination()">Submit Termination</button>
  </div>

  <hr class="section-divider">

  <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>Request Queue</h3>
      <button class="btn-secondary" onclick="loadOffboardingRequests()">Refresh</button>
  </div>
  <div id="offboarding-list" class="request-list">Loading...</div>
</div>



        <!-- ================================== -->
        <!--  TAB 18: Analytics PANEL -->
        <!-- ================================== -->


<div id="analytics-panel" class="tab-panel">
  <h2>Enterprise Reports & Analytics</h2>
  
  <div class="form-container" style="display:flex; gap:15px; flex-wrap:wrap; align-items:flex-end; background:var(--input-bg);">
      <div class="form-group" style="flex:1; min-width:200px;">
          <label>Select User</label>
          <div id="analytics-user-select-container"></div>
      </div>

      <div class="form-group">
          <label>From</label>
          <input type="date" id="an-start-date">
      </div>
      <div class="form-group">
          <label>To</label>
          <input type="date" id="an-end-date">
      </div>

      <div class="form-group" style="display: flex; gap: 10px;">
        <button type="button" class="btn-primary" onclick="loadAnalyticsData()">Generate Report</button>
        <button type="button" class="export-btn" onclick="downloadPayrollReport()">üì• Export CSV</button>
      </div>
  </div>

  <div id="analytics-status" class="status-message"></div>

  <hr class="section-divider">

  <div id="command-center-stats" style="margin-bottom:30px;">
      <div class="metric-card">
          <span class="metric-title">Adherence</span>
          <span class="metric-value" id="an-stat-adherence">--%</span>
      </div>
      <div class="metric-card">
          <span class="metric-title">Shrinkage</span>
          <span class="metric-value" id="an-stat-shrinkage">--%</span>
      </div>
      <div class="metric-card">
          <span class="metric-title">Total Lateness</span>
          <span class="metric-value" id="an-stat-lateness">0m</span>
      </div>
      <div class="metric-card">
          <span class="metric-title">Worked Hours</span>
          <span class="metric-value" id="an-stat-worked">0h</span>
      </div>
  </div>

  <h3 style="margin-bottom:15px;">Activity Timeline (Heatmap)</h3>
  <div id="analytics-heatmap-container" class="request-list" style="min-height:200px;">
      <p class="text-color-secondary">Select criteria and click "Generate Report" to view timeline.</p>
  </div>
</div>
        
      </main> <!-- End #app-content -->
      
    </div> <!-- End .app-container -->

    <!-- MODIFIED: Footer is now positioned by CSS/Flexbox -->
    <footer>
      <p>KOMPASS (Konecta Operations, Management & Personnel Self-Service) - Created by Fady Bekhet</p>
    </footer>



    <script>

      
      (function() {
      // Robust Mobile Detection Function
      function isMobileDevice() {
        // 1. Check User Agent strings (standard detection)
        var ua = navigator.userAgent || navigator.vendor || window.opera;
        var mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
        if (mobileRegex.test(ua)) return true;

        // 2. Check Physical Screen Dimensions 
        // "Desktop Site" mode fakes window.innerWidth, but rarely fakes window.screen.width.
        // Most phones have a physical width < 600px (CSS pixels). Tablets < 900px.
        // We set a cutoff. 1024px is a safe bet for "Desktops/Laptops".
        if (window.screen.width < 900 || window.screen.height < 600) {
          return true;
        }

        // 3. Touch Point Heuristic (Optional but powerful)
        // If it has touch points AND screen width is somewhat small (e.g. tablet in landscape)
        // This catches iPads in Desktop Mode.
        if (navigator.maxTouchPoints > 0 && window.screen.width < 1024) {
          return true;
        }

        return false;
      }

      // Apply block immediately if detected
      if (isMobileDevice()) {
        document.body.classList.add('force-mobile-block');
      }
    })();


      // --- MODIFIED PHASE 3: Changed const to let for dynamic updates ---
      let PLANNED_BREAK_SECONDS = 15 * 60; 
      let PLANNED_LUNCH_SECONDS = 30 * 60;
      let OT_PRE_THRESHOLD = 300; // Default 5 mins
      let OT_POST_THRESHOLD = 300; // Default 5 mins
      let selfUserName = "";
      let selfRole = "agent"; 
      let allUsersList = []; 
      let allAdminsList = []; 
      let lastHistoryData = null;
      let chartsLoaded = false; 
      
      // NEW: Global state for the custom multiselects (History only)
      let selectedHistoryUsers = {};
      let historyUserList = [];
      
      // NEW: Global state for Dashboard Hierarchy
      let managerHierarchy = null; // Stores the full tree structure
      let currentDashboardSelection = { 
        emails: [], // The list of emails to query (flattened)
        name: "None", // Name to display on the button/title
        isFullHierarchy: false // Whether this selection includes nested reports
      };
      
      // --- NEW/MODIFIED: Dark Mode Functions (Removed direct icon manipulation) ---
      const DARK_MODE_KEY = 'kap_dark_mode';
      
      // New core function called by the checkbox event listener
      function toggleThemeState() {
          // Read the current state of the checkbox
          const toggleInput = document.getElementById('dark-mode-toggle');
          // Checkbox is already toggled when this event fires
          const newThemeIsDark = toggleInput.checked; 
          
          applyTheme(newThemeIsDark);
          localStorage.setItem(DARK_MODE_KEY, newThemeIsDark ? 'enabled' : 'disabled');
      }

      function applyTheme(isDark) {
        const body = document.body;
        const toggleInput = document.getElementById('dark-mode-toggle');
        
        if (isDark) {
          body.classList.add('dark-mode');
          body.setAttribute('data-theme', 'dark');
          if (toggleInput) toggleInput.checked = true; // Set checkbox state
          
          // Invert the refresh icon
          document.querySelectorAll('#header-refresh-button img, #header-role-request-button img').forEach(img => {
               img.style.filter = 'invert(100%)';
          });
          
        } else {
          body.classList.remove('dark-mode');
          body.setAttribute('data-theme', 'light');
          if (toggleInput) toggleInput.checked = false; // Set checkbox state

          // Reset the refresh icon filter
          document.querySelectorAll('#header-refresh-button img, #header-role-request-button img').forEach(img => {
               img.style.filter = 'none';
          });
        }
        
        // Re-draw charts when theme changes to apply new colors
        // Note: The original code expected Google Charts, but since they were removed
        // we keep the redraw logic here for completeness, though it's mainly for aesthetics now.
        if (window.lastDashboardData) {
            drawDashboard(window.lastDashboardData);
        }
      }

      function initializeTheme() {
        const savedTheme = localStorage.getItem(DARK_MODE_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        let initialTheme = prefersDark;

        if (savedTheme === 'enabled') {
            initialTheme = true;
        } else if (savedTheme === 'disabled') {
            initialTheme = false;
        }
        
        // Use a slight delay to ensure the DOM element for the toggle is ready
        setTimeout(() => {
            applyTheme(initialTheme);
            
            const toggleInput = document.getElementById('dark-mode-toggle');
            if (toggleInput) {
                // Attach listener only after the DOM is fully loaded and theme is set
                toggleInput.addEventListener('change', toggleThemeState);
            }
        }, 0); 
      }
      
      // --- Status Message Utility ---
      function setStatus(id, type, message) {
        const statusDiv = document.getElementById(id);
        
        // Hide all statuses first (removes visible class)
        document.querySelectorAll('.status-message').forEach(div => {
            div.classList.remove('visible', 'success', 'error', 'processing');
        });
        
        if (message) {
            statusDiv.classList.add('visible', type);
            statusDiv.innerText = message;
        } else {
            statusDiv.classList.remove('visible', 'success', 'error', 'processing');
        }
      }
      // *** NEW HELPER FUNCTION to add in <script> tag ***
      function setAllPunchButtonsDisabled(disabled) {
        document.querySelectorAll('#buttons button, #other-buttons button').forEach(btn => {
          btn.disabled = disabled;
        });
      }
      // === TAB SWITCHING FUNCTION ===
function showTab(tabName) {
  // 1. Hide all panels
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.style.display = 'none';
  });

  // 2. Deactivate all tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });

  // 3. Clear all status messages
  document.querySelectorAll('.status-message').forEach(div => {
    div.classList.remove('visible', 'success', 'error', 'processing');
  });

  // 4. Show the correct panel and activate the correct button
  const panel = document.getElementById(tabName + '-panel');
  const button = document.getElementById(tabName + '-tab-button');
  
  if (panel) panel.style.display = 'block';
  if (button) button.classList.add('active');

  // --- LAZY LOAD DROPDOWNS & DATA ---
  if (allUsersList && allUsersList.length > 0) {
    
    if (tabName === 'admin-tools') {
      // A. Populate Dropdowns
      populateAdminDropdown(allUsersList, selfUserName, 'manual-punch-user', 'Select User');
      populateAdminDropdown(allUsersList, selfUserName, 'balance-user-select', 'Select User');
      populateAdminDropdown(allUsersList, selfUserName, 'admin-leave-user', 'Select User');
      populateAdminDropdown(allUsersList, selfUserName, 'offboard-user-select', 'Select Employee');

      // B. INNER SECURITY CHECK (The Fix)
      // Check the attribute we set in populateUserInfo
      const canManageBalances = document.body.getAttribute('data-perm-balances') === 'true'; 

      if (canManageBalances) {
          document.getElementById('break-config-section').style.display = 'block';
          document.getElementById('balance-adjustment-section').style.display = 'block';
          // Also show the admin leave form if they have balance permissions (usually Admins)
          document.getElementById('admin-leave-form').style.display = 'block';
      } else {
          document.getElementById('break-config-section').style.display = 'none';
          document.getElementById('balance-adjustment-section').style.display = 'none';
          // Hide admin leave form for Managers (they should use Approvals tab, not submit on behalf)
          document.getElementById('admin-leave-form').style.display = 'none';
      }
      
      // Load data only if visible
      if(canManageBalances) loadBreakConfig();
    
    } else if (tabName === 'reporting-line') {
      populateAdminDropdown(allUsersList, selfUserName, 'reporting-line-user', 'Select User to Move');
      populateAdminDropdown(allUsersList, selfUserName, 'reporting-line-supervisor', 'Select New Supervisor');
      populateAdminDropdown(allUsersList, selfUserName, 'movement-history-user', 'Select User');
      loadPendingMovements();
      document.getElementById('movement-history-list').innerHTML = '<p class="text-color-secondary">Select a user to view their movement history.</p>';
    
    } else if (tabName === 'leave-approval') {
      populateAdminDropdown(allUsersList, selfUserName, 'leave-report-user', 'Filter by User (Optional)');
      loadLeaveReport();
    
    } else if (tabName === 'history-report') {
      populateAdminDropdown(allUsersList, selfUserName, 'history', 'Select Users');
      const histContainer = document.getElementById('history-user-select-container');
      if(histContainer) histContainer.style.display = 'block';
    
    } else if (tabName === 'performance') {
      loadPerformanceTab();
    
    } else if (tabName === 'hr-admin') {
      loadHrAdmin();
      
    } else if (tabName === 'overtime') {
      loadOvertimeTab();
      
    } else if (tabName === 'finance-admin') {
      populateAdminDropdown(allUsersList, selfUserName, 'finance-apply', 'Select Target Users');
      loadEntitlementTemplates();
    
    } else if (tabName === 'analytics') {
      loadAnalyticsTab();
    }
  }

  // --- REFRESH DATA FOR SPECIFIC TABS ---
  if (tabName === 'leave-request') {
    loadMyRequests();
    google.script.run.withSuccessHandler(user => {
      if (user && user.myBalances) populateMyBalances(user.myBalances);
    }).getUserInfo();
  } else if (tabName === 'my-schedule') {
    loadMySchedule();
  } else if (tabName === 'dashboard') {
    loadManagerHierarchy();
    if (window.lastDashboardData) drawDashboard(window.lastDashboardData);
  } else if (tabName === 'coaching') {
    loadMyCoaching();
  } else if (tabName === 'profile') {
    loadMyProfile();
  } else if (tabName === 'registration-admin') {
    loadRegistrationAdmin();
  } else if (tabName === 'announcements-admin') {
    loadAnnouncements_Admin();
  } else if (tabName === 'recruitment') {
    loadRecruitmentAdmin();
  } else if (tabName === 'offboarding') {
    loadOffboardingTab();
  }
}    
      // --- Refresh User Info ---
      function refreshCurrentData() {
        const btn = document.getElementById('header-refresh-button');
        btn.classList.add('loading');
        
        const activeTab = document.querySelector('.tab-button.active');
        const activeTabName = activeTab ? activeTab.id.replace('-tab-button', '') : 'punch';
        
        google.script.run
          .withSuccessHandler(user => {
            populateUserInfo(user); 
            
            // Now, reload the data for the specific tab
            if (activeTabName === 'leave-approval') {
              const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
              loadPendingRequests(currentFilter);
            } else if (activeTabName === 'leave-request') {
              loadMyRequests();
            } else if (activeTabName === 'my-schedule') {
              loadMySchedule();
            } else if (activeTabName === 'dashboard') {
              loadManagerHierarchy();
              loadDashboard();
            } else if (activeTabName === 'history-report' && lastHistoryData) {
              loadHistoryReport(); 
            } else if (activeTabName === 'coaching') {
              loadMyCoaching(); // <-- Use the new function name
            }
            
            setTimeout(() => {
              btn.classList.remove('loading');
            }, 500); 
          })
          .withFailureHandler(err => {
            btn.classList.remove('loading');
            const infoDiv = document.getElementById('agent-info');
            infoDiv.innerHTML = "Error refreshing data. Please try again.";
            infoDiv.classList.add('error');
          })
          .getUserInfo();
      }

function populateUserInfo(user) {
  // --- 1. DEFINE HELPER FUNCTIONS FIRST (Critical Fix) ---
  const can = (perm) => user.permissions && user.permissions.includes(perm);

  const setDisplay = (id, condition) => {
      const el = document.getElementById(id);
      if(el) el.style.display = condition ? 'inline-block' : 'none';
  };

  // --- 2. VALIDATE USER ---
  const infoDiv = document.getElementById('agent-info');
  if (!user || !user.name) {
    infoDiv.innerHTML = "Your email is not registered.";
    infoDiv.className = 'error'; 
    return;
  }

  // --- 3. LOAD CONFIGURATION ---
  if (user.breakRules) {
    PLANNED_BREAK_SECONDS = user.breakRules.break1; 
    PLANNED_LUNCH_SECONDS = user.breakRules.lunch;
    OT_PRE_THRESHOLD = user.breakRules.otPre;
    OT_POST_THRESHOLD = user.breakRules.otPost;
    console.log(`Rules Loaded: Break=${PLANNED_BREAK_SECONDS}s, Lunch=${PLANNED_LUNCH_SECONDS}s`);
  }

  selfUserName = user.name; 
  selfRole = user.role; 
  allUsersList = user.allUsers; 
  allAdminsList = user.allAdmins; 
  
  // Set Attributes (Now safe because 'can' is defined above)
  document.body.setAttribute('data-role', user.role);
  document.body.setAttribute('data-perm-balances', can('MANAGE_BALANCES'));
  document.body.setAttribute('data-perm-hr', can('MANAGE_HR_DATA'));
  
  // --- 4. HANDLE PENDING USERS ---
  if (user.accountStatus === 'Pending') {
    infoDiv.innerHTML = `<strong>Status:</strong> Pending Approval`;
    document.getElementById('app-sidebar').style.display = 'none';
    document.getElementById('punch-panel').innerHTML = `<h2>Pending</h2><p>Please wait for approval.</p>`;
    if (user.isNewUser) showSupervisorModal(allAdminsList);
    else loadMyRegistrationStatus();
    return;
  }

  // --- 5. UPDATE UI FOR ACTIVE USERS ---
  infoDiv.innerHTML = `<strong>User:</strong> ${user.name} | <strong>Role:</strong> ${user.role}`;
  infoDiv.className = '';
  
  document.getElementById('buttons').style.display = 'block';
  document.getElementById('other-buttons').style.display = 'block';

  // --- 6. TAB VISIBILITY LOGIC ---
  // General Agent Tabs
  setDisplay('my-schedule-tab-button', true);
  setDisplay('history-report-tab-button', true);
  setDisplay('coaching-tab-button', true);
  setDisplay('overtime-tab-button', true); 
  
  // Management Tabs
  setDisplay('dashboard-tab-button',      can('VIEW_FULL_DASHBOARD'));
  setDisplay('leave-approval-tab-button', can('APPROVE_LEAVE'));
  setDisplay('reporting-line-tab-button', can('MANAGE_HIERARCHY'));

  // Admin & HR Tabs
  setDisplay('finance-admin-tab-button',       can('MANAGE_FINANCE'));
  setDisplay('analytics-tab-button',           can('VIEW_ANALYTICS'));
  setDisplay('schedule-tab-button',            can('EDIT_SCHEDULE'));
  setDisplay('project-admin-tab-button',       can('MANAGE_PROJECTS'));
  
  // Admin Tools (Visible if user has any sub-permission)
  setDisplay('admin-tools-tab-button',         can('ACCESS_ADMIN_TOOLS') || can('PUNCH_OTHERS') || can('MANAGE_BALANCES'));

  setDisplay('coaching-admin-tab-button',      can('MANAGE_TEMPLATES'));
  setDisplay('registration-admin-tab-button',  can('HIRE_EMPLOYEE'));
  setDisplay('announcements-admin-tab-button', can('MANAGE_ANNOUNCEMENTS'));
  setDisplay('recruitment-tab-button',         can('MANAGE_RECRUITMENT'));
  setDisplay('hr-admin-tab-button',            can('MANAGE_HR_DATA'));

  // --- 7. INTERNAL PANEL LOGIC ---
  if (can('PUNCH_OTHERS')) {
      document.getElementById('admin-panel').style.display = 'block';
      populateAdminDropdown(allUsersList, selfUserName, 'agent-select', 'Select User', user.email);
  } else {
      document.getElementById('admin-panel').style.display = 'none';
  }
  
  if (can('EDIT_SCHEDULE')) {
      populateAdminDropdown(allUsersList, selfUserName, 'schedule-agent-select', 'Select a user');
  }

  if (user.myBalances) populateMyBalances(user.myBalances);
  if (user.currentStatus) updateCurrentStatus(user.currentStatus);
  loadMyRequests();
}

      function loadUserInfo() { 
        // 1. Check saved theme
        initializeTheme();
        
        // 2. Set timeout for failure
        const loadTimeout = setTimeout(() => {
          
          const infoDiv = document.getElementById('agent-info');
          infoDiv.innerHTML = "The request timed out. Please refresh and re-authorize the script if asked.";
          infoDiv.classList.add('error', 'visible');
          infoDiv.style.textAlign = 'center';
          document.getElementById('app-loader').style.display = 'none';
        }, 15000);

        // 3. Run script
        google.script.run
          .withSuccessHandler(user => { 
            clearTimeout(loadTimeout); 
            populateUserInfo(user);
            loadAnnouncements(); // Load banner for all users on page load
            document.getElementById('app-loader').style.display = 'none';
          })
          .withFailureHandler(err => {
            clearTimeout(loadTimeout); 
            const infoDiv = document.getElementById('agent-info');
            let errorMsg = err.message || JSON.stringify(err);
            infoDiv.innerHTML = "Could not load user info. Error: " + errorMsg; 
            infoDiv.classList.add('error', 'visible');
            document.getElementById('app-loader').style.display = 'none';
        }).getUserInfo(); 
      }
      
      // NEW: Function to handle populating custom multi-selects (History)
      function populateAdminCustomSelect(users, selfName, type) { 
          // Only used for history now
          if (type !== 'history') return;
          
          const selectedState = selectedHistoryUsers;
          const dropdownDiv = document.getElementById(`custom-${type}-select-dropdown`);
          
          if (!dropdownDiv) return;

          // Set the global user list state for lookups
          historyUserList = users;
          
          // Reset DOM
          dropdownDiv.innerHTML = ''; 
          
          // Add the "Select All" option
          let allOption = document.createElement('div');
          allOption.className = 'dropdown-item';
          allOption.innerHTML = `<input type="checkbox" id="select-all-checkbox-${type}" onclick="toggleSelectAll('${type}')"> <label for="select-all-checkbox-${type}" style="flex: 1; cursor: pointer;">Select All</label>`;
          allOption.onclick = (e) => e.stopPropagation(); 
          dropdownDiv.appendChild(allOption);
          
          // Add individual user options
          users.forEach(user => { 
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.setAttribute('data-email', user.email);
            item.innerHTML = `
              <input type="checkbox" id="user-checkbox-${type}-${user.email}" data-email="${user.email}">
              <label for="user-checkbox-${type}-${user.email}" style="flex: 1; cursor: pointer;">${user.name} (${user.email})</label>
            `;
            // Pass the item and email to the selection handler
            item.onclick = (e) => selectUserItem(type, e, item, user.email, user.name);
            dropdownDiv.appendChild(item);
          });
          
          // Ensure button display reflects initial (empty) state
          updateSelectButtonDisplay(type);
      }
      
      
// Updated populateAdminDropdown to accept a default value
function populateAdminDropdown(users, selfName, dropdownId, selfText, defaultVal = null) {
  // Map Dropdown IDs to their Container IDs
  const map = {
    'agent-select': 'agent-select-container',
    'schedule-agent-select': 'schedule-agent-select-container',
    'manual-punch-user': 'manual-punch-user-container',
    'admin-leave-user': 'admin-leave-user-container',
    'balance-user-select': 'balance-user-select-container',
    'reporting-line-user': 'reporting-line-user-container',
    'reporting-line-supervisor': 'reporting-line-supervisor-container',
    'movement-history-user': 'movement-history-user-container',
    'coaching-agent-select': 'coaching-agent-select-container',
    'leave-report-user': 'leave-report-user-container',
    'perf-employee-select': 'perf-employee-select-container',
    'offboard-user-select': 'offboard-user-select-container',
    'hr-balance-user-select': 'hr-balance-user-select-container',
    'hr-offboard-user-select': 'hr-offboard-user-select-container',
    'ot-employee-select': 'ot-employee-select-container', // 
    'offboard-term-user': 'offboard-term-user-container', // 
    'reporting-line-pm': 'reporting-line-pm-container',
    'finance-apply': 'fin-apply-users-container',
    'analytics-user': 'analytics-user-select-container'
  };

  if (dropdownId === 'analytics-user') {
      renderGlobalUserSelector('analytics-user-select-container', users, 'Select Users', true, (vals) => {
          // Store selected array as JSON string in the dataset
          const container = document.getElementById('analytics-user-select-container');
          if(container) container.dataset.value = JSON.stringify(vals);
      }, defaultVal); // Pass defaultVal (which we will set to all emails)
      return;
  }

  // Special Handling for History (Multi-Select)
  if (dropdownId === 'history') {
      renderGlobalUserSelector('history-user-select-wrapper', users, 'Select Users', true, (vals) => {
          document.getElementById('history-user-select-wrapper').dataset.value = JSON.stringify(vals);
      });
      return;
  }

  const containerId = map[dropdownId];
  if (!containerId) return; 

  let userList = [...users];
  
  // Pass defaultVal to the renderer
  renderGlobalUserSelector(containerId, userList, selfText, false, (vals) => {
      const val = vals[0] || '';
      
      // Create or update hidden input
      let hidden = document.getElementById(dropdownId);
      if (!hidden) {
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.id = dropdownId;
          document.getElementById(containerId).appendChild(hidden);
      }
      hidden.value = val;
      // NEW: Trigger change event manually for logic hooks
      if (dropdownId === 'reporting-line-user') {
          onReportingLineUserChange();
      }
  }, defaultVal);
}
      
      function populateSupervisorDropdown(admins, dropdownId = 'leave-supervisor') {
        const select = document.getElementById(dropdownId);
        select.innerHTML = '<option value="">-- Select a supervisor --</option>'; 
        
        admins.forEach(admin => {
          const option = document.createElement('option');
          option.value = admin.email; 
          option.textContent = `${admin.name}`; 
          select.appendChild(option);
        });
      }
      
      function populateMyBalances(balances) {
        if (!balances) return;
        document.getElementById('balance-annual').textContent = balances.annual;
        document.getElementById('balance-sick').textContent = balances.sick;
        document.getElementById('balance-casual').textContent = balances.casual;
      }

function punch(action) {
  const adminSelect = document.getElementById('agent-select');
  let targetUserName = '';
  
  if (selfRole === 'admin' || selfRole === 'superadmin') {
    const selectedEmail = adminSelect.value;
    
    // --- FIX START ---
    // If a specific email is selected, find that user.
    if (selectedEmail && selectedEmail !== "") {
        const user = allUsersList.find(u => u.email === selectedEmail);
        targetUserName = user ? user.name : '';
    } else {
        // If "Punch for: Myself" is showing (value is empty), use the admin's own name.
        targetUserName = selfUserName;
    }
    // --- FIX END ---

  } else {
    targetUserName = selfUserName;
  }
  
  if (!targetUserName) { 
     setStatus('status', 'error', 'Could not identify the user to punch for.');
     return;
  }

  // Project Logic (Keep existing Phase 3 logic)
  const projectSelect = document.getElementById('current-project-select');
  const projectId = projectSelect.value;

  if ((action === 'Login' || action === 'Switch Project') && !projectId) {
    setStatus('status', 'error', 'Please select a Project before punching.');
    return;
  }

  setStatus('status', 'processing', `Processing "${action}" for ${targetUserName}...`);

  google.script.run
    .withSuccessHandler(response => {
      if (response.message.startsWith('Error:')) {
        setStatus('status', 'error', response.message.replace('Error: ', ''));
      } else {
        setStatus('status', 'success', response.message);
      }
      updateCurrentStatus(response.newStatus); 
    })
    .withFailureHandler(err => {
      setStatus('status', 'error', 'Unexpected error: ' + err.message);
    })
    .webPunch(action, targetUserName, null, projectId); 
}
      
      // REPLACE this function in your <script> tag
function toggleTimeFields() {
  const leaveType = document.getElementById('schedule-leave-type').value;
  const timeFields = document.getElementById('time-fields');
  if (leaveType === 'Present') {
    timeFields.style.display = 'flex';
  } else {
    timeFields.style.display = 'none';
    // *** NEW: Clear the shift end date field when hiding ***
    document.getElementById('schedule-end-date-shift').value = '';
    document.getElementById('schedule-start-time').value = '';
    document.getElementById('schedule-end-time').value = '';
  }
}
      
     // REPLACE this function in your <script> tag
function submitSchedule() {
  try {
    const userEmail = document.getElementById('schedule-agent-select').value;
    const user = allUsersList.find(u => u.email === userEmail);
    if (!user) throw new Error("Please select a user."); 
    
    let startDate = document.getElementById('schedule-start-date').value;
    let endDateRange = document.getElementById('schedule-end-date').value; // This is the date *range*
    const leaveType = document.getElementById('schedule-leave-type').value;
    let startTime = document.getElementById('schedule-start-time').value;
    let endTime = document.getElementById('schedule-end-time').value;
    
    // *** NEW: Read the SHIFT end date ***
    let shiftEndDate = document.getElementById('schedule-end-date-shift').value;
    
    if (!startDate) throw new Error("Please select a Start Date.");
    if (!endDateRange) endDateRange = startDate; // Default range to single day
    if (new Date(endDateRange) < new Date(startDate)) throw new Error("End Date of range cannot be before Start Date.");
    
    if (leaveType === 'Present') {
      if (!startTime || !endTime) throw new Error("Shift Start and End Time are required for 'Present' status.");
      // If shiftEndDate is blank, it will be handled by the server
    } else {
      startTime = "";
      endTime = "";
      shiftEndDate = ""; // Clear shift end date if not present
    }
    
    setStatus('schedule-status', 'processing', `Submitting schedule for ${user.name}...`);

    google.script.run
      .withSuccessHandler(msg => {
        if (msg.startsWith('Error:')) {
          setStatus('schedule-status', 'error', msg.replace('Error: ', ''));
        } else {
          setStatus('schedule-status', 'success', msg);
          document.getElementById('schedule-form').reset();
          document.getElementById('schedule-start-date').valueAsDate = new Date();
          toggleTimeFields();
        }
      })
      .withFailureHandler(err => {
        setStatus('schedule-status', 'error', 'Unexpected error: ' + (err.message || JSON.stringify(err)));
      })
      // *** MODIFIED: Pass shiftEndDate to the new function signature ***
      .webSubmitScheduleRange(userEmail, user.name, startDate, endDateRange, startTime, endTime, leaveType, shiftEndDate); 

  } catch (err) {
    setStatus('schedule-status', 'error', err.message);
  }
}
      
      // --- Helper to format date strings ---
      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString("en-US", { 
          year: 'numeric', month: '2-digit', day: '2-digit' 
        });
      }
      
      // --- Helper to format time strings ---
      function formatTime(dateStr) {
        if (!dateStr) return '--:--';
        // Check if dateStr is a full date string or just a time part
        if (dateStr.includes('T') || dateStr.includes('-')) {
             return new Date(dateStr).toLocaleTimeString("en-US", { 
              hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });
        }
        // If it's just a time string like "09:00:00", we can't reliably format it without assuming a date.
        return dateStr;
      }
      
      // --- Helper to format seconds ---
      function formatSeconds(seconds) {
        if (typeof seconds !== 'number' || isNaN(seconds)) return '0 sec';
        if (seconds === 0) return '0 sec';
        const isNegative = seconds < 0;
        seconds = Math.abs(seconds);
        
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        
        let str = isNegative ? '-' : '';
        if (h > 0) str += `${h}h `;
        if (m > 0) str += `${m}m `;
        if (s > 0 || (h === 0 && m === 0)) str += `${s}s`;
        
        return str.trim();
      }

// ================= PHASE 2: REAL-TIME TIMERS (DUAL CLOCK) =================
let statusTimer = null;

function updateCurrentStatus(statusInfo) {
  if (statusTimer) clearInterval(statusTimer);

  const statusDiv = document.getElementById('current-status-display');
  const timersGrid = document.getElementById('timers-grid');
  
  // Shift Timer Elements
  const shiftTimerValue = document.getElementById('shift-timer-value');
  const shiftStartDisplay = document.getElementById('shift-start-time');
  
  // Status/AUX Timer Elements
  const statusTimerValue = document.getElementById('status-timer-value');
  const statusLabel = document.getElementById('status-timer-label');
  const statusNameDisplay = document.getElementById('status-current-name');
  const statusIconBg = document.getElementById('status-icon-bg');

  // Enable buttons
  setAllPunchButtonsDisabled(false); 

  // --- MODIFICATION: ALWAYS SHOW GRID ---
  timersGrid.style.display = 'grid'; 

  // Handle Empty/Initial State safely
  if (!statusInfo) {
      shiftTimerValue.innerText = "00:00:00";
      statusTimerValue.innerText = "00:00:00";
      statusNameDisplay.innerText = "Loading...";
      return;
  }

  // --- 1. SETUP TIMESTAMPS ---
  // Safely parse dates (handle nulls from server)
  const lastActionTime = statusInfo.time ? new Date(statusInfo.time) : null;
  const loginTime = statusInfo.loginTime ? new Date(statusInfo.loginTime) : null;
  
  let currentStatusName = statusInfo.status || "Logged Out";
  statusNameDisplay.innerText = currentStatusName;

  // Handle "Logged Out" visuals specifically
  if (currentStatusName === 'Logged Out') {
    statusDiv.style.visibility = 'hidden';
    statusDiv.className = 'status-message';
    document.title = "KOMPASS";
    
    // Reset Values for visual clarity
    shiftTimerValue.innerText = "00:00:00";
    shiftStartDisplay.innerText = "--:--";
    statusTimerValue.innerText = "00:00:00";
    
    statusLabel.innerText = "Status";
    statusIconBg.style.background = "#9ca3af"; // Grey
    statusIconBg.innerHTML = "‚ö´";
    
    // We do NOT return here, so the interval clears and sets 00:00:00 ensures stability
    return;
  }

  // Update Login Time Display
  if (loginTime) {
    shiftStartDisplay.innerText = loginTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  } else {
    shiftStartDisplay.innerText = "--:--";
  }

  // --- 2. UPDATE STATIC LABELS (For Active States) ---
  if (currentStatusName.includes("Break") || currentStatusName.includes("Lunch")) {
      statusLabel.innerText = "Break Duration";
      statusIconBg.style.background = "#f59e0b"; // Orange/Yellow
      statusIconBg.innerHTML = "‚òï";
  } else if (currentStatusName === "Logged In") {
      statusLabel.innerText = "Work Duration";
      statusIconBg.style.background = "#10b981"; // Green
      statusIconBg.innerHTML = "üíº";
  } else {
      statusLabel.innerText = "AUX Duration";
      statusIconBg.style.background = "#3b82f6"; // Blue
      statusIconBg.innerHTML = "‚ö°";
      if (currentStatusName.includes("System Down")) {
         statusIconBg.style.background = "#dc2626"; // Red
         statusIconBg.innerHTML = "üö®";
      }
  }

  // --- 3. START TICKER ---
  const updateTick = () => {
    const now = new Date();
    
    // A. SHIFT TIMER CALCULATION
    if (loginTime) {
      const shiftDiff = Math.floor((now - loginTime) / 1000);
      shiftTimerValue.innerText = formatHHMMSS(shiftDiff);
    } else {
      shiftTimerValue.innerText = "00:00:00";
    }

    // B. STATUS/AUX TIMER CALCULATION
    if (lastActionTime) {
        const statusDiff = Math.floor((now - lastActionTime) / 1000);
        statusTimerValue.innerText = formatHHMMSS(statusDiff);
        
        // C. THRESHOLD ALERTS (Break Exceed)
        let warningMsg = "";
        let maxSeconds = 0;
        
        if (currentStatusName.includes("First Break") || currentStatusName.includes("Last Break")) {
            maxSeconds = PLANNED_BREAK_SECONDS; 
        } else if (currentStatusName.includes("Lunch")) {
            maxSeconds = PLANNED_LUNCH_SECONDS; 
        }

        if (maxSeconds > 0) {
            if (statusDiff > maxSeconds) {
                const exceedSec = statusDiff - maxSeconds;
                warningMsg = `<strong>‚ö†Ô∏è Exceeded by ${formatCompactTime(exceedSec)}</strong>`;
                statusTimerValue.style.color = "#dc2626"; 
                statusDiv.className = `status-message visible status-denied`;
                document.title = `‚ö†Ô∏è ${formatCompactTime(exceedSec)} Over - ${currentStatusName}`;
            } else if (statusDiff > (maxSeconds * 0.85)) {
                const remainSec = maxSeconds - statusDiff;
                warningMsg = `<span style="color: #d97706;">${formatCompactTime(remainSec)} remaining</span>`;
                statusTimerValue.style.color = "#d97706"; 
                statusDiv.className = `status-message visible status-pending`;
            } else {
                const remainSec = maxSeconds - statusDiff;
                warningMsg = `<span style="color: #10b981;">${formatCompactTime(remainSec)} remaining</span>`;
                statusTimerValue.style.color = "var(--text-color)";
                statusDiv.className = `status-message visible status-approved`; 
            }
            statusDiv.innerHTML = warningMsg;
            statusDiv.style.visibility = 'visible';
        } else {
            statusTimerValue.style.color = "var(--text-color)";
            statusDiv.style.visibility = 'hidden';
            document.title = `KOMPASS - ${currentStatusName}`;
        }
    } else {
        statusTimerValue.innerText = "00:00:00";
    }
  };

  updateTick(); // Run immediately
  statusTimer = setInterval(updateTick, 1000);
}

// --- HELPER: HH:MM:SS Formatter ---
function formatHHMMSS(totalSeconds) {
  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = totalSeconds % 60;
  // Pad with zeros
  return [h, m, s].map(v => String(v).padStart(2, '0')).join(':');
}

// --- HELPER: Compact Formatter (12m 30s) ---
function formatCompactTime(totalSeconds) {
  const m = Math.floor(totalSeconds / 60);
  const s = totalSeconds % 60;
  if (m > 0) return `${m}m ${s}s`;
  return `${s}s`;
}
      
      // --- PHASE 6: Enhanced Visuals ---
function getStatusClass(status) {
    if (!status) return 'logged-out';
    const s = status.toLowerCase();
    
    // Green: Working
    if (s === 'logged in' || s === 'present') return 'approved'; 
    
    // Yellow: Breaks
    if (s.includes('break') || s.includes('lunch') || s.includes('meeting') || s.includes('coaching')) return 'pending';
    
    // Red: Issues
    if (s.includes('absent') || s.includes('sick') || s.includes('leave')) return 'denied';
    
    // Gray: Offline
    if (s === 'logged out' || s === 'day off' || s === 'day-off') return 'offline'; // We will add .status-offline CSS below
    
    return 'pending'; // Default fallback
}

// Helper to add icons to status text
function formatStatusWithIcon(status) {
    if (!status) return status;
    const s = status.toLowerCase();
    
    if (s === 'logged in') return 'üü¢ Logged In';
    if (s.includes('first break')) return '‚òï On First Break';
    if (s.includes('last break')) return '‚òï On Last Break';
    if (s.includes('lunch')) return 'üçΩÔ∏è On Lunch';
    if (s.includes('coaching')) return 'üéì Coaching' + status;
    if (s.includes('meeting')) return 'üìÖ Meeting' + status;
    if (s.includes('personal')) return 'üè† ' + status;
    if (s.includes('system down')) return 'üö® ' + status;
    if (s === 'logged out') return '‚ö´ Logged Out';
    
    return status;
}


      function formatColoredSeconds(seconds, isPositive) {
          if (typeof seconds !== 'number' || isNaN(seconds) || seconds === 0) {
              return '0';
          }
          
          // Deviation (Tardy, Early, Exceed) is negative, Overtime is positive
          const actualSeconds = isPositive ? seconds : Math.abs(seconds);
          
          const h = Math.floor(actualSeconds / 3600);
          const m = Math.floor((actualSeconds % 3600) / 60);
          const s = Math.floor(actualSeconds % 60);
          
          let str = '';
          if (h > 0) str += `${h}h `;
          if (m > 0) str += `${m}m `;
          if (s > 0 || (h === 0 && m === 0)) str += `${s}s`;
          
          // Choose color: Red for deviation, Green for positive (Overtime)
          const color = isPositive ? '#34a853' : '#ea4335';
          
          return `<span style="font-weight: 600; color: ${color};">${str.trim()}</span>`;
      }


      function onMyRequestsFailure(error) {
        const listDiv = document.getElementById('my-requests-list');
        listDiv.innerHTML = `<p class="status-message error visible">Error loading requests: ${error.message || JSON.stringify(error)}</p>`;
      }

      function onPendingRequestsFailure(error) {
        // Set the status in the main 'approval-status' div, not in the list
        setStatus('approval-status', 'error', 'Error loading requests: ' + (error.message || JSON.stringify(error)));
      }

      // --- === `loadMyRequests` ---
      function loadMyRequests() {
        google.script.run
          .withSuccessHandler(populateMyRequests)
          .withFailureHandler(onMyRequestsFailure)
          .webGetMyRequests_V2();
      }
      
      // --- === `populateMyRequests` ---
      function populateMyRequests(requests) {
        console.log("Data for My Requests:", requests); // <-- ADD THIS LINE
        const listDiv = document.getElementById('my-requests-list');
        
        if (!Array.isArray(requests)) {
          listDiv.innerHTML = `<p class="status-message error visible">Received an invalid response from server.</p>`;
          return;
        }
        
        if (requests.length === 0) {
          listDiv.innerHTML = '<p class="text-color-secondary">You have no leave requests on file.</p>';
          return;
        }
        
        let html = '';
        requests.reverse().forEach((req, index) => {
          let statusClass = '';
          if (req.status === 'Pending') statusClass = 'status-pending';
          if (req.status === 'Approved') statusClass = 'status-approved';
          if (req.status === 'Denied') statusClass = 'status-denied';
          let actionHtml = '';
          if (req.status === 'Approved' || req.status === 'Denied') {
            actionHtml = `<p><strong>Action:</strong> ${req.status} by ${req.actionBy || 'N/A'} on ${formatDate(req.actionDate)}</p>`;
          }
          html += `
            <div class="request-list-item">
              <div class="item-details">
                <h4>${req.leaveType} Request (ID: ${req.requestID.slice(-5)})</h4>
                <p>
                  <strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)}
                  (${req.totalDays} ${req.totalDays > 1 ? 'days' : 'day'})
                </p>
                <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                ${req.reason ? `<p><strong>Reason:</strong> ${req.reason}</p>` : ''}
                ${req.sickNoteUrl ? `<p><strong>Sick Note:</strong> <a href="${req.sickNoteUrl}" target="_blank" style="color:var(--konecta-blue); font-weight: 600;">View PDF</a></p>` : ''}
                <p class="supervisor-info text-color-secondary"><strong>Supervisor:</strong> ${req. supervisorName || 'N/A'}</p>

                ${actionHtml}
                ${req.actionByReason ? `<p><strong>Admin Reason:</strong> ${req.actionByReason}</p>` : ''}

              </div>
              <div class="item-actions">
                <span class="status-badge ${statusClass}">${req.status}</span>
              </div>
            </div>
          `;
        });
        listDiv.innerHTML = html;
      }
      
      // üõë ADD THIS NEW FUNCTION üõë
      function toggleSickNoteField() {
        const leaveType = document.getElementById('leave-type').value;
        const sickNoteGroup = document.getElementById('sick-note-upload-group');
        const sickNoteInput = document.getElementById('sick-note-file');

        if (leaveType === 'Sick') {
          sickNoteGroup.style.display = 'block';
          sickNoteInput.required = true;
        } else {
          sickNoteGroup.style.display = 'none';
          sickNoteInput.required = false;
          sickNoteInput.value = null; // Clear the file if they change their mind
        }
      }
      
      // üõë REPLACE your old submitLeaveRequest with this one üõë
      function submitLeaveRequest() {
        // 1. Get all form values
        const leaveType = document.getElementById('leave-type').value;
        const startDate = document.getElementById('leave-start-date').value;
        let endDate = document.getElementById('leave-end-date').value;
        const reason = document.getElementById('leave-reason').value;
        const fileInput = document.getElementById('sick-note-file');
        const file = fileInput.files[0];

        try {
          // 2. Perform validation
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }

          const requestObject = {
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason,
            fileInfo: null // We'll add this next
          };

          // 3. Check if file is required
          if (leaveType === 'Sick') {
            if (!file) {
              throw new Error("A PDF sick note is mandatory for sick leave.");
            }
            if (file.type !== 'application/pdf') {
              throw new Error("Only .pdf files are allowed.");
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
              throw new Error("File is too large. Maximum size is 5MB.");
            }

            // --- File is valid, read it ---
            setStatus('leave-status', 'processing', 'Uploading PDF... This may take a moment.');
            const reader = new FileReader();

            // 4. This runs when the file is done reading
            reader.onload = function(e) {
              const fileData = e.target.result.split(',')[1]; // Get Base64 data
              
              requestObject.fileInfo = { 
                name: file.name, 
                type: file.type, 
                data: fileData 
              };
              
              // 5. Now call the server
              runSubmitLeaveRequest(requestObject);
            };
            
            reader.onerror = function(e) {
              throw new Error("Error reading the file.");
            };

            // 6. Start reading the file
            reader.readAsDataURL(file);

          } else {
            // --- No file needed, submit directly ---
            setStatus('leave-status', 'processing', 'Submitting request...');
            runSubmitLeaveRequest(requestObject);
          }
          
        } catch (err) {
          setStatus('leave-status', 'error', err.message);
        }
      }

      // üõë ADD THIS NEW HELPER FUNCTION üõë
      // This function contains the google.script.run call
      function runSubmitLeaveRequest(requestObject) {
        google.script.run
          .withSuccessHandler(msg => {
            if (msg.startsWith('Error:')) { 
              setStatus('leave-status', 'error', msg.replace('Error: ', ''));
            } else {
              setStatus('leave-status', 'success', msg);
              document.getElementById('leave-form').reset();
              document.getElementById('leave-start-date').valueAsDate = new Date();
              toggleSickNoteField(); // This will hide and clear the file input
              
              loadMyRequests();
              google.script.run.withSuccessHandler(user => {
                populateMyBalances(user.myBalances);
              }).getUserInfo();
              // Refresh admin panel if open (this logic was in your original file)
              // if (selfRole === 'admin' || selfRole === 'superadmin') {
              //   const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
              //   loadPendingRequests(currentFilter);
              // }
            }
          })
          .withFailureHandler(err => {
            setStatus('leave-status', 'error', err.message);
          })
          .webSubmitLeaveRequest(requestObject, null);
      }
      // *** START NEW FUNCTION ***
      function submitAdminRequest() {
        // *** Get the button at the start ***
        const btn = document.getElementById('header-role-request-button');
        try {
          const requestedRole = document.getElementById('admin-request-role').value;
          const justification = document.getElementById('admin-request-justification').value;

          if (!justification || justification.trim() === "") {
            throw new Error("A justification is required to request a role upgrade.");
          }
          
          // *** Add loading class ***
          btn.classList.add('loading');
          setStatus('admin-request-status', 'processing', 'Submitting request...');

          google.script.run
            .withSuccessHandler(msg => {
              // *** Remove loading class ***
              btn.classList.remove('loading');
              if (msg.startsWith('Error:')) {
                setStatus('admin-request-status', 'error', msg.replace('Error: ', ''));
              } else {
                // ...
                setTimeout(hideRoleRequestModal, 2000); 
              }
            })
            .withFailureHandler(err => {
              // *** Remove loading class ***
              btn.classList.remove('loading');
              setStatus('admin-request-status', 'error', err.message);
            })
            .webRequestAdminAccess(justification, requestedRole);

        } catch (err) {
          // *** Remove loading class (if error happens before call) ***
          btn.classList.remove('loading');
          setStatus('admin-request-status', 'error', err.message);
        }
      }
      // *** END NEW FUNCTION ***
      
      function loadLeaveReport() {
          const userEmail = document.getElementById('leave-report-user').value;
          const status = document.getElementById('leave-report-status').value;
          
          const filter = {
            userEmail: userEmail, // e.g., 'email@example.com' or 'ALL_SUBORDINATES'
            status: status // e.g., 'Pending' or 'All'
          };
          
          setStatus('approval-status', 'processing', 'Loading leave requests...');
          
          google.script.run
            .withSuccessHandler(populateLeaveReport)
            .withFailureHandler(onPendingRequestsFailure) // Can reuse this handler
            .webGetAdminLeaveRequests(filter); // New server function
        }

        function populateLeaveReport(requests) {
  const listDiv = document.getElementById('pending-requests-list');
  
  if (requests.error) {
     setStatus('approval-status', 'error', requests.error);
     listDiv.innerHTML = ''; 
     return;
  }
  if (!Array.isArray(requests) || requests.length === 0) {
    setStatus('approval-status', 'success', 'No leave requests found for this filter.');
    listDiv.innerHTML = '';
    return;
  }
  
  let html = '';
  requests.sort((a, b) => new Date(b.requestedDate) - new Date(a.requestedDate));

  requests.forEach(req => {
    // 1. Dynamic Badge Color
    let statusClass = '';
    const s = req.status.toLowerCase();
    if (s.includes('pending')) statusClass = 'status-pending'; // Matches "Pending", "Pending Project Mgr", etc.
    else if (s === 'approved') statusClass = 'status-approved';
    else if (s === 'denied') statusClass = 'status-denied';

    let balanceInfo = '';
    if (req.requesterBalance) {
      const balanceKey = req.leaveType.toLowerCase();
      const daysLeft = req.requesterBalance[balanceKey];
      balanceInfo = `<p class="text-color-secondary"><strong>Balance:</strong> ${daysLeft} days</p>`;
    }
    
    let actionHtml = '';
    
    // 2. FIXED LOGIC: Check if status INCLUDES "Pending"
    if (req.status.includes('Pending')) {
       // It is waiting for approval (either Project or Direct)
       actionHtml = `
        <div style="margin-top: 10px;">
          <button class="approve-btn" onclick="approveDenyRequest('${req.requestID}', 'Approved')">Approve</button>
          <button class="deny-btn" onclick="approveDenyRequest('${req.requestID}', 'Denied')">Deny</button>
        </div>
        <p class="text-color-secondary" style="font-size: 0.8rem; margin-top: 5px;">Currently waiting on: <strong>${req.supervisorName}</strong></p>
       `;
    } else {
       // It is finalized (Approved/Denied)
       actionHtml = `
        <p style="margin: 4px 0;"><strong>Action:</strong> ${req.status} by ${req.actionBy || 'N/A'}</p>
        ${req.actionByReason ? `<p style="margin: 4px 0;"><strong>Reason:</strong> ${req.actionByReason}</p>` : ''}
       `;
    }

    html += `
      <div class="request-list-item">
        <div class="item-details">
          <h4>${req.requestedByName} - ${req.leaveType}</h4>
          <p><strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)} (${req.totalDays} days)</p>
          <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
          ${req.reason ? `<p><strong>User Reason:</strong> ${req.reason}</p>` : ''}
          ${req.sickNoteUrl ? `<p><strong>Sick Note:</strong> <a href="${req.sickNoteUrl}" target="_blank" style="color:var(--konecta-blue); font-weight: 600;">View PDF</a></p>` : ''}
          ${balanceInfo}
        </div>
        <div class="item-actions" style="display:flex; flex-direction:column; align-items:flex-end;">
          <span class="status-badge ${statusClass}">${req.status}</span>
          ${actionHtml}
        </div>
      </div>
    `;
  });
  listDiv.innerHTML = html;
  setStatus('approval-status', 'success', `Successfully loaded ${requests.length} request(s).`);
}
      
      // --- Admin Approve/Deny Function ---
      function approveDenyRequest(requestID, newStatus) {
  const reason = prompt(`(Optional) Please provide a reason for ${newStatus.toLowerCase()} this request:`);
  // user clicked cancel
  if (reason === null) {
    return;
  }

  setStatus('approval-status', 'processing', `Processing request...`);

  google.script.run
    .withSuccessHandler(msg => {
      if (msg.startsWith('Error:')) { 
        setStatus('approval-status', 'error', msg.replace('Error: ', ''));
      } else {
        setStatus('approval-status', 'success', msg);
      }
      // This function name will be changed in the next step
      loadLeaveReport(); 
    })
    .withFailureHandler(err => {
      setStatus('approval-status', 'error', err.message);
    })
    .webApproveDenyRequest(requestID, newStatus, reason); // <-- Pass the reason
}
      
      // --- Load My Schedule ---
      function loadMySchedule() {
        setStatus('my-schedule-status', 'processing', 'Loading your schedule...');
        document.getElementById('my-schedule-display').innerHTML = '';

        google.script.run
          .withSuccessHandler(populateMySchedule)
          .withFailureHandler(err => {
            setStatus('my-schedule-status', 'error', err.message);
          })
          .webGetMySchedule();
      }

     // REPLACE this function in your <script> tag
function populateMySchedule(scheduleData) {
  const displayDiv = document.getElementById('my-schedule-display');
  
  if (scheduleData.error) {
    setStatus('my-schedule-status', 'error', scheduleData.error);
    return;
  }
  
  if (scheduleData.length === 0) {
    setStatus('my-schedule-status', 'success', 'No schedule found for the next 7 days.');
    return;
  }

  setStatus('my-schedule-status', 'success', '');

  let html = `
    <table class="schedule-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Day</th>
          <th>Status</th>
          <th>Shift Start</th>
          <th>Shift End</th>
        </tr>
      </thead>
      <tbody>
  `;

  const today = new Date();
  const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const todayStr = today.toLocaleDateString('en-US', { timeZone: timeZone });


  scheduleData.forEach(day => {
    const scheduleDate = new Date(day.date);
    const scheduleDateStr = scheduleDate.toLocaleDateString('en-US', { timeZone: timeZone });
    
    const dayStr = scheduleDate.toLocaleDateString('en-US', { weekday: 'long', timeZone: timeZone });
    const dateStr = formatDate(day.date);
    
    let trClass = '';
    if (scheduleDateStr === todayStr) {
      trClass = 'day-today';
    }

    let statusClass = '';
    // *** MODIFIED: Use new "Day Off" logic ***
    if (day.leaveType !== 'Present' && day.leaveType !== 'Day Off') {
      statusClass = 'status-leave'; // Red color for sick, absent, etc.
    } else if (day.leaveType === 'Day Off') {
      statusClass = 'status-break'; // Blue-ish color for Day Off
    }

    html += `
      <tr class="${trClass}">
        <td><strong>${day.userName}</strong></td>
        <td>${dateStr}</td>
        <td>${dayStr}</td>
        <td class="${statusClass}">${day.leaveType}</td>
        <td>${day.startTime || '--:--'}</td>
        <td>${day.endTime || '--:--'}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  displayDiv.innerHTML = html;
}
      
      // --- Load History Report ---
function loadHistoryReport() {
  const startDate = document.getElementById('history-start-date').value;
  const endDate = document.getElementById('history-end-date').value;
  
  let targetUserNames = [];
  
  if (selfRole === 'admin' || selfRole === 'superadmin') {
    // NEW: Read from the component dataset
    const wrapper = document.getElementById('history-user-select-wrapper');
    let selectedEmails = [];
    try {
        selectedEmails = JSON.parse(wrapper.dataset.value || "[]");
    } catch(e) { selectedEmails = []; }

    if (selectedEmails.length === 0) {
      setStatus('my-history-status', 'error', 'Please select at least one user.');
      return;
    }

    // Map emails to names
    targetUserNames = selectedEmails.map(email => {
      const user = allUsersList.find(u => u.email === email);
      return user ? user.name : null;
    }).filter(n => n);
    
  } else {
    targetUserNames.push(selfUserName);
  }
  
  if (!startDate || !endDate) {
    setStatus('my-history-status', 'error', 'Please select Start and End dates.');
    return;
  }

  setStatus('my-history-status', 'processing', `Loading history for ${targetUserNames.length} user(s)...`);
  document.getElementById('history-report-display').innerHTML = '';
  
  google.script.run
    .withSuccessHandler(data => {
      if (data.error) {
        setStatus('my-history-status', 'error', data.error);
        return;
      }
      setStatus('my-history-status', 'success', `Found ${data.length} records.`);
      populateHistoryReport(data);
      window.lastHistoryData = data; // Save for export
      document.getElementById('export-csv-btn').style.display = 'inline-block';
    })
    .withFailureHandler(err => setStatus('my-history-status', 'error', err.message))
    .webGetAdherenceRange(targetUserNames, startDate, endDate);
}
      
      // REPLACE this function in your <script> tag
function populateHistoryReport(data) {
  const displayDiv = document.getElementById('history-report-display');
  
  if (!data || data.length === 0) {
    displayDiv.innerHTML = '<p class="text-color-secondary">No adherence records found for the selected criteria.</p>';
    return;
  }

  const formatExceed = (value, isPositive) => {
    if (!value || value === 'No' || value === 0) return '0';
    const seconds = parseInt(value, 10);
    if (seconds > 0) {
        const color = isPositive ? '#34a853' : '#ea4335';
        return `<span style="font-weight: 600; color: ${color};">${formatSeconds(seconds)}</span>`;
    }
    return '0';
  };

  let html = `
    <table class="report-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Status</th>
          <th>Login</th>
          <th>Logout</th>
          <th>Tardy</th>
          <th>Early Leave</th>
          <th>Pre-Shift OT</th> <th>Post-Shift OT</th> <th>Break Exceed</th>
          <th>Lunch Exceed</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(row => {
    const totalBreakExceed = (parseInt(row.firstBreakExceed, 10) || 0) + (parseInt(row.lastBreakExceed, 10) || 0);
    
    // *** NEW: Style "Day Off" and "Absent" ***
    let statusClass = '';
    const leaveTypeLower = (row.leaveType || 'N/A').toLowerCase();
    if (leaveTypeLower === 'absent' || leaveTypeLower === 'sick' || leaveTypeLower === 'annual' || leaveTypeLower === 'casual') {
      statusClass = 'status-leave'; // Red
    } else if (leaveTypeLower === 'day off') {
      statusClass = 'status-break'; // Blue-ish
    }

    html += `
      <tr>
        <td>${row.userName}</td>
        <td>${formatDate(row.date)}</td>
        <td class="${statusClass}">${row.leaveType || 'N/A'}</td>
        <td>${formatTime(row.login)}</td>
        <td>${formatTime(row.logout)}</td>
        <td>${formatExceed(row.tardy, false)}</td>
        <td>${formatExceed(row.earlyLeave, false)}</td>
        <td>${formatExceed(row.preShiftOvertime, true)}</td> <td>${formatExceed(row.overtime, true)}</td>
        <td>${formatExceed(totalBreakExceed, false)}</td>
        <td>${formatExceed(row.lunchExceed, false)}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  displayDiv.innerHTML = html;
}
      
      // --- Export to CSV ---
      function exportHistoryToCSV() {
        if (!lastHistoryData || lastHistoryData.length === 0) {
          // Using a simple notification here instead of alert().
          setStatus('my-history-status', 'error', "No data to export. Please 'View History' first.");
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "User,Date,Status,Login,Logout,Tardy (sec),Early Leave (sec),Overtime (sec),1st Break Exceed (sec),Lunch Exceed (sec),Last Break Exceed (sec)\r\n";
        
        lastHistoryData.forEach(data => {
          let row = [
            `"${data.userName}"`,
            `"${formatDate(data.date)}"`,
            `"${data.leaveType || 'N/A'}"`,
            `"${formatTime(data.login)}"`,
            `"${formatTime(data.logout)}"`,
            data.tardy || 0,
            data.earlyLeave || 0,
            data.overtime || 0,
            data.firstBreakExceed || 0,
            data.lunchExceed || 0,
            data.lastBreakExceed || 0
          ].join(",");
          csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `History_Report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }
      
      // --- Submit Manual Punch (FIXED PHASE 3) ---
      function submitManualPunch() {
        try {
          const userEmail = document.getElementById('manual-punch-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");

          const action = document.getElementById('manual-punch-action').value;
          const date = document.getElementById('manual-punch-date').value;
          const time = document.getElementById('manual-punch-time').value;
          
          // *** FIX: Get Project ID if available ***
          // Note: We might not have a project dropdown in the Manual Punch form yet. 
          // If not, we pass null, or we should add one to the HTML.
          // Assuming for now we pass null to keep it simple, or fetch from the main selector if relevant.
          // Ideally, the Admin Tools panel should have its own Project Select.
          const projectId = null; 
          
          if (!action) throw new Error("Please select a punch action.");
          if (!date) throw new Error("Please select a date.");
          if (!time) throw new Error("Please select a time.");
          
          const timestamp = new Date(date + 'T' + time).toISOString();
          
          setStatus('manual-punch-status', 'processing', `Processing "${action}" for ${user.name}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.message && msg.message.startsWith('Error:')) { // Handle object response
                 setStatus('manual-punch-status', 'error', msg.message.replace('Error: ', ''));
              } else if (typeof msg === 'string' && msg.startsWith('Error:')) {
                 setStatus('manual-punch-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('manual-punch-status', 'success', msg.message || msg);
                document.getElementById('manual-punch-form').reset();
                document.getElementById('manual-punch-date').valueAsDate = new Date();
              }
            })
            .withFailureHandler(err => {
              setStatus('manual-punch-status', 'error', err.message);
            })
            // *** FIX: PASS 4 ARGUMENTS to match webPunch(action, target, time, project) ***
            .webPunch(action, user.name, timestamp, projectId); 
            
        } catch(err) {
          setStatus('manual-punch-status', 'error', err.message);
        }
      }
      
      // --- Submit Admin Leave Request ---
      function submitAdminLeaveRequest() {
        try {
          const userEmail = document.getElementById('admin-leave-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('admin-leave-type').value;
          const startDate = document.getElementById('admin-leave-start-date').value;
          let endDate = document.getElementById('admin-leave-end-date').value;
          const reason = document.getElementById('admin-leave-reason').value;

          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }
          
          const requestObject = {
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason
          };
          
          setStatus('admin-leave-status', 'processing', `Submitting request for ${user.name}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('admin-leave-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('admin-leave-status', 'success', msg);
                document.getElementById('admin-leave-form').reset();
                document.getElementById('admin-leave-start-date').valueAsDate = new Date();
                
                const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
                loadPendingRequests(currentFilter);
              }
            })
            .withFailureHandler(err => {
              setStatus('admin-leave-status', 'error', err.message);
            })
            .webSubmitLeaveRequest(requestObject, user.email);
          
        } catch (err) {
          setStatus('admin-leave-status', 'error', err.message);
        }
      }
      
      // --- Submit Balance Adjustment ---
      function submitBalanceAdjustment() {
        try {
          const userEmail = document.getElementById('balance-user-select').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('balance-leave-type').value;
          const amount = parseFloat(document.getElementById('balance-amount').value);
          const reason = document.getElementById('balance-reason').value;

          if (isNaN(amount) || amount === 0) throw new Error("Please enter a valid, non-zero amount.");
          if (!reason) throw new Error("A reason is required for all adjustments.");

          setStatus('balance-adjust-status', 'processing', `Adjusting ${leaveType} balance for ${user.name}...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('balance-adjust-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('balance-adjust-status', 'success', msg);
                document.getElementById('balance-adjustment-form').reset();
              }
            })
            .withFailureHandler(err => {
              setStatus('balance-adjust-status', 'error', err.message);
            })
            .webAdjustLeaveBalance(user.email, leaveType, amount, reason);

        } catch (err) {
          setStatus('balance-adjust-status', 'error', err.message);
        }
      }
      
      // --- Import Schedule CSV ---
      function importScheduleCSV() {
        const fileInput = document.getElementById('csv-file-input');
        const file = fileInput.files[0];

        if (!file) {
          setStatus('csv-import-status', 'error', 'Please select a CSV file to import.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const data = parseCSV(text);
          
          if (!data || data.length === 0) {
            setStatus('csv-import-status', 'error', 'File is empty or invalid. Could not parse any rows.');
            return;
          }

          const headers = data[0];
          
          // *** THIS IS THE FIX ***
          // Now checks for 'agent email' (using bracket notation for the space)
          // and 'StartDate'
          if (!headers.Name || !headers.StartDate || !headers['agent email']) {
            setStatus('csv-import-status', 'error', 'Invalid CSV format. Must include headers: Name, StartDate, and agent email.');
            return;
          }
          // *** END OF FIX ***

          setStatus('csv-import-status', 'processing', `Importing ${data.length} schedule records...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('csv-import-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('csv-import-status', 'success', msg);
                fileInput.value = '';
              }
            })
            .withFailureHandler(err => {
              setStatus('csv-import-status', 'error', err.message);
            })
            .webImportScheduleCSV(data);
        };
        
        reader.onerror = function(e) {
          setStatus('csv-import-status', 'error', 'Error reading file: ' + e.message);
        };

        reader.readAsText(file);
      }

      // --- Simple CSV Parser ---
      function parseCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim());
        const result = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j] || '';
          }
          result.push(obj);
        }
        return result;
      }

      // --- NEW: Function to download the CSV template ---
      // --- PHASE 9: Updated CSV Template ---
      function downloadScheduleTemplate() {
        const headers = "Name,StartDate,ShiftStartTime,EndDate,ShiftEndTime,LeaveType,agent email,Break1Start,Break1End,LunchStart,LunchEnd,Break2Start,Break2End";
        
        const example1 = "John Doe,11/30/2025,09:00,11/30/2025,18:00,Present,john.doe@konecta.com,11:00,11:15,13:00,13:30,16:00,16:15";
        const example2 = "Jane Smith,11/30/2025,,,,Sick,jane.smith@konecta.com,,,,,,";
        const example3 = "Peter Jones,12/01/2025,14:00,12/01/2025,23:00,Present,peter.jones@konecta.com,16:00,16:15,18:00,18:30,21:00,21:15";
        
        const csvContent = [headers, example1, example2, example3].join("\r\n");

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", "schedule_template_v2.csv");
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }
      // --- END OF NEW FUNCTION ---

      // --- Dashboard Functions ---
      
      // History Select Functions (Kept for History Report only)
      function getSelectedUsers(type) {
        if (type !== 'history') return [];
        const userEmails = Object.keys(selectedHistoryUsers);
        if (userEmails.length === 0) {
          return ['ALL_USERS'];
        }
        return userEmails;
      }
      
      function toggleUserDropdown(type, event) {
          event.stopPropagation();
          if (type !== 'history') return;
          const dropdown = document.getElementById(`custom-${type}-select-dropdown`);
          const button = document.getElementById(`custom-${type}-select-button`);
          const isVisible = dropdown.style.display === 'block';

          if (isVisible) {
              dropdown.style.display = 'none';
              button.classList.remove('active');
          } else {
              document.querySelectorAll('.custom-select-dropdown').forEach(d => d.style.display = 'none');
              document.querySelectorAll('.custom-select-button').forEach(b => b.classList.remove('active'));
              dropdown.style.display = 'block';
              button.classList.add('active');
              
              const allChecked = Object.keys(selectedHistoryUsers).length === historyUserList.length && historyUserList.length > 0;
              const selectAllCheckbox = document.getElementById(`select-all-checkbox-${type}`);
              if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
          }
      }

      function selectUserItem(type, event, itemElement, userEmail, userName) {
          event.stopPropagation();
          if (type !== 'history') return;
          const checkbox = itemElement.querySelector(`input[data-email="${userEmail}"]`);
          
          if (event.target !== checkbox && event.target.tagName !== 'LABEL') {
              checkbox.checked = !checkbox.checked;
          }
          
          const finalCheckedState = checkbox.checked;
          const selectedState = selectedHistoryUsers;
          
          if (finalCheckedState) {
              selectedState[userEmail] = userName;
              itemElement.classList.add('selected');
          } else {
              delete selectedState[userEmail];
              itemElement.classList.remove('selected');
          }
          
          const allChecked = Object.keys(selectedState).length === historyUserList.length && historyUserList.length > 0;
          const selectAllCheckbox = document.getElementById(`select-all-checkbox-${type}`);
          if (selectAllCheckbox) {
              selectAllCheckbox.checked = allChecked;
          }

          updateSelectButtonDisplay(type);
      }

      function toggleSelectAll(type) {
          if (type !== 'history') return;
          const selectAllChecked = document.getElementById(`select-all-checkbox-${type}`).checked;
          const dropdown = document.getElementById(`custom-${type}-select-dropdown`);
          
          Object.keys(selectedHistoryUsers).forEach(key => delete selectedHistoryUsers[key]);
          
          if (selectAllChecked) {
              allUsersList.forEach(user => {
                  selectedHistoryUsers[user.email] = user.name;
              });
              dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                  item.classList.add('selected');
                  const checkbox = item.querySelector('input[type="checkbox"]');
                  if (checkbox && checkbox.id !== `select-all-checkbox-${type}`) checkbox.checked = true; 
              });
          } else {
              dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                  item.classList.remove('selected');
                  const checkbox = item.querySelector('input[type="checkbox"]');
                   if (checkbox && checkbox.id !== `select-all-checkbox-${type}`) checkbox.checked = false;
              });
          }
          updateSelectButtonDisplay(type);
      }

      function updateSelectButtonDisplay(type) {
          if (type !== 'history') return;
          const button = document.getElementById(`custom-${type}-select-button`);
          if (!button) return;
          
          const count = Object.keys(selectedHistoryUsers).length;
          
          if (count === 0) {
              button.textContent = 'Select Users (0 selected)';
          } else if (count === historyUserList.length && historyUserList.length > 0) {
              button.textContent = `All Users Selected (${count})`;
          } else {
              button.textContent = `Selected: ${count} user(s)`;
          }
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
          // --- History Logic ---
          const historyDropdown = document.getElementById('custom-history-select-dropdown');
          const historyButton = document.getElementById('custom-history-select-button');
          if (historyDropdown && historyButton && historyDropdown.style.display === 'block') {
              const container = document.getElementById('history-user-select-container');
              if (container && !container.contains(event.target)) {
                  historyDropdown.style.display = 'none';
                  historyButton.classList.remove('active');
              }
          }
      });


      // --- NEW HIERARCHY FUNCTIONS ---
      
      // Recursive function to flatten hierarchy into a list of emails
      function flattenHierarchy(node, list = []) {
          if (!node || !node.email) return list;
          list.push(node.email);
          node.subordinates.forEach(sub => flattenHierarchy(sub, list));
          return list;
      }
      
      // Function to get the current user's full hierarchy
      function loadMyFullHierarchy() {
          const managerEmail = allUsersList.find(u => u.name === selfUserName)?.email;
          if (!managerEmail) {
              setStatus('dashboard-status', 'error', "Could not find your user email.");
              return;
          }
          
          setStatus('dashboard-status', 'processing', 'Loading full subordinate team list...');

          // This fetches the flattened list of all direct and indirect reports
          google.script.run
            .withSuccessHandler(emails => {
                if (emails.error) {
                    setStatus('dashboard-status', 'error', emails.error);
                    return;
                }
                
                const managerName = allUsersList.find(u => u.email === managerEmail)?.name || 'Manager';
                
                currentDashboardSelection = {
                    emails: emails,
                    name: `${managerName}'s Full Hierarchy`,
                    isFullHierarchy: true
                };
                
                // Also update the selection display to reflect the full team
                document.getElementById('selected-user-display').textContent = currentDashboardSelection.name;
                
                // Deselect any node in the tree
                document.querySelectorAll('#hierarchy-tree-view .tree-node').forEach(node => {
                    node.classList.remove('selected');
                });
                
                setStatus('dashboard-status', 'success', `Set dashboard selection to: ${currentDashboardSelection.name}`);
                loadDashboard();
            })
            .withFailureHandler(err => {
                setStatus('dashboard-status', 'error', `Failed to load full hierarchy: ${err.message}`);
            })
            .webGetAllSubordinateEmails(managerEmail);
      }
      
      // Function to load the hierarchy tree from the server
      function loadManagerHierarchy() {
          const treeView = document.getElementById('hierarchy-tree-view');
          if (selfRole === 'agent') {
              treeView.innerHTML = `<p class="text-color-secondary">Hierarchy view available only to managers.</p>`;
              return;
          }
          treeView.innerHTML = `<p class="text-color-secondary">Fetching team hierarchy...</p>`;

          google.script.run
              .withSuccessHandler(hierarchyData => {
                  if (hierarchyData.error) {
                      treeView.innerHTML = `<p class="status-message error visible">${hierarchyData.error}</p>`;
                      return;
                  }
                  managerHierarchy = hierarchyData;
                  // Clear the tree before rendering
                  treeView.innerHTML = '';
                  renderHierarchyTree(hierarchyData, treeView);
                  
                  // Default selection: The manager's own node, loaded as a single user.
                  currentDashboardSelection.emails = [hierarchyData.email];
                  currentDashboardSelection.name = hierarchyData.name;
                  currentDashboardSelection.isFullHierarchy = false;
                  
                  document.getElementById('selected-user-display').textContent = hierarchyData.name;
                  
                  // Auto-select the root node (the manager)
                  const rootNode = document.querySelector(`#hierarchy-tree-view [data-email="${hierarchyData.email}"]`);
                  if (rootNode) {
                       rootNode.classList.add('selected');
                  }
                  
              })
              .withFailureHandler(err => {
                  treeView.innerHTML = `<p class="status-message error visible">Error loading hierarchy: ${err.message}</p>`;
              })
              .webGetManagerHierarchy();
      }
      
      // Recursive function to render the hierarchy
      function renderHierarchyTree(node, containerElement) {
          if (!node || !node.name) return;

          const isManager = node.role !== 'agent';
          const hasChildren = node.subordinates && node.subordinates.length > 0;
          const isRoot = node.depth === 0;
          
          // Get the role circle class
          const roleClass = node.role || 'agent';

          // 1. Create the container element for this node
          const nodeContainer = document.createElement('div');
          
          // 2. Create the clickable tree node element
          const nodeDiv = document.createElement('div');
          nodeDiv.className = `tree-node ${isManager ? 'collapsed' : ''}`;
          nodeDiv.setAttribute('data-email', node.email);
          nodeDiv.setAttribute('data-role', node.role);
          nodeDiv.setAttribute('data-has-children', hasChildren);
          nodeDiv.onclick = (e) => handleNodeClick(e, node);

          // Build the content of the node
          nodeDiv.innerHTML = `
              <img src="https://icons.veryicon.com/png/o/miscellaneous/cloud-services/arrow-right-13.png" class="toggle-icon" alt="Toggle">
              <span class="tree-label">
                  <div class="role-icon ${roleClass}"></div>
                  ${node.name}
                  ${isManager && !isRoot ? ` <span class="text-color-secondary">(${node.subordinates.length} reports)</span>` : ''}
              </span>
          `;
          
          nodeContainer.appendChild(nodeDiv);

          // 3. Create the subordinates list container
          if (hasChildren) {
              const subList = document.createElement('div');
              subList.className = 'subordinates-list';
              subList.id = `subordinates-${node.email.replace(/[.@]/g, '-')}`;

              // Recursively render children
              node.subordinates.forEach(sub => {
                  renderHierarchyTree(sub, subList);
              });
              
              nodeContainer.appendChild(subList);
          }
          
          containerElement.appendChild(nodeContainer);
      }
      
      // Handles click on any node in the tree
      function handleNodeClick(e, node) {
          e.stopPropagation();
          const nodeDiv = e.currentTarget;
          const isManager = node.role !== 'agent';
          const hasChildren = nodeDiv.getAttribute('data-has-children') === 'true';
          
          // 1. Handle Selection (always select the clicked user)
          document.querySelectorAll('#hierarchy-tree-view .tree-node').forEach(n => {
              n.classList.remove('selected');
          });
          nodeDiv.classList.add('selected');
          
          // Set selection state
          currentDashboardSelection.emails = [node.email]; // Default to single user
          currentDashboardSelection.name = node.name;
          currentDashboardSelection.isFullHierarchy = isManager && hasChildren;
          
          document.getElementById('selected-user-display').textContent = node.name;
          
          // 2. Handle Collapse/Expand for managers
          if (isManager && hasChildren) {
              const subList = document.getElementById(`subordinates-${node.email.replace(/[.@]/g, '-')}`);
              if (subList) {
                  const isCollapsed = nodeDiv.classList.contains('collapsed');
                  nodeDiv.classList.toggle('collapsed');
                  subList.style.display = isCollapsed ? 'block' : 'none';
              }
          }
      }
      
      // Reworked loadDashboard to use the new selection state
      function loadDashboard() {
        // Since Google Charts are not used for these visuals, we can remove the chartsLoaded check
        
        const date = document.getElementById('dashboard-date').value;
        if (!date) {
           setStatus('dashboard-status', 'error', 'Please select a date for the dashboard.');
           return;
        }
        
        // Final user list to send to the backend
        let userEmailsToQuery = [];
        let dashboardTitle = `Dashboard for ${formatDate(date)}`;
        
        if (currentDashboardSelection.isFullHierarchy) {
            // Load Full Hierarchy was explicitly requested or a manager node was clicked
            
            // If the manager node was clicked (isFullHierarchy is true, but emails has only 1), 
            // we must fetch the full list of reports for that single manager.
            if (currentDashboardSelection.emails.length === 1 && currentDashboardSelection.name !== "None") {
                 setStatus('dashboard-status', 'processing', `Loading full subordinate team for ${currentDashboardSelection.name}...`);
                 
                 // Synchronous call (Apps Script handles the full list generation)
                 google.script.run
                    .withSuccessHandler(emails => {
                         // Update the selection state with the flattened list
                        currentDashboardSelection.emails = emails;
                        
                        dashboardTitle = `Hierarchy for ${currentDashboardSelection.name} (${emails.length} users)`;
                        document.getElementById('dashboard-title').innerText = dashboardTitle;
                        
                        // Proceed to fetch dashboard data with the new list
                        fetchDashboardData(emails, date, dashboardTitle);
                    })
                    .withFailureHandler(err => {
                        setStatus('dashboard-status', 'error', `Failed to load hierarchy list: ${err.message}`);
                    })
                    .webGetAllSubordinateEmails(currentDashboardSelection.emails[0]);
                return;
            } else {
                 // Full hierarchy list was already loaded via 'Load My Full Hierarchy' button
                 userEmailsToQuery = currentDashboardSelection.emails;
                 dashboardTitle = currentDashboardSelection.name;
            }

        } else {
            // Single User or Saved Selection was used
            userEmailsToQuery = currentDashboardSelection.emails;
            dashboardTitle = `Dashboard for ${currentDashboardSelection.name} (${userEmailsToQuery.length} users)`;
        }
        
        if (userEmailsToQuery.length === 0) {
             setStatus('dashboard-status', 'error', 'Please select a user or load a team from the hierarchy.');
             return;
        }
        
        document.getElementById('dashboard-title').innerText = dashboardTitle;
        fetchDashboardData(userEmailsToQuery, date, dashboardTitle);
      }
      
      function fetchDashboardData(userEmails, date, dashboardTitle) {
          setStatus('dashboard-status', 'processing', `Loading data for ${userEmails.length} user(s) on ${formatDate(date)}...`);
          
          // Clear old data placeholders immediately to show processing
          document.getElementById('status-agent-list').innerHTML = '<p class="text-color-secondary">Loading...</p>';
          document.getElementById('adherence-detail-table').innerHTML = '<p class="text-color-secondary">Loading...</p>';
          document.getElementById('pending-leave-table').innerHTML = '<p class="text-color-secondary">Loading...</p>';


          google.script.run
            .withSuccessHandler(data => {
                window.lastDashboardData = data; 
                drawDashboard(data);
            })
            .withFailureHandler(err => {
              setStatus('dashboard-status', 'error', 'Server Error: ' + err.message);
              document.getElementById('status-agent-list').innerHTML = '<p class="text-color-secondary">Error loading data.</p>'; 
              document.getElementById('adherence-detail-table').innerHTML = '<p class="text-color-secondary">Error loading data.</p>';
              document.getElementById('pending-leave-table').innerHTML = '<p class="text-color-secondary">Error loading data.</p>';
            })
            .webGetDashboardData(userEmails, date);
      }
      
      // Function to save the current selection (single user or team list)
      function saveCurrentSelection() {
          if (currentDashboardSelection.emails.length === 0) {
              setStatus('dashboard-status', 'error', 'No user(s) currently selected to save.');
              return;
          }
          
          setStatus('dashboard-status', 'processing', 'Saving current selection as "My Team"...');
          
          google.script.run
            .withSuccessHandler(msg => {
              setStatus('dashboard-status', 'success', msg);
            })
            .withFailureHandler(err => {
              setStatus('dashboard-status', 'error', err.message);
            })
            .webSaveMyTeam(currentDashboardSelection.emails);
      }
      
      // Function to get the current list of emails from the selection state
      function getDashboardEmailsForSave() {
          // This function is now deprecated in favor of using the global state in saveCurrentSelection
          return currentDashboardSelection.emails;
      }
      
      function drawDashboard(data) {
        if (!data || data.error) {
          setStatus('dashboard-status', 'error', data.error || 'Failed to load dashboard data.');
          return;
        }
        
        setStatus('dashboard-status', 'success', 'Dashboard updated.');
        
        // --- PHASE 7: RENDER METRICS ---
        if (data.wfmMetrics) {
          const m = data.wfmMetrics;
          
          // Capacity
          const capEl = document.getElementById('metric-capacity');
          capEl.innerText = `${m.capacity}%`;
          capEl.className = 'metric-value ' + (m.capacity < 50 ? 'metric-bad' : (m.capacity < 80 ? 'metric-warn' : 'metric-good'));
          document.getElementById('metric-capacity-sub').innerText = `${m.working}/${m.scheduled} Agents`;

          // Adherence
          const adhEl = document.getElementById('metric-adherence');
          adhEl.innerText = `${m.adherence}%`;
          adhEl.className = 'metric-value ' + (m.adherence < 85 ? 'metric-bad' : (m.adherence < 95 ? 'metric-warn' : 'metric-good'));

          // Shrinkage
          const shkEl = document.getElementById('metric-shrinkage');
          shkEl.innerText = `${m.shrinkage}%`;
          shkEl.className = 'metric-value ' + (m.shrinkage > 20 ? 'metric-bad' : (m.shrinkage > 10 ? 'metric-warn' : 'metric-good'));
          document.getElementById('metric-shrinkage-sub').innerText = `${m.unavailable} Unavailable`;
        }
        // -------------------------------

        // --- 1. Draw Status Agent List ---
        const statusAgentDiv = document.getElementById('status-agent-list');
        let statusHtml = '';
        
        if (!data.agentStatusList || data.agentStatusList.length === 0) {
             statusHtml = '<p class="text-color-secondary">No user status information available.</p>';
        } else {
             data.agentStatusList.forEach(agent => {
                  const statusClass = getStatusClass(agent.status);
                  const displayStatus = formatStatusWithIcon(agent.status);
                  statusHtml += `
                      <div class="agent-status-item">
                          <strong>${agent.name}</strong>
                          <span class="status-tag status-${statusClass}">${displayStatus}</span>
                      </div>
                  `;
             });
        }
        statusAgentDiv.innerHTML = statusHtml;

        // --- 2. Draw Adherence Detail List ---
        const adherenceDetailDiv = document.getElementById('adherence-detail-table');
        let adherenceHtml = '';
        
        if (!data.individualAdherenceMetrics || data.individualAdherenceMetrics.length === 0) {
            adherenceHtml = '<p class="text-color-secondary">No adherence data found for selected users today.</p>';
        } else {
            const filteredMetrics = data.individualAdherenceMetrics.filter(user => {
                 // Always show if scheduled, or if there is deviation
                 return user.scheduled || user.tardy > 0 || user.earlyLeave > 0 || user.overtime > 0;
            });
            
            filteredMetrics.sort((a, b) => {
                 const aDev = a.tardy + a.earlyLeave + a.breakExceed + a.lunchExceed;
                 const bDev = b.tardy + b.earlyLeave + b.breakExceed + b.lunchExceed;
                 return bDev - aDev; // Highest deviation first
            });
            
            filteredMetrics.forEach(user => {
                const totalBreakExceed = (parseInt(user.breakExceed, 10) || 0) + (parseInt(user.lunchExceed, 10) || 0);
                
                // Traffic Light Logic for Border
                let borderClass = 'border-left: 4px solid #16a34a;'; // Green
                const totalDev = user.tardy + user.earlyLeave + totalBreakExceed + user.lunchExceed;
                if (totalDev > 600) borderClass = 'border-left: 4px solid #dc2626;'; // Red (>10 mins)
                else if (totalDev > 0) borderClass = 'border-left: 4px solid #ca8a04;'; // Yellow

                adherenceHtml += `
                    <div class="dashboard-detail-item" style="${borderClass}">
                        <h4 class="detail-label" style="grid-column: 1 / -1; margin: 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); color: var(--text-color);">${user.name}</h4>
                        
                        <span class="detail-label">Tardy:</span>
                        <span class="detail-value">${formatColoredSeconds(user.tardy, false)}</span>
                        
                        <span class="detail-label">Early Leave:</span>
                        <span class="detail-value">${formatColoredSeconds(user.earlyLeave, false)}</span>
                        
                        <span class="detail-label">Break Exceed:</span>
                        <span class="detail-value">${formatColoredSeconds(totalBreakExceed, false)}</span>
                        
                        <span class="detail-label">Overtime:</span>
                        <span class="detail-value">${formatColoredSeconds(user.overtime, true)}</span>
                    </div>
                `;
            });
        }
        adherenceDetailDiv.innerHTML = adherenceHtml;

        // --- 3. Draw Pending Leave List (Same as before) ---
        const pendingLeaveDiv = document.getElementById('pending-leave-table');
        let pendingLeaveHtml = '';
        if (!data.pendingRequests || data.pendingRequests.length === 0) {
             pendingLeaveHtml = '<p class="text-color-secondary">No pending leave requests.</p>';
        } else {
            data.pendingRequests.forEach(req => {
                pendingLeaveHtml += `
                    <div class="dashboard-leave-item">
                        <div class="item-details">
                            <h4>${req.name} - ${req.type}</h4>
                            <p><strong>Dates:</strong> ${formatDate(req.startDate)} (${req.days} days)</p>
                        </div>
                         <span class="status-badge status-pending">Pending</span>
                    </div>
                `;
            });
        }
        pendingLeaveDiv.innerHTML = pendingLeaveHtml;
      }

      // --- PHASE 7: EXPORT FUNCTION ---
      function exportDashboardCSV() {
        if (!window.lastDashboardData) {
          alert("No dashboard data available to export. Please load the dashboard first.");
          return;
        }
        
        const data = window.lastDashboardData;
        const dateStr = document.getElementById('dashboard-date').value;
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // 1. Metrics Header
        csvContent += `Dashboard Report for ${dateStr}\r\n`;
        csvContent += `Adherence,${data.wfmMetrics.adherence}%\r\n`;
        csvContent += `Capacity,${data.wfmMetrics.capacity}%\r\n`;
        csvContent += `Shrinkage,${data.wfmMetrics.shrinkage}%\r\n\r\n`;
        
        // 2. Details Header
        csvContent += "Name,Tardy (sec),Early Leave (sec),Break Exceed (sec),Lunch Exceed (sec),Overtime (sec)\r\n";
        
        // 3. Details Rows
        data.individualAdherenceMetrics.forEach(user => {
           let row = [
             `"${user.name}"`,
             user.tardy,
             user.earlyLeave,
             user.breakExceed,
             user.lunchExceed,
             user.overtime
           ].join(",");
           csvContent += row + "\r\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `WFM_Dashboard_${dateStr}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }
      
      // Function to get the current list of emails from the selection state
      function saveMyTeam() {
        const selectedUsers = currentDashboardSelection.emails;
        
        if (selectedUsers.length === 0) {
          setStatus('dashboard-status', 'error', 'No specific users selected to save as your team.');
          return;
        }
        
        setStatus('dashboard-status', 'processing', 'Saving current selection as "My Team"...');
        
        google.script.run
          .withSuccessHandler(msg => {
            setStatus('dashboard-status', 'success', msg);
          })
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
          })
          .webSaveMyTeam(selectedUsers);
      }
      
      function loadMyTeam(autoLoadDashboard = false) { 
        setStatus('dashboard-status', 'processing', 'Loading "My Team"...');
        
        google.script.run
          .withSuccessHandler(teamEmails => {
            
            // Deselect all nodes in the tree
            document.querySelectorAll('#hierarchy-tree-view .tree-node').forEach(node => {
                node.classList.remove('selected');
            });

            if (teamEmails && teamEmails.length > 0) {
                const teamNames = teamEmails.map(email => {
                    const user = allUsersList.find(u => u.email === email);
                    return user ? user.name : null;
                }).filter(name => name);
                
                // Select the first node that is part of the saved team, just for visual feedback
                if(teamEmails[0]) {
                     const firstNode = document.querySelector(`#hierarchy-tree-view [data-email="${teamEmails[0]}"]`);
                     if (firstNode) firstNode.classList.add('selected');
                }
                
                currentDashboardSelection = {
                    emails: teamEmails,
                    name: `Saved Team (${teamEmails.length} users)`,
                    isFullHierarchy: false
                };
                
                document.getElementById('selected-user-display').textContent = currentDashboardSelection.name;
                setStatus('dashboard-status', 'success', 'Loaded "My Team". Click "Load Dashboard" to view.');
            } else {
                 currentDashboardSelection = { emails: [], name: "None", isFullHierarchy: false };
                 document.getElementById('selected-user-display').textContent = 'None';
                 setStatus('dashboard-status', 'success', 'No "My Team" saved. Select a user/team and click "Load Dashboard".');
            }
            
            if (autoLoadDashboard) {
              loadDashboard();
            }
          })
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
            if (autoLoadDashboard) {
              loadDashboard();
            }
          })
          .webGetMyTeam();
      }

 // [index.html] UPDATED: Handle "Keep" vs "Change" robustly
function submitMovementRequest() {
  try {
    const userEmail = document.getElementById('reporting-line-user').value;
    const newSupervisorEmail = document.getElementById('reporting-line-supervisor').value;
    
    if (!userEmail) throw new Error("Please select a user to move.");
    if (!newSupervisorEmail) throw new Error("Please select a new Direct Manager.");
    if (userEmail === newSupervisorEmail) throw new Error("A user cannot be their own supervisor.");

    // Logic for Project Manager
    let finalPMEmail = "";
    
    // Check if the radio buttons exist (safety check)
    const pmRadio = document.querySelector('input[name="pm-action"]:checked');
    const pmAction = pmRadio ? pmRadio.value : 'keep'; // Default to keep if hidden
    
    if (pmAction === 'keep') {
       const displayEl = document.getElementById('current-pm-display');
       finalPMEmail = displayEl.dataset.email;
       
       // FIX: If "Keep" is selected but the user HAS NO PM, force selection
       if (!finalPMEmail || finalPMEmail === "undefined" || finalPMEmail === "null" || finalPMEmail === "") {
           alert("This user currently has no Project Manager assigned. Please select 'Change' and assign one.");
           return; 
       }
    } else {
       finalPMEmail = document.getElementById('reporting-line-pm').value;
       if (!finalPMEmail) throw new Error("Please select the new Project Manager from the dropdown.");
    }

    setStatus('movement-request-status', 'processing', 'Submitting movement request...');

    google.script.run
      .withSuccessHandler(msg => {
        // If it was auto-approved (Superadmin) or pending (Admin), show the message
        setStatus('movement-request-status', 'success', msg);
        
        // Reset form
        document.getElementById('reporting-line-form').reset();
        document.getElementById('pm-change-section').style.display = 'none';
        
        // Refresh the pending list (in case it was pending, it appears; in case approved, it won't)
        loadPendingMovements();
      })
      .withFailureHandler(err => {
        setStatus('movement-request-status', 'error', err.message);
      })
      .webSubmitMovementRequest(userEmail, newSupervisorEmail, finalPMEmail);

  } catch (err) {
    setStatus('movement-request-status', 'error', err.message);
  }
}

      // --- NEW: Load Pending Movements ---
      function loadPendingMovements() {
        const listDiv = document.getElementById('pending-movements-list');
        listDiv.innerHTML = '<p class="text-color-secondary">Loading pending approvals...</p>';
        setStatus('movement-approval-status', '', ''); // Clear status

        google.script.run
          .withSuccessHandler(requests => {
            if (requests.error) {
              listDiv.innerHTML = `<p class="status-message error visible">${requests.error}</p>`;
              return;
            }
            if (requests.length === 0) {
              listDiv.innerHTML = '<p class="text-color-secondary">No pending approvals found.</p>';
              return;
            }

            let html = '';
            requests.forEach(req => {
              html += `
                <div class="request-list-item">
                  <div class="item-details">
                    <h4>Move: ${req.userToMoveName}</h4>
                    <p><strong>From:</strong> ${req.fromSupervisorName}</p>
                    <p><strong>To:</strong> ${req.toSupervisorName}</p>
                    <p class="text-color-secondary" style="font-size: 0.85rem;">Requested by ${req.requestedByName} on ${formatDate(req.requestedDate)}</p>
                  </div>
                  <div class="item-actions">
                    <button class="approve-btn" onclick="handleMovementApproval('${req.movementID}', 'Approved')">Approve</button>
                    <button class="deny-btn" onclick="handleMovementApproval('${req.movementID}', 'Denied')">Deny</button>
                  </div>
                </div>
              `;
            });
            listDiv.innerHTML = html;
          })
          .withFailureHandler(err => {
            listDiv.innerHTML = `<p class="status-message error visible">Error loading approvals: ${err.message}</p>`;
          })
          .webGetPendingMovements();
      }

      // --- NEW: Handle Movement Approval ---
      function handleMovementApproval(movementID, newStatus) {
        setStatus('movement-approval-status', 'processing', 'Processing request...');

        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              setStatus('movement-approval-status', 'error', result.error);
            } else {
              setStatus('movement-approval-status', 'success', result.message);
              loadPendingMovements(); // Refresh the list
            }
          })
          .withFailureHandler(err => {
            setStatus('movement-approval-status', 'error', err.message);
          })
          .webApproveDenyMovement(movementID, newStatus);
      }

      // --- NEW: Load Movement History ---
      function loadMovementHistory() {
        const listDiv = document.getElementById('movement-history-list');
        const userEmail = document.getElementById('movement-history-user').value;
        
        if (!userEmail) {
          setStatus('movement-history-status', 'error', 'Please select a user to view their history.');
          return;
        }

        listDiv.innerHTML = '<p class="text-color-secondary">Loading history...</p>';
        setStatus('movement-history-status', 'processing', 'Loading history...');

        google.script.run
          .withSuccessHandler(history => {
            if (history.error) {
              setStatus('movement-history-status', 'error', history.error);
              listDiv.innerHTML = '';
              return;
            }
            if (history.length === 0) {
              setStatus('movement-history-status', 'success', 'No movement history found for this user.');
              listDiv.innerHTML = '';
              return;
            }

            let html = '';
            history.forEach(item => {
              let statusClass = '';
              if (item.status === 'Pending') statusClass = 'status-pending';
              if (item.status === 'Approved') statusClass = 'status-approved';
              if (item.status === 'Denied') statusClass = 'status-denied';

              html += `
                <div class="request-list-item">
                  <div class="item-details">
                    <p><strong>From:</strong> ${item.fromSupervisorName}</p>
                    <p><strong>To:</strong> ${item.toSupervisorName}</p>
                    <p class="text-color-secondary">Requested: ${formatDate(item.requestDate)} by ${item.requestedByName}</p>
                    ${item.status !== 'Pending' ? `
                      <p class="text-color-secondary" style="font-size: 0.9rem;">
                        <strong>Action:</strong> ${formatDate(item.actionDate)} by ${item.actionByName}
                      </p>
                    ` : ''}
                  </div>
                  <div class="item-actions">
                    <span class="status-badge ${statusClass}">${item.status}</span>
                  </div>
                </div>
              `;
            });
            listDiv.innerHTML = html;
            setStatus('movement-history-status', 'success', `Loaded ${history.length} records.`);
          })
          .withFailureHandler(err => {
            setStatus('movement-history-status', 'error', err.message);
            listDiv.innerHTML = '';
          })
          .webGetMovementHistory(userEmail);
      }

      // --- NEW: Coaching Functions ---

     
      
      const scoreOptions = [
        { text: "-- Select Score --", value: "null" },
        { text: "Got It (100%)", value: "1" },
        { text: "Getting There or Could be Better (50%)", value: "0.5" },
        { text: "Missed It (0%)", value: "0" }
      ];

      // *** NEW: Store last coaching data for export ***
      let lastCoachingData = [];

      /**
       * Calculates ISO week number.
       */
      function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        return weekNo;
      }

      /**
       * Updates the week number input when the date changes.
       */
      function updateWeekNumber() {
        const dateInput = document.getElementById('coaching-session-date');
        const weekInput = document.getElementById('coaching-week-number');
        if (dateInput.value) {
          const date = new Date(dateInput.value);
          // Adjust for local timezone offset to get correct UTC date for week calculation
          const userTimezoneOffset = date.getTimezoneOffset() * 60000;
          const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
          weekInput.value = 'Week ' + getWeekNumber(adjustedDate);
        } else {
          weekInput.value = '';
        }
      }

      /**
       * NEW: Dynamically builds the QA form from template data.
       */
      function populateCoachingForm(categories) {
        const formDiv = document.getElementById('quality-score-form');
        if (!formDiv) return;
        
        // Check for error or empty
        if (!categories || categories.length === 0) {
          formDiv.innerHTML = `<p class="status-message error visible">Could not load criteria for this template. Please check the 'CoachingTemplates' sheet.</p>`;
          calculateOverallScore(); // Reset score to N/A
          return;
        }
        
        let html = '';
        categories.forEach((cat, catIndex) => {
          html += `<div class="qa-category"><h4>${cat.category}</h4>`;
          
          cat.criteria.forEach((crit, critIndex) => {
            // We use the same ID structure as before so calculateOverallScore()
            // and submitNewCoaching() still work perfectly.
            html += `
              <div class="qa-criterion">
                <p>${crit}</p>
                <div class="qa-criterion-inputs">
                  <select id="qa-score-${catIndex}-${critIndex}" onchange="calculateOverallScore()">
                    ${scoreOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                  </select>
                  <textarea id="qa-comment-${catIndex}-${critIndex}" placeholder="Enter comments..."></textarea>
                </div>
              </div>
            `;
          });
          html += `</div>`;
        });
        formDiv.innerHTML = html;
        calculateOverallScore(); // Recalculate (which resets it)
      }


      /**
       * (REPLACED)
       * Calculates and displays the overall QA score by reading the dynamic form.
       */
      function calculateOverallScore() {
        let totalScore = 0;
        let totalPossible = 0;
        
        // Find all score <select> elements in the dynamic form
        const scoreSelects = document.querySelectorAll('#quality-score-form select[id^="qa-score-"]');
        
        scoreSelects.forEach(select => {
          if (select.value !== "null") {
            totalScore += parseFloat(select.value);
            totalPossible += 1; // Each item is worth 1 point max
          }
        });
        
        const scoreSpan = document.getElementById('coaching-overall-score');
        if (totalPossible === 0) {
          scoreSpan.textContent = 'N/A';
          return { score: 0, possible: 0, percentage: 0 };
        } else {
          const percentage = (totalScore / totalPossible) * 100;
          scoreSpan.textContent = `${percentage.toFixed(2)}%`;
          return { score: totalScore, possible: totalPossible, percentage: percentage };
        }
      }

      /**
 * LOAD COACHING TAB
 * 1. Fetches History
 * 2. Fetches Correct Hierarchy for Dropdown
 */
function loadMyCoaching() {
  setStatus('coaching-list-status', 'processing', 'Loading coaching data...');
  document.getElementById('export-coaching-btn').style.display = 'none';
  lastCoachingData = [];
  
  // 1. Load History (Existing Logic)
  google.script.run
    .withSuccessHandler(populateMyCoaching)
    .withFailureHandler(err => {
      setStatus('coaching-list-status', 'error', err.message);
    })
    .webGetCoachingHistory(null);

  // 2. Load Dropdown (Hierarchy Aware) & SHOW FORM
  if (selfRole === 'admin' || selfRole === 'superadmin' || selfRole === 'manager' || selfRole === 'project_manager') {
      const dropdownContainer = document.getElementById('coaching-agent-select-container');
      if (dropdownContainer) {
          dropdownContainer.innerHTML = '<span style="font-size:0.8rem; color:#666;">Loading team...</span>';
          
          google.script.run
            .withSuccessHandler(users => {
               if (users.length === 0) {
                   dropdownContainer.innerHTML = '<span style="font-size:0.8rem; color:#666;">No subordinates found.</span>';
               } else {
                   populateAdminDropdown(users, selfUserName, 'coaching-agent-select', 'Select User to Coach');
                   
                   // *** ADD THIS LINE TO UNHIDE THE FORM ***
                   document.getElementById('coaching-form-container').style.display = 'block';
               }
            })
            .withFailureHandler(err => {
               console.error("Failed to load coaching targets", err);
               dropdownContainer.innerHTML = '<span style="color:red;">Error loading team</span>';
            })
            .webGetCoachableUsers();
      }
  }
}

      /**
       * Renders the list of past coaching sessions.
       */
      function populateMyCoaching(sessions) {
        const listDiv = document.getElementById('coaching-list');
        if (sessions.error) {
          listDiv.innerHTML = `<p class="status-message error visible">${sessions.error}</p>`;
          setStatus('coaching-list-status', '', '');
          return;
        }
        if (!sessions || sessions.length === 0) {
          listDiv.innerHTML = '<p class="text-color-secondary">No coaching history found.</p>';
          setStatus('coaching-list-status', '', '');
          return;
        }
        
        // *** NEW: Store data for export and show button ***
        lastCoachingData = sessions;
        document.getElementById('export-coaching-btn').style.display = 'inline-block';
        
        let html = '';
        // Sort by session date, newest first
        sessions.sort((a, b) => new Date(b.sessionDate) - new Date(a.sessionDate));
        
        sessions.forEach(session => {
          let scoreDisplay = 'N/A';
          if (session.overallScore) {
             scoreDisplay = `${parseFloat(session.overallScore).toFixed(2)}%`;
          }
          
          let fuDate = session.followUpDate ? formatDate(session.followUpDate) : 'N/A';
          let fuStatus = session.followUpStatus || '';
          let fuHtml = '';

          // *** NEW: Better Follow-up Status Display ***
          if (fuStatus === 'Pending') {
            fuHtml = `<p><strong>Follow-up:</strong> <span class="status-badge status-pending" style="margin-top:0;">Pending (${fuDate})</span></p>`;
          } else if (fuStatus === 'Completed') {
            fuHtml = `<p><strong>Follow-up:</strong> <span class="status-badge status-approved" style="margin-top:0;">Completed (${fuDate})</span></p>`;
          } else if (fuStatus) { // e.g., "Postponed"
            fuHtml = `<p><strong>Follow-up:</strong> <span class="status-badge status-processing" style="margin-top:0;">${fuStatus} (${fuDate})</span></p>`;
          }
          // ********************************************

          // *** THIS IS THE SINGLE, CORRECTED BLOCK FOR THE BADGE ***
          let ackHtml = '';
          if (session.agentAcknowledgementTimestamp) {
            ackHtml = `<span class="status-badge status-approved" style="margin-left: 10px; font-size: 0.75rem; padding: 4px 8px;">Acknowledged</span>`;
          }
          // *** THE DUPLICATE BLOCK THAT WAS HERE IS NOW REMOVED ***

          html += `
            <div class="request-list-item">
              <div class="item-details">
                <h4>${session.agentName} - ${formatDate(session.sessionDate)} (${session.weekNumber}) ${ackHtml}</h4>
                <p><strong>Coach:</strong> ${session.coachName}</p>
                <p><strong>Overall Score:</strong> <strong style="color:var(--konecta-dark);">${scoreDisplay}</strong></p>
                ${session.followUpComment ?
                  `<p><strong>Comments:</strong> ${session.followUpComment}</p>` : ''}
                ${fuHtml} </div>
              <div class="item-actions">
                 <button type="button" class="view-btn" style="background-color: var(--konecta-blue); min-width: 120px;" 
                         onclick="showCoachingDetails('${session.sessionID}')">View Details</button>
              </div>
            </div>
          `;
        });
        
        listDiv.innerHTML = html;
        setStatus('coaching-list-status', '', ''); // Clear loading message
      }
      
      /**
       * *** NEW: Export Coaching History (Summary) ***
       */
      function exportCoachingHistory() {
        if (!lastCoachingData || lastCoachingData.length === 0) {
          setStatus('coaching-list-status', 'error', "No data to export.");
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "SessionID,AgentName,CoachName,SessionDate,WeekNumber,OverallScore,FollowUpComment,FollowUpDate,FollowUpStatus\r\n";
        
        lastCoachingData.forEach(session => {
          // Escape commas and quotes in comments
          const comment = `"${(session.followUpComment || "").replace(/"/g, '""')}"`;
          
          let row = [
            session.sessionID,
            session.agentName,
            session.coachName,
            formatDate(session.sessionDate),
            session.weekNumber,
            session.overallScore || 'N/A',
            comment,
            session.followUpDate ? formatDate(session.followUpDate) : 'N/A',
            session.followUpStatus || 'N/A'
          ].join(",");
          csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Coaching_History_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }

      /**
       * NEW: Loads the list of active template names into the dropdown.
       */
      function loadTemplateList() {
        const templateSelect = document.getElementById('coaching-template-select');
        
        google.script.run
          .withSuccessHandler(templates => {
            if (templates.error) {
              console.error(templates.error);
              return;
            }
            
            // Clear all but the first option
            while (templateSelect.options.length > 1) {
              templateSelect.remove(1);
            }
            
            templates.forEach(templateName => {
              const option = document.createElement('option');
              option.value = templateName;
              option.textContent = templateName;
              templateSelect.appendChild(option);
            });
            
          })
          .withFailureHandler(err => {
            console.error("Failed to load templates: " + err.message);
          })
          .webGetActiveTemplates();
      }

      /**
       * NEW: Triggered by the template dropdown. Fetches criteria and builds form.
       */
      function loadCoachingForm() {
        const templateName = document.getElementById('coaching-template-select').value;
        const formDiv = document.getElementById('quality-score-form');
        
        if (!templateName) {
          formDiv.innerHTML = ''; // Clear the form
          calculateOverallScore(); // Reset score
          return;
        }

        formDiv.innerHTML = '<p class="text-color-secondary">Loading coaching form...</p>';
        
        google.script.run
          .withSuccessHandler(populateCoachingForm) // Re-use our new function
          .withFailureHandler(err => {
            formDiv.innerHTML = `<p class="status-message error visible">Error: ${err.message}</p>`;
          })
          .webGetTemplateCriteria(templateName);
      }

      /**
       * (REPLACED)
       * Submits the new coaching session form by reading the dynamic form.
       */
      function submitNewCoaching() {
        try {
          // Get user data
          const agentSelect = document.getElementById('coaching-agent-select');
          const selectedEmail = agentSelect.value;
          if (!selectedEmail) throw new Error("Please select an agent.");
          
          const templateName = document.getElementById('coaching-template-select').value;
          if (!templateName) throw new Error("Please select a coaching template.");
          
          const sessionDate = document.getElementById('coaching-session-date').value;
          if (!sessionDate) throw new Error("Please select a session date.");
          
          const weekNumber = document.getElementById('coaching-week-number').value;
          const followUpComment = document.getElementById('coaching-follow-up').value;
          const followUpDate = document.getElementById('coaching-follow-up-date').value;

          // Gather scores by reading the dynamic form
          const scores = [];
          // Find all category blocks
          const categoryBlocks = document.querySelectorAll('#quality-score-form .qa-category');
          
          categoryBlocks.forEach((catBlock, catIndex) => {
            const categoryName = catBlock.querySelector('h4').textContent;
            
            // Find all criteria within this category
            const criteriaBlocks = catBlock.querySelectorAll('.qa-criterion');
            
            criteriaBlocks.forEach((critBlock, critIndex) => {
              const criteriaName = critBlock.querySelector('p').textContent;
              const score = document.getElementById(`qa-score-${catIndex}-${critIndex}`).value;
              const comment = document.getElementById(`qa-comment-${catIndex}-${critIndex}`).value;
              
              // Only save if a score was selected
              if (score !== "null") {
                scores.push({
                  category: categoryName,
                  criteria: criteriaName,
                  score: parseFloat(score),
                  comment: comment
                });
              }
            });
          });
          
          // Calculate final score
          const { percentage } = calculateOverallScore();
          
          const sessionObject = {
            agentEmail: selectedEmail,
            sessionDate: sessionDate,
            weekNumber: weekNumber,
            scores: scores,
            followUpComment: followUpComment,
            overallScore: percentage,
            followUpDate: followUpDate || null 
          };
          
          setStatus('coaching-submit-status', 'processing', `Saving session for ${agentSelect.options[agentSelect.selectedIndex].text}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('coaching-submit-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('coaching-submit-status', 'success', msg);
                
                // Reset form
                document.getElementById('coaching-agent-select').selectedIndex = 0;
                document.getElementById('coaching-template-select').selectedIndex = 0;
                document.getElementById('coaching-follow-up').value = '';
                document.getElementById('coaching-follow-up-date').value = '';
                document.getElementById('coaching-session-date').valueAsDate = new Date();
                
                updateWeekNumber();
                document.getElementById('quality-score-form').innerHTML = ''; // Clear dynamic form
                calculateOverallScore(); // Resets score display
                loadMyCoaching(); // Refresh the history list
              }
            })
            .withFailureHandler(err => {
              setStatus('coaching-submit-status', 'error', err.message);
            })
            .webSubmitCoaching(sessionObject);
        } catch (err) {
          setStatus('coaching-submit-status', 'error', err.message);
        }
      }
      
      

      // --- NEW: Coaching Detail Modal Functions ---

      let currentCoachingDetail = null; // Stores details for export

      function showCoachingDetails(sessionID) {
        // --- NEW: Debugging ---
        console.log("Attempting to load details for SessionID:", sessionID);
        if (!sessionID) {
          console.error("SessionID is undefined! Aborting.");
          return;
        }
        // --- End Debugging ---

        // 1. Show the modal
        document.getElementById('coaching-detail-modal-backdrop').style.display = 'block';
        document.getElementById('coaching-detail-modal').style.display = 'flex';
        
        // 2. Reset modal state
        const modalBody = document.getElementById('coaching-detail-modal-body');
        modalBody.innerHTML = '<p class="text-color-secondary">Loading details...</p>';
        document.getElementById('coaching-detail-export-btn').style.display = 'none';
        currentCoachingDetail = null;

        // 3. Fetch data
        google.script.run
          .withSuccessHandler(populateCoachingDetails)
          .withFailureHandler(err => {
            // --- NEW: Better Error Logging ---
            console.error("google.script.run FAILED:", err);
            modalBody.innerHTML = `<p class="status-message error visible">Error: ${err.message || 'The server call failed. Check the console (F12) for details.'}</p>`;
            // --- End Better Logging ---
          })
          .webGetCoachingSessionDetails(sessionID);
      }

      function closeCoachingDetails() {
        document.getElementById('coaching-detail-modal-backdrop').style.display = 'none';
        document.getElementById('coaching-detail-modal').style.display = 'none';
        document.getElementById('coaching-detail-modal-body').innerHTML = '';
        currentCoachingDetail = null;
      }

      function populateCoachingDetails(details) {
        // *** Add robust check for null/undefined ***
        if (!details) {
          document.getElementById('coaching-detail-modal-body').innerHTML = `<p class="status-message error visible">Error: Received no details from the server. The data might be corrupted or the server function failed silently.</p>`;
          return;
        }

        if (details.error) {
          document.getElementById('coaching-detail-modal-body').innerHTML = `<p class="status-message error visible">Error: ${details.error}</p>`;
          return;
        }

        currentCoachingDetail = details; // Save for export
        const summary = details.summary;
        const scores = details.scores;

        let scoreDisplay = summary.OverallScore ? `${parseFloat(summary.OverallScore).toFixed(2)}%` : 'N/A';
        let fuDate = summary.FollowUpDate ? formatDate(summary.FollowUpDate) : 'N/A';

        // *** NEW: Agent Acknowledgement Section ***
        let agentAckSection = '';
        if (selfRole === 'agent') {
          agentAckSection = `<hr class="section-divider"><div class="form-container" style="padding: 0;">`;
          
          if (summary.AgentAcknowledgementTimestamp) {
            // Agent has already acknowledged
            agentAckSection += `
              <div class="form-group" style="text-align: center;">
                <p style="font-size: 1.1rem; margin: 0;"><strong>Session Acknowledged</strong></p>
                <small class="text-color-secondary">on ${formatDate(summary.AgentAcknowledgementTimestamp)} at ${formatTime(summary.AgentAcknowledgementTimestamp)}</small>
              </div>
            `;
          } else {
            // Agent needs to acknowledge
            agentAckSection += `
              <div id="acknowledgement-status" class="status-message" style="margin-top: 0; margin-bottom: 15px;"></div>
              <p class="text-color-secondary" style="text-align: center; margin-top: 0;">Please review your coaching details and click below to confirm you have read and understood the session.</p>
              <button type="button" class="submit-btn-green" style="width: 100%; margin: 0;"
                      onclick="submitCoachingAcknowledgement('${summary.SessionID}')">Acknowledge Coaching Session</button>
            `;
          }
          agentAckSection += `</div>`;
        }
        // *** END NEW SECTION ***


        // *** Admin Follow-up Management Section ***
        let adminSection = '';
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          adminSection = `
            <hr class="section-divider">
            <h3 style="color: var(--konecta-blue); margin-top: 0;">Manage Follow-up</h3>
            <div class="form-container" style="padding: 0;">
              <div id="follow-up-status" class="status-message" style="margin-top: 0; margin-bottom: 15px;"></div>
              <div id="follow-up-controls" class="form-row" style="align-items: flex-end;">
                <div class="form-group">
                  <label for="follow-up-postpone-date">Postpone Date</label>
                  <input type="date" id="follow-up-postpone-date">
                </div>
                <div class="form-group">
                  <button type="button" class="view-btn" style="background-color: var(--status-pending-text); width: 100%; margin: 0;"
                          onclick="updateFollowUpStatus('${summary.SessionID}', 'Postponed')">Postpone</button>
                </div>
                <div class="form-group">
                  <button type="button" class="submit-btn-green" style="width: 100%; margin: 0;"
                          onclick="updateFollowUpStatus('${summary.SessionID}', 'Completed')">Mark Completed</button>
                </div>
              </div>
            </div>
          `;
        }
        // *** END SECTION ***


        let html = `
          <div class="dashboard-detail-item" style="background: var(--page-bg); grid-template-columns: 1fr 2fr; gap: 8px 15px;">
            <span class="detail-label">Agent:</span>
            <span class="detail-value" style="text-align: left;">${summary.AgentName}</span>
            
            <span class="detail-label">Coach:</span>
            <span class="detail-value" style="text-align: left;">${summary.CoachName}</span>
            
            <span class="detail-label">Session Date:</span>
            <span class="detail-value" style="text-align: left;">${formatDate(summary.SessionDate)} (${summary.WeekNumber})</span>
            
            <span class="detail-label">Overall Score:</span>
            <span class="detail-value" style="text-align: left; font-size: 1.1rem; color: var(--konecta-dark);">${scoreDisplay}</span>
            
            <span class="detail-label">Follow-up Date:</span>
            <span class="detail-value" style="text-align: left;">${fuDate}</span>
            
            <span class="detail-label">Follow-up Status:</span>
            <span class="detail-value" style="text-align: left;">${summary.FollowUpStatus || 'N/A'}</span>
            
            <span class="detail-label" style="grid-column: 1 / -1; margin-top: 10px;"><strong>Coach Comments:</strong></span>
            <p style="grid-column: 1 / -1; margin: 0; white-space: pre-wrap;">${summary.FollowUpComment || 'No comments provided.'}</p>
          </div>
          
          ${agentAckSection}

          ${adminSection}
          
          <hr class="section-divider">
          
          <h3 style="color: var(--konecta-blue); margin-top: 0;">Detailed Scores</h3>
        `;

        // Group scores by category
        const categories = {};
        scores.forEach(score => {
          if (!categories[score.Category]) {
            categories[score.Category] = [];
          }
          categories[score.Category].push(score);
        });

        // Build HTML for each category
        for (const categoryName in categories) {
          html += `
            <div class="qa-category" style="margin-top: 15px;">
              <h4>${categoryName}</h4>
              ${categories[categoryName].map(item => `
                <div class="qa-criterion">
                  <p style="margin: 0 0 10px 0;">${item.Criteria}</p>
                  <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <span class="status-badge status-approved" style="background-color: var(--konecta-dark); color: white; padding: 8px 15px; min-width: 80px; text-align: center;">Score: ${item.Score}</span>
                    <textarea readonly style="flex: 1; height: 60px; min-height: 40px; background: var(--card-bg);">${item.Comment || 'N/A'}</textarea>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        document.getElementById('coaching-detail-modal-body').innerHTML = html;
        document.getElementById('coaching-detail-export-btn').style.display = 'inline-block';
        
        // Set postpone date input to today
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const postponeDateEl = document.getElementById('follow-up-postpone-date');
          if (postponeDateEl) {
            postponeDateEl.valueAsDate = new Date();
          }
        }
      }
      
      /**
       * NEW: Export Individual Coaching Session Details
       */
      function exportSessionDetails() {
        if (!currentCoachingDetail) {
          alert("No coaching details are loaded to export.");
          return;
        }

        const summary = currentCoachingDetail.summary;
        const scores = currentCoachingDetail.scores;

        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Add Summary
        csvContent += "Session Summary\r\n";
        csvContent += `SessionID,"${summary.SessionID}"\r\n`;
        csvContent += `Agent,"${summary.AgentName}"\r\n`;
        csvContent += `Coach,"${summary.CoachName}"\r\n`;
        csvContent += `Date,"${formatDate(summary.SessionDate)}"\r\n`;
        csvContent += `Week,"${summary.WeekNumber}"\r\n`;
        csvContent += `Overall Score,"${summary.OverallScore || 'N/A'}"\r\n`;
        csvContent += `Follow-up Date,"${summary.FollowUpDate ? formatDate(summary.FollowUpDate) : 'N/A'}"\r\n`;
        csvContent += `Follow-up Status,"${summary.FollowUpStatus || 'N/A'}"\r\n`;
        csvContent += `Comments,"${(summary.FollowUpComment || '').replace(/"/g, '""')}"\r\n`;
        
        // Add Spacer
        csvContent += "\r\nDetailed Scores\r\n";
        
        // Add Detail Headers
        csvContent += "Category,Criteria,Score,Comment\r\n";

        // Add Detail Rows
        scores.forEach(item => {
          const category = `"${item.Category.replace(/"/g, '""')}"`;
          const criteria = `"${item.Criteria.replace(/"/g, '""')}"`;
          const score = item.Score;
          const comment = `"${(item.Comment || '').replace(/"/g, '""')}"`;
          csvContent += [category, criteria, score, comment].join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Coaching_Detail_${summary.AgentName}_${formatDate(summary.SessionDate)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function updateFollowUpStatus(sessionID, newStatus) {
        let newDate = null;
        
        if (newStatus === 'Postponed') {
          newDate = document.getElementById('follow-up-postpone-date').value;
          if (!newDate) {
            setStatus('follow-up-status', 'error', 'Please select a date to postpone to.');
            return;
          }
        }
        
        // Show processing status inside the modal
        setStatus('follow-up-status', 'processing', 'Updating status...');

        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              setStatus('follow-up-status', 'error', result.error);
            } else {
              setStatus('follow-up-status', 'success', result.message);
              // Refresh the main list
              loadMyCoaching();
              // Re-fetch details for the modal to show updated info
              showCoachingDetails(sessionID);
            }
          })
          .withFailureHandler(err => {
            setStatus('follow-up-status', 'error', err.message);
          })
          .webUpdateFollowUpStatus(sessionID, newStatus, newDate);
      }

      function submitCoachingAcknowledgement(sessionID) {
        // Show processing status inside the modal
        setStatus('acknowledgement-status', 'processing', 'Submitting acknowledgement...');

        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              setStatus('acknowledgement-status', 'error', result.error);
            } else if (result.success === false) {
              setStatus('acknowledgement-status', 'error', result.message);
            } else {
              setStatus('acknowledgement-status', 'success', result.message);
              // Refresh the main list
              loadMyCoaching();
              // Re-fetch details for the modal to show the updated status
              showCoachingDetails(sessionID);
            }
          })
          .withFailureHandler(err => {
            setStatus('acknowledgement-status', 'error', err.message);
          })
          .webSubmitCoachingAcknowledgement(sessionID);
      }


      // --- END Coaching Functions ---

      // [START] MODIFICATION 6: Add JS for Coaching Admin Tab

      let categoryCounter = 0;

      function addTemplateCategory() {
        categoryCounter++;
        const container = document.getElementById('template-categories-container');
        const newCategory = document.createElement('div');
        newCategory.className = 'template-category-block';
        newCategory.id = 'category-' + categoryCounter;
        newCategory.innerHTML = `
          <button type.="button" class="remove-category-btn" onclick="removeTemplateItem('category-${categoryCounter}')" title="Remove Category">&times;</button>
          <div class="form-group">
            <label for="category-name-${categoryCounter}">Category Name</label>
            <input type="text" id="category-name-${categoryCounter}" class="category-name-input" placeholder="e.g., 'Opening'">
          </div>
          <div class="template-criteria-container" id="criteria-container-${categoryCounter}">
            </div>
          <button type="button" class="view-btn" onclick="addTemplateCriteria(${categoryCounter})" style="background-color: var(--text-color-secondary); margin-top: 15px; padding: 8px 15px; font-size: 0.9rem;">+ Add Criteria</button>
        `;
        container.appendChild(newCategory);
      }

      function addTemplateCriteria(categoryIndex) {
        const container = document.getElementById('criteria-container-' + categoryIndex);
        const criteriaItem = document.createElement('div');
        criteriaItem.className = 'template-criteria-item';
        criteriaItem.innerHTML = `
          <input type="text" class="criteria-name-input" placeholder="e.g., 'Agent greeted customer'">
          <button type="button" class="remove-btn" onclick="removeTemplateItem(this.parentElement)">-</button>
        `;
        container.appendChild(criteriaItem);
      }

      function removeTemplateItem(elementOrId) {
        let elementToRemove;
        if (typeof elementOrId === 'string') {
          elementToRemove = document.getElementById(elementOrId);
        } else {
          elementToRemove = elementOrId;
        }
        if (elementToRemove) {
          elementToRemove.remove();
        }
      }

      function saveNewTemplate() {
        try {
          const templateName = document.getElementById('template-name').value.trim();
          if (!templateName) {
            throw new Error("Template Name is required.");
          }
          
          const categories = [];
          const categoryBlocks = document.querySelectorAll('.template-category-block');
          
          if (categoryBlocks.length === 0) {
            throw new Error("You must add at least one category.");
          }

          categoryBlocks.forEach(block => {
            const categoryName = block.querySelector('.category-name-input').value.trim();
            if (!categoryName) {
              throw new Error("All Category Names are required.");
            }
            
            const criteria = [];
            const criteriaInputs = block.querySelectorAll('.criteria-name-input');
            
            if (criteriaInputs.length === 0) {
              throw new Error(`Category '${categoryName}' must have at least one criterion.`);
            }
            
            criteriaInputs.forEach(input => {
              const criteriaName = input.value.trim();
              if (!criteriaName) {
                throw new Error("All Criteria fields are required.");
              }
              criteria.push(criteriaName);
            });
            
            categories.push({ name: categoryName, criteria: criteria });
          });
          
          setStatus('coaching-admin-status', 'processing', `Saving template '${templateName}'...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('coaching-admin-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('coaching-admin-status', 'success', msg);
                // Reset form
                document.getElementById('template-create-form').reset();
                document.getElementById('template-categories-container').innerHTML = '';
                categoryCounter = 0;
                // Reload the template list in the *other* tab
                loadTemplateList();
              }
            })
            .withFailureHandler(err => {
              setStatus('coaching-admin-status', 'error', err.message);
            })
            .webSaveNewTemplate(templateName, categories);

        } catch (err) {
          setStatus('coaching-admin-status', 'error', err.message);
        }
      }
// [END] MODIFICATION 6


      // *** NEW REGISTRATION JS ***

      function showSupervisorModal(allAdmins) {
        const directSelect = document.getElementById('reg-direct-manager');
        const funcSelect = document.getElementById('reg-functional-manager');
        
        let options = '<option value="">-- Select Manager --</option>';
        allAdmins.forEach(admin => {
          options += `<option value="${admin.email}">${admin.name} (${admin.role})</option>`;
        });

        directSelect.innerHTML = options;
        funcSelect.innerHTML = options;
        
        document.getElementById('supervisor-modal-backdrop').style.display = 'block';
        document.getElementById('supervisor-modal').style.display = 'flex';
      }

      function saveMyRegistration() {
        try {
          const formData = {
             phone: document.getElementById('reg-phone').value,
             address: document.getElementById('reg-address').value,
             directManager: document.getElementById('reg-direct-manager').value,
             functionalManager: document.getElementById('reg-functional-manager').value
          };

          if (!formData.phone || !formData.address) throw new Error("Address and Phone are required.");
          if (!formData.directManager || !formData.functionalManager) throw new Error("Both managers are required.");

          setStatus('supervisor-save-status', 'processing', 'Saving submission...');

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('supervisor-save-status', 'error', msg.replace('Error: ', ''));
              } else {
                document.getElementById('supervisor-modal-backdrop').style.display = 'none';
                document.getElementById('supervisor-modal').style.display = 'none';
                
                // Show the "pending" message on the main panel
                document.getElementById('punch-panel').innerHTML = `
                  <h2 style="color: var(--konecta-blue);">Registration Pending</h2>
                  <p class="text-color-secondary">${msg}</p>
                  <p class="text-color-secondary">Both of your selected managers must approve your request.</p>
                `;
              }
            })
            .withFailureHandler(err => {
              setStatus('supervisor-save-status', 'error', err.message);
            })
            .webSubmitFullRegistration(formData); // Call new function

        } catch (err) {
          setStatus('supervisor-save-status', 'error', err.message);
        }
      }
      // *** END: NEW SUPERVISOR MODAL FUNCTIONS ***

      // *** START: REGISTRATION WORKFLOW FUNCTIONS ***

      /**
       * Called for pending users to see if they need to be prompted
       */
      function loadMyRegistrationStatus() {
        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              console.error(result.error);
              return;
            }
            if (result.status === 'New' || result.status === 'Denied') {
              // User is pending but has no submission, or was denied.
              // Show the modal to (re-)submit.
              if(result.status === 'Denied') {
                 // Update modal text to show it was denied
                 document.getElementById('supervisor-modal').querySelector('p').innerText = 'Your previous supervisor selection was denied. Please select the correct supervisor from the list.';
              }
              showSupervisorModal(allAdminsList);
            }
            // If status is 'Pending', we do nothing. The main page message is already showing.
          })
          .webGetMyRegistrationStatus();
      }

      /**
       * Called by superadmin clicking the "Registration Admin" tab.
       */
      function loadRegistrationAdmin() {
  setStatus('registration-admin-status', 'processing', 'Loading pending registrations...');
  const listDiv = document.getElementById('registration-admin-list');
  listDiv.innerHTML = '';

  google.script.run
    .withSuccessHandler(requests => {
      if (requests.error) {
        setStatus('registration-admin-status', 'error', requests.error);
        return;
      }
      if (requests.length === 0) {
        setStatus('registration-admin-status', 'success', 'No pending registrations requiring your action.');
        return;
      }
      
      setStatus('registration-admin-status', 'success', `Loaded ${requests.length} pending requests.`);
      
      let html = '';
      requests.forEach(req => {
        // Logic to show Date Input (Step 1) OR Read-only Date (Step 2)
        let dateInputHtml = '';
        const isStep1 = req.approverRole === 'Direct';
        const isStep2 = req.approverRole === 'Functional';
        const inputId = `hiring-date-${req.requestID}`;
        const defaultDate = req.hiringDate || new Date().toISOString().split('T')[0];

        if (isStep1) {
           // Direct Manager: Must Input Date
           dateInputHtml = `
             <div class="form-group" style="margin: 15px 0 0 0; background: #fff; padding: 10px; border: 1px solid var(--konecta-blue); border-radius: 4px;">
               <label for="${inputId}" style="font-weight: 600; color: var(--konecta-blue);">Step 1: Set Hiring Date (Required)</label>
               <input type="date" id="${inputId}" value="${defaultDate}" style="width: 100%;">
             </div>`;
        } else if (isStep2) {
           // Project Manager: Review Date
           dateInputHtml = `
             <div class="form-group" style="margin: 15px 0 0 0; background: #f0fdf4; padding: 10px; border: 1px solid var(--status-success-text); border-radius: 4px;">
               <label style="font-weight: 600; color: var(--status-success-text);">Step 2: Review Hiring Date</label>
               <input type="date" id="${inputId}" value="${defaultDate}" readonly style="width: 100%; background: #e6fffa; cursor: not-allowed;">
               <small>Set by Direct Manager. Approve to finalize account.</small>
             </div>`;
        }

        html += `
          <div class="request-list-item">
            <div class="item-details">
              <h4>${req.userName}</h4>
              <p><strong>Email:</strong> ${req.userEmail}</p>
              <p><strong>Action Required:</strong> <span style="color:var(--konecta-blue); font-weight:bold;">${req.otherStatus}</span></p>
              <p class="text-color-secondary">Submitted: ${req.timestamp}</p>
              ${dateInputHtml}
            </div>
            <div class="item-actions">
              <button class="approve-btn" onclick="approveDenyRegistration('${req.requestID}', '${req.userEmail}', '', 'Approved', '${inputId}')">Approve</button>
              <button class="deny-btn" onclick="approveDenyRegistration('${req.requestID}', '${req.userEmail}', '', 'Denied', null)">Deny</button>
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;
    })
    .withFailureHandler(err => {
      setStatus('registration-admin-status', 'error', err.message);
    })
    .webGetPendingRegistrations();
}

      // REPLACE this function in your <script> tag
function approveDenyRegistration(requestID, userEmail, supervisorEmail, newStatus, dateInputId) {
  const runAction = (hiringDateStr) => {
    setStatus('registration-admin-status', 'processing', `Processing ${newStatus}...`);

    google.script.run
      .withSuccessHandler(result => {
        if (result.error) {
          setStatus('registration-admin-status', 'error', result.error);
        } else {
          setStatus('registration-admin-status', 'success', result.message);
          loadRegistrationAdmin(); // Refresh list
        }
      })
      .withFailureHandler(err => {
        setStatus('registration-admin-status', 'error', err.message);
      })
      .webApproveDenyRegistration(requestID, userEmail, supervisorEmail, newStatus, hiringDateStr);
  };

  if (newStatus === 'Approved') {
    // Logic: Read date if the input exists
    let hiringDateStr = null;
    if (dateInputId) {
       hiringDateStr = document.getElementById(dateInputId).value;
       if (!hiringDateStr) {
         setStatus('registration-admin-status', 'error', 'Hiring Date is missing.');
         return;
       }
    }
    
    showCustomConfirm(
      `Are you sure you want to APPROVE ${userEmail}?`,
      'Approve',
      'approve-btn',
      () => runAction(hiringDateStr)
    );
    
  } else {
    showCustomConfirm(
      `Are you sure you want to DENY ${userEmail}?`,
      'Deny',
      'deny-btn',
      () => runAction(null)
    );
  }
}
      
      // *** END: REGISTRATION WORKFLOW FUNCTIONS ***
      // *** START: CUSTOM CONFIRM MODAL FUNCTIONS ***
      
      // A variable to hold the callback function
      let _onConfirmCallback = null;

      function showCustomConfirm(message, confirmText = 'Confirm', confirmClass = 'submit-btn-green', onConfirm = null) {
        // Set modal content
        document.getElementById('confirm-modal-message').innerText = message;
        
        const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
        confirmBtn.innerText = confirmText;
        
        // Set button style (e.g., 'deny-btn' for red, 'submit-btn-green' for green)
        confirmBtn.className = ''; // Reset classes
        confirmBtn.classList.add(confirmClass); // Add the specific class
        
        // Store the callback
        _onConfirmCallback = onConfirm;

        // Set the click handler for the confirm button
        confirmBtn.onclick = () => {
          if (typeof _onConfirmCallback === 'function') {
            _onConfirmCallback();
          }
          hideCustomConfirm();
        };

        // Show the modal
        document.getElementById('confirm-modal-backdrop').style.display = 'block';
        document.getElementById('confirm-modal').style.display = 'flex';
      }

      function hideCustomConfirm() {
        document.getElementById('confirm-modal-backdrop').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'none';
        _onConfirmCallback = null; // Clear the callback
      }
      // *** END: CUSTOM CONFIRM MODAL FUNCTIONS ***

      // *** ADD THESE FUNCTIONS ***
      function showRoleRequestModal() {
        // Reset form status
        setStatus('admin-request-status', '', '');
        document.getElementById('admin-request-form').reset();
        document.getElementById('role-request-modal-backdrop').style.display = 'block';
        document.getElementById('role-request-modal').style.display = 'flex';
      }

      function hideRoleRequestModal() {
        document.getElementById('role-request-modal-backdrop').style.display = 'none';
        document.getElementById('role-request-modal').style.display = 'none';
      }

      function showRoleApprovalModal() {
  // This is the Superadmin modal
  document.getElementById('role-approval-modal-backdrop').style.display = 'block';
  document.getElementById('role-approval-modal').style.display = 'flex';
  loadRoleRequests(); // Load the list of requests
}

function hideRoleApprovalModal() {
  document.getElementById('role-approval-modal-backdrop').style.display = 'none';
  document.getElementById('role-approval-modal').style.display = 'none';
}

function loadRoleRequests() {
  setStatus('role-approval-status', 'processing', 'Loading pending requests...');
  const listDiv = document.getElementById('role-request-list');
  listDiv.innerHTML = '';

  google.script.run
    .withSuccessHandler(requests => {
      if (requests.error) {
        setStatus('role-approval-status', 'error', requests.error);
        return;
      }
      if (requests.length === 0) {
        listDiv.innerHTML = '<p class="text-color-secondary">No pending role requests.</p>';
        setStatus('role-approval-status', '', ''); // Clear loading
        // Remove notification badge
        document.getElementById('header-role-request-button').classList.remove('has-notification');
        return;
      }

      let html = '';
      requests.forEach(req => {
        html += `
          <div class="request-list-item">
            <div class="item-details">
              <h4>${req.userName}</h4>
              <p><strong>Email:</strong> ${req.userEmail}</p>
              <p><strong>Request:</strong> ${req.currentRole} ‚ûî <strong>${req.requestedRole}</strong></p>
              <p><strong>Justification:</strong> ${req.justification}</p>
              <p class="text-color-secondary"><strong>Submitted:</strong> ${formatDate(req.timestamp)}</p>
            </div>
            <div class="item-actions">
              <button class="approve-btn" onclick="approveDenyRoleRequest('${req.requestID}', 'Approved')">Approve</button>
              <button class="deny-btn" onclick="approveDenyRoleRequest('${req.requestID}', 'Denied')">Deny</button>
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;
      setStatus('role-approval-status', 'success', `Loaded ${requests.length} requests.`);
    })
    .withFailureHandler(err => {
      setStatus('role-approval-status', 'error', err.message);
    })
    .webGetRoleRequests();
}

function approveDenyRoleRequest(requestID, newStatus) {
  const runAction = () => {
    setStatus('role-approval-status', 'processing', `Processing ${newStatus}...`);

    google.script.run
      .withSuccessHandler(result => {
        if (result.error) {
          setStatus('role-approval-status', 'error', result.error);
        } else {
          setStatus('role-approval-status', 'success', result.message);
          loadRoleRequests(); // Refresh the list
        }
      })
      .withFailureHandler(err => {
        setStatus('role-approval-status', 'error', err.message);
      })
      .webApproveDenyRoleRequest(requestID, newStatus);
  };

  // Show a confirmation before doing anything
  const message = newStatus === 'Approved' ? 'Are you sure you want to approve this role upgrade?' : 'Are you sure you want to deny this request?';
  const buttonClass = newStatus === 'Approved' ? 'submit-btn-green' : 'deny-btn';

  showCustomConfirm(message, newStatus, buttonClass, runAction);
}
// *** END OF NEW FUNCTIONS ***



      // ===================================
      // === ANNOUNCEMENTS MODULE (JS) ===
      // ===================================

// For users to see the banner
function loadAnnouncements() {
  google.script.run
    .withSuccessHandler(renderAnnouncementsBanner)
    .withFailureHandler(err => console.error("Failed to load announcements:", err))
    .webGetAnnouncements();
}

function renderAnnouncementsBanner(announcements) {
  const container = document.getElementById('announcement-banner-container');
  const contentArea = document.getElementById('announcement-content-area');
  
  if (announcements && announcements.length > 0) {
    // We removed the sessionStorage check here.
    
    // Using <pre> preserves line breaks from the textarea
    let html = announcements.map(a => 
      `<pre style="font-family: 'Inter', Arial, sans-serif; margin: 0 0 10px 0; white-space: pre-wrap;">- ${a.content}</pre>`
    ).join('');
    
    contentArea.innerHTML = html;
    container.style.display = 'block'; // Always show it if announcements exist
  } else {
    container.style.display = 'none';
  }
}

function dismissAnnouncements() {
  document.getElementById('announcement-banner-container').style.display = 'none';
  // We no longer set sessionStorage, so it will reappear on refresh
}

// For superadmins to manage them
function loadAnnouncements_Admin() {
  setStatus('announcement-admin-status', 'processing', 'Loading announcements...');
  google.script.run
    .withSuccessHandler(renderAnnouncementsAdmin)
    .withFailureHandler(err => setStatus('announcement-admin-status', 'error', err.message))
    .webGetAnnouncements_Admin();
}

function renderAnnouncementsAdmin(announcements) {
  const listDiv = document.getElementById('announcement-admin-list');
  if (announcements.error) {
    setStatus('announcement-admin-status', 'error', announcements.error);
    listDiv.innerHTML = '';
    return;
  }

  if (!announcements || announcements.length === 0) {
    listDiv.innerHTML = '<p class="text-color-secondary">No announcements found.</p>';
    setStatus('announcement-admin-status', '', '');
    return;
  }

  let html = '';
  // Sort by timestamp, newest first
  announcements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  announcements.forEach(a => {
    const statusClass = a.status === 'Active' ? 'status-approved' : 'status-pending';
    // Escape content for safe insertion into an HTML onclick attribute
    const escapedContent = a.content.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\r\n|\r|\n/g, '\\n');

    html += `
      <div class="request-list-item">
        <div class="item-details">
          <pre style="font-family: 'Inter', Arial, sans-serif; margin: 0; white-space: pre-wrap;">${a.content}</pre>
          <small class="text-color-secondary">By: ${a.createdBy} on ${formatDate(a.timestamp)}</small>
        </div>
        <div class="item-actions" style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end; min-width: 120px;">
          <span class="status-badge ${statusClass}">${a.status}</span>
          <div style="margin-top: 5px;">
            <button class="view-btn" style="background-color: var(--konecta-blue); padding: 5px 10px; font-size: 0.9rem; margin: 0 5px;" onclick="editAnnouncement('${a.id}', '${escapedContent}', '${a.status}')">Edit</button>
            <button class="deny-btn" style="padding: 5px 10px; font-size: 0.9rem; margin: 0;" onclick="deleteAnnouncement('${a.id}')">Delete</button>
          </div>
        </div>
      </div>
    `;
  });
  listDiv.innerHTML = html;
  setStatus('announcement-admin-status', '', '');
}

function clearAnnouncementForm() {
  document.getElementById('announcement-id').value = '';
  document.getElementById('announcement-content').value = '';
  document.getElementById('announcement-status').value = 'Active';
  setStatus('announcement-admin-status', '', '');
}

function editAnnouncement(id, content, status) {
  document.getElementById('announcement-id').value = id;
  // Handle escaped quotes and newlines from the onclick string
  const unescapedContent = content.replace(/&quot;/g, '"').replace(/\\n/g, '\n');
  document.getElementById('announcement-content').value = unescapedContent;
  document.getElementById('announcement-status').value = status;

  // Scroll to the top of the main container to show the form
  document.querySelector('main').scrollTo(0, 0); 
}

function saveAnnouncement() {
  const announcement = {
    id: document.getElementById('announcement-id').value || null,
    content: document.getElementById('announcement-content').value,
    status: document.getElementById('announcement-status').value
  };

  if (!announcement.content || announcement.content.trim() === "") {
    setStatus('announcement-admin-status', 'error', 'Content cannot be empty.');
    return;
  }

  setStatus('announcement-admin-status', 'processing', 'Saving...');

  google.script.run
    .withSuccessHandler(result => {
      if (result.error) {
        setStatus('announcement-admin-status', 'error', result.error);
      } else {
        setStatus('announcement-admin-status', 'success', 'Announcement saved!');
        clearAnnouncementForm();
        loadAnnouncements_Admin(); // Refresh admin list
        loadAnnouncements(); // Refresh user banner
      }
    })
    .withFailureHandler(err => setStatus('announcement-admin-status', 'error', err.message))
    .webSaveAnnouncement(announcement);
}

function deleteAnnouncement(id) {
  // Use the existing custom confirm modal
  showCustomConfirm(
    'Are you sure you want to permanently delete this announcement?',
    'Delete',
    'deny-btn',
    () => { // This is the onConfirm callback
      setStatus('announcement-admin-status', 'processing', 'Deleting...');
      google.script.run
        .withSuccessHandler(result => {
          if (result.error) {
            setStatus('announcement-admin-status', 'error', result.error);
          } else {
            setStatus('announcement-admin-status', 'success', 'Announcement deleted.');
            loadAnnouncements_Admin(); // Refresh admin list
            loadAnnouncements(); // Refresh user banner
          }
        })
        .withFailureHandler(err => setStatus('announcement-admin-status', 'error', err.message))
        .webDeleteAnnouncement(id);
    }
  );
}

// --- Profile Functions ---

// [index.html] REPLACE loadMyProfile, saveProfile, and ADD switchProfileSubTab

function switchProfileSubTab(tabName) {
  // Hide all views
  document.querySelectorAll('.profile-subview').forEach(el => el.style.display = 'none');
  // Remove active class from buttons
  document.querySelectorAll('#profile-panel .btn-secondary').forEach(btn => btn.classList.remove('active'));
  
  // Show selected
  document.getElementById('prof-view-' + tabName).style.display = 'block';
  document.getElementById('btn-prof-' + tabName).classList.add('active');

  if (tabName === 'docs') loadMyDocuments();
}

function loadMyProfile() {
  setStatus('profile-status', 'processing', 'Loading profile data...');
  
  google.script.run
    .withSuccessHandler(data => {
      setStatus('profile-status', '', ''); 
      const c = data.core;
      const p = data.pii;

      // --- General Tab ---
      document.getElementById('prof-name').value = c.name;
      document.getElementById('prof-id').value = c.empID || 'N/A';
      document.getElementById('prof-email').value = c.email;
      document.getElementById('prof-personal-email').value = p.personalEmail || '';
      document.getElementById('prof-phone').value = p.phone || '';
      document.getElementById('prof-address').value = p.address || '';
      document.getElementById('prof-emergency').value = p.emergencyContact || '';
      document.getElementById('prof-relation').value = p.emergencyRelation || '';

      // --- Contract Tab ---
      // Note: You might need to ensure 'role', 'supervisor', etc are passed correctly in data.core
      // Since we didn't strictly map "Contract Type" in the return object yet, 
      // you might see empty fields here unless we update webGetMyProfile to return raw row data.
      // For now, let's map what we definitely have.
      
      document.getElementById('prof-direct-mgr').value = c.supervisor || '';
      document.getElementById('prof-proj-mgr').value = c.projectManager || '';
      document.getElementById('prof-hiring').value = p.hiringDate || '';
      
      // Confidential: Salary (Hide if empty or restricted)
      if (p.salary) {
         document.getElementById('prof-salary').value = p.salary;
      } else {
         document.getElementById('prof-salary').value = "Confidential";
      }
      document.getElementById('prof-iban').value = p.iban || '';

      // --- Personal Tab ---
      document.getElementById('prof-nat-id').value = p.nationalId || '';
      document.getElementById('prof-social').value = p.socialInsurance || '';
      document.getElementById('prof-dob').value = p.birthDate || '';
      document.getElementById('prof-age').value = p.age || '';
      document.getElementById('prof-marital').value = p.maritalStatus || '';
      document.getElementById('prof-dependents').value = p.dependents || '';

    })
    .withFailureHandler(err => {
      setStatus('profile-status', 'error', err.message);
    })
    .webGetMyProfile();
}

function saveProfile() {
  const sensitiveFields = ['iban', 'nationalId']; // Add fields that require approval
  
  // 1. Handle Standard Updates (Phone, Address, etc. - if you allow direct update)
  // For Phase 2 compliance, let's say ALL changes might need approval, 
  // or at least IBAN. Let's assume Address/Phone are still direct for now 
  // but IBAN triggers the new flow.
  
  const iban = document.getElementById('prof-iban').value;
  const originalIban = document.getElementById('prof-iban').getAttribute('data-original'); // You need to store original on load

  if (iban && iban !== originalIban) {
     if(confirm("Changing IBAN requires HR approval. Submit request?")) {
        google.script.run
          .withSuccessHandler(alert)
          .webSubmitDataChangeRequest('IBAN', iban, "User Request via Profile");
     }
  }
  
  
  
  const formData = {
    phone: document.getElementById('prof-phone').value,
    address: document.getElementById('prof-address').value,
    personalEmail: document.getElementById('prof-personal-email').value,
    emergencyContact: document.getElementById('prof-emergency').value,
    emergencyRelation: document.getElementById('prof-relation').value,
    iban: document.getElementById('prof-iban').value
  };

  setStatus('profile-status', 'processing', 'Saving changes...');
  
  google.script.run
    .withSuccessHandler(msg => {
      setStatus('profile-status', 'success', msg);
    })
    .withFailureHandler(err => {
      setStatus('profile-status', 'error', err.message);
    })
    .webUpdateProfile(formData);
}

function switchProfileView(viewName) {
  // Hide all
  document.getElementById('profile-view-details').style.display = 'none';
  document.getElementById('profile-view-documents').style.display = 'none';
  document.getElementById('profile-view-warnings').style.display = 'none';

  // Show selected
  document.getElementById('profile-view-' + viewName).style.display = 'block';

  // Load data if needed
  if (viewName === 'documents') loadMyDocuments();
  if (viewName === 'warnings') loadMyWarnings();
}

function loadMyDocuments() {
  const container = document.getElementById('doc-list-container');
  container.innerHTML = '<p class="text-color-secondary">Scanning Drive folders...</p>';
  
  google.script.run
    .withSuccessHandler(files => {
      if (files.length === 0) {
        container.innerHTML = '<p class="text-color-secondary">No documents found in your employee folder.</p>';
        return;
      }
      let html = '';
      files.forEach(f => {
        let icon = 'üìÑ';
        if (f.type.includes('Payslip')) icon = 'üí∞';
        if (f.type.includes('Onboarding')) icon = 'ü§ù';
        
        html += `
          <div class="request-list-item">
            <div class="item-details">
              <h4>${icon} ${f.name}</h4>
              <p class="text-color-secondary">Folder: ${f.type} | Date: ${formatDate(f.date)}</p>
            </div>
            <div class="item-actions">
              <a href="${f.url}" target="_blank" class="view-btn" style="text-decoration:none; padding: 6px 12px; display:inline-block;">Open</a>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    })
    .withFailureHandler(err => container.innerHTML = `<p class="status-message error visible">${err.message}</p>`)
    .webGetMyDocuments();
}

function loadMyWarnings() {
  const container = document.getElementById('warning-list-container');
  container.innerHTML = '<p class="text-color-secondary">Checking records...</p>';

  google.script.run
    .withSuccessHandler(warnings => {
      if (warnings.length === 0) {
        container.innerHTML = '<p class="status-message success visible" style="background-color:var(--status-success-bg); color:var(--status-success-text);">No active warnings. Keep up the good work!</p>';
        return;
      }
      let html = '';
      warnings.forEach(w => {
        html += `
          <div class="request-list-item" style="border-left: 4px solid var(--status-error-text);">
            <div class="item-details">
              <h4 style="color: var(--status-error-text);">${w.type} (${w.level})</h4>
              <p><strong>Date:</strong> ${w.date}</p>
              <p>${w.description}</p>
            </div>
            <div class="item-actions">
              <span class="status-badge status-denied">${w.status}</span>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    })
    .withFailureHandler(err => container.innerHTML = `<p class="status-message error visible">${err.message}</p>`)
    .webGetMyWarnings();
}


// --- PHASE 3 JS FUNCTIONS ---

function loadProjectsDropdown() {
  // 1. Punch Clock Project Select
  const selectPunch = document.getElementById('current-project-select');
  // 2. Project Admin Dashboard Select
  const selectAdmin = document.getElementById('project-admin-select');
  
  google.script.run
    .withSuccessHandler(projects => {
      const buildOptions = (sel) => {
          if (!sel) return;
          sel.innerHTML = '<option value="">-- Select Project --</option>';
          if (projects.length === 0) {
             const opt = document.createElement('option');
             opt.text = "(No projects available)";
             opt.disabled = true;
             sel.appendChild(opt);
          } else {
             projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.name;
                sel.appendChild(opt);
             });
          }
      };

      buildOptions(selectPunch);
      buildOptions(selectAdmin);
    })
    .withFailureHandler(err => {
      console.error("Project Load Error:", err);
    })
    .webGetProjects();
}

function saveProject() {
  const data = {
    name: document.getElementById('proj-name').value,
    manager: document.getElementById('proj-manager').value
  };
  setStatus('project-status', 'processing', 'Saving...');
  google.script.run
    .withSuccessHandler(msg => {
      setStatus('project-status', 'success', msg);
      document.getElementById('project-form').reset();
      loadProjectsDropdown(); // Refresh dropdown
    })
    .withFailureHandler(err => setStatus('project-status', 'error', err.message))
    .webSaveProject(data);
}



// ==========================================
      // === PHASE 4: RECRUITMENT JS FUNCTIONS ===
      // ==========================================

      function loadCandidates() {
        const list = document.getElementById('candidate-list');
        list.innerHTML = '<p class="text-color-secondary">Loading...</p>';
        
        google.script.run
          .withSuccessHandler(candidates => {
            if (candidates.length === 0) {
              list.innerHTML = '<p class="text-color-secondary">No candidates found.</p>';
              return;
            }
            let html = '';
            candidates.forEach(c => {
              let actionButtons = '';
              if (c.status !== 'Hired' && c.status !== 'Rejected') {
                actionButtons = `
                  <button class="view-btn" style="padding:5px 10px; font-size:0.8rem;" onclick="updateCandidate('${c.id}', 'Active', 'Interview 1')">Interview 1</button>
                  <button class="submit-btn-green" style="padding:5px 10px; font-size:0.8rem;" onclick="hireCandidate('${c.id}', '${c.name}')">HIRE</button>
                  <button class="deny-btn" style="padding:5px 10px; font-size:0.8rem;" onclick="updateCandidate('${c.id}', 'Rejected', 'Rejected')">Reject</button>
                `;
              } else {
                actionButtons = `<span class="status-badge ${c.status === 'Hired' ? 'status-approved' : 'status-denied'}">${c.status}</span>`;
              }

              html += `
                <div class="request-list-item">
                  <div class="item-details">
                    <h4>${c.name} <span class="text-color-secondary" style="font-size:0.9rem; font-weight:400;">(${c.position})</span></h4>
                    <p><strong>Email:</strong> ${c.email}</p>
                    <p><strong>CV:</strong> <a href="${c.cv}" target="_blank">View CV</a></p>
                    <p><strong>Stage:</strong> ${c.stage} | <strong>Applied:</strong> ${formatDate(c.date)}</p>
                  </div>
                  <div class="item-actions" style="display:flex; flex-direction:column; gap:5px;">
                    ${actionButtons}
                  </div>
                </div>
              `;
            });
            list.innerHTML = html;
          })
          .withFailureHandler(err => setStatus('recruitment-status', 'error', err.message))
          .webGetCandidates();
      }

      function updateCandidate(id, status, stage) {
        setStatus('recruitment-status', 'processing', 'Updating...');
        google.script.run
          .withSuccessHandler(() => {
            setStatus('recruitment-status', 'success', 'Updated successfully.');
            loadCandidates();
          })
          .webUpdateCandidateStatus(id, status, stage);
      }

      function hireCandidate(id, name) {
        if(!confirm(`Are you sure you want to HIRE ${name}? This will create their employee account and folders.`)) return;
        
        setStatus('recruitment-status', 'processing', 'Hiring candidate & creating assets...');
        google.script.run
          .withSuccessHandler(msg => {
            setStatus('recruitment-status', 'success', msg);
            loadCandidates();
          })
          .withFailureHandler(err => setStatus('recruitment-status', 'error', err.message))
          .webHireCandidate(id);
      }

      // ====================================
// === PHASE 3: RECRUITMENT JS ===
// ====================================

function loadRecruitmentAdmin() {
  const list = document.getElementById('candidate-list');
  list.innerHTML = '<p class="text-color-secondary">Loading pipeline...</p>';
  
  google.script.run
    .withSuccessHandler(candidates => {
      if (candidates.length === 0) {
        list.innerHTML = '<p class="text-color-secondary">No candidates found.</p>';
        return;
      }
      
      let html = '';
      candidates.forEach(c => {
        // Badge Color Logic
        let badgeClass = 'status-pending';
        if(c.status === 'Hired') badgeClass = 'status-approved';
        if(c.status === 'Rejected') badgeClass = 'status-denied';

        // Action Buttons
        let actions = '';
        if (c.status !== 'Hired') {
          actions = `
            <div style="display:flex; gap:5px; margin-top:10px;">
              <button class="view-btn" onclick="updateCandidateStatus('${c.id}', 'Active', 'Interview 1')">Interview 1</button>
              <button class="view-btn" onclick="updateCandidateStatus('${c.id}', 'Active', 'Offer Sent')">Offer Sent</button>
              <button class="submit-btn-green" onclick="openHireModal('${c.id}', '${c.name}', '${c.email}', '${c.phone}', '${c.nationalId}')">HIRE</button>
              <button class="deny-btn" onclick="updateCandidateStatus('${c.id}', 'Rejected', 'Rejected')">Reject</button>
            </div>
          `;
        } else {
          actions = `<p style="color:green; font-weight:bold; margin-top:10px;">‚úÖ Employee Created</p>`;
        }

        html += `
          <div class="request-list-item candidate-item">
            <div class="item-details">
              <h4>${c.name} <span class="text-color-secondary">(${c.position})</span></h4>
              <p><strong>Email:</strong> ${c.email} | <strong>Phone:</strong> ${c.phone}</p>
              <p><strong>Applied:</strong> ${c.date} | <strong>Stage:</strong> ${c.stage}</p>
              <p><a href="${c.cv}" target="_blank" style="color:var(--konecta-blue);">View CV</a></p>
            </div>
            <div class="item-actions">
              <span class="status-badge ${badgeClass}">${c.status}</span>
              ${actions}
            </div>
          </div>
        `;
      });
      list.innerHTML = html;
    })
    .withFailureHandler(err => list.innerHTML = `<p class="status-message error visible">${err.message}</p>`)
    .webGetCandidates();
}

// --- REQUISITION LOGIC ---
function showRequisitionModal() {
  document.getElementById('req-modal-backdrop').style.display = 'block';
  document.getElementById('req-modal').style.display = 'flex';
}

function closeReqModal() {
  document.getElementById('req-modal-backdrop').style.display = 'none';
  document.getElementById('req-modal').style.display = 'none';
}

function submitRequisition() {
  const data = {
    title: document.getElementById('req-title').value,
    department: document.getElementById('req-dept').value,
    hiringManager: document.getElementById('req-manager').value,
    description: document.getElementById('req-desc').value
  };
  
  if(!data.title || !data.hiringManager) {
    alert("Title and Hiring Manager are required.");
    return;
  }

  // Disable button
  const btn = document.querySelector('#req-modal .btn-primary');
  btn.innerText = "Creating...";
  btn.disabled = true;

  google.script.run
    .withSuccessHandler(msg => {
      alert(msg);
      closeReqModal();
      btn.innerText = "Open Position";
      btn.disabled = false;
    })
    .webCreateRequisition(data);
}

// --- CANDIDATE UPDATE LOGIC ---
function updateCandidateStatus(id, status, stage) {
  if(!confirm(`Change status to ${stage}?`)) return;
  
  google.script.run
    .withSuccessHandler(() => {
      loadRecruitmentAdmin(); // Refresh list
    })
    .webUpdateCandidateStatus(id, status, stage);
}

// --- HIRING WIZARD LOGIC ---
function openHireModal(id, name, email, phone, natId) {
  document.getElementById('hire-candidate-id').value = id;
  document.getElementById('hire-fullname').value = name;
  document.getElementById('hire-nat-id').value = natId || ""; // Pre-fill if available
  
  // Pre-fill personal email as a fallback, IT usually creates a new one
  // document.getElementById('hire-k-email').value = ""; 
  
  document.getElementById('hire-modal-backdrop').style.display = 'block';
  document.getElementById('hire-modal').style.display = 'flex';
}

function closeHireModal() {
  document.getElementById('hire-modal-backdrop').style.display = 'none';
  document.getElementById('hire-modal').style.display = 'none';
  setStatus('hire-status', '', '');
}

function submitHire() {
  const candidateId = document.getElementById('hire-candidate-id').value;
  
  // Gather all fields
  const hiringData = {
    fullName: document.getElementById('hire-fullname').value,
    konectaEmail: document.getElementById('hire-k-email').value,
    title: document.getElementById('hire-title').value,
    department: document.getElementById('hire-dept').value,
    jobLevel: document.getElementById('hire-level').value,
    contractType: document.getElementById('hire-contract').value,
    hiringDate: document.getElementById('hire-date').value,
    
    directManager: document.getElementById('hire-direct-mgr').value,
    projectManager: document.getElementById('hire-project-mgr').value,
    dottedManager: document.getElementById('hire-dotted-mgr').value,
    
    salary: document.getElementById('hire-salary').value,
    hourlyRate: document.getElementById('hire-hourly').value,
    bonusPlan: document.getElementById('hire-bonus').value,
    iban: "", // Can be added if you have an input for it
    
    nationalId: document.getElementById('hire-nat-id').value,
    passport: document.getElementById('hire-passport').value,
    socialInsurance: document.getElementById('hire-social').value,
    birthDate: document.getElementById('hire-dob').value,
    maritalStatus: document.getElementById('hire-marital').value,
    address: document.getElementById('hire-address').value,
    emergencyContact: document.getElementById('hire-emergency').value,
    
    // Defaults
    gender: "", 
    empType: "Full-Time",
    gcm: "",
    scope: "",
    shore: "",
    nLevel: ""
  };

  // Basic Validation
  if(!hiringData.hiringDate || !hiringData.konectaEmail || !hiringData.directManager || !hiringData.salary) {
    setStatus('hire-status', 'error', "Please fill in all required fields (Email, Direct Manager, Salary, Hiring Date).");
    return;
  }

  setStatus('hire-status', 'processing', 'Creating Employee Record and Drive Folders...');

  google.script.run
    .withSuccessHandler(msg => {
      setStatus('hire-status', 'success', msg);
      setTimeout(() => {
        closeHireModal();
        loadRecruitmentAdmin(); // Refresh list
      }, 2000);
    })
    .withFailureHandler(err => {
      setStatus('hire-status', 'error', err.message);
    })
    .webHireCandidate(candidateId, hiringData);
}

function filterCandidates() {
  const input = document.getElementById('candidate-search');
  const filter = input.value.toLowerCase();
  const nodes = document.getElementsByClassName('candidate-item');

  for (let i = 0; i < nodes.length; i++) {
    if (nodes[i].innerText.toLowerCase().includes(filter)) {
      nodes[i].style.display = "flex";
    } else {
      nodes[i].style.display = "none";
    }
  }
}

// ====================================
// === PHASE 5: PERFORMANCE JS ===
// ====================================

function loadPerformanceTab() {
  // 1. Show Manager Section if Admin
  if (selfRole === 'admin' || selfRole === 'superadmin' || selfRole === 'manager' || selfRole === 'project_manager') {
    document.getElementById('manager-review-section').style.display = 'block';
    // Reuse your existing populate dropdown logic
    populateAdminDropdown(allUsersList, selfUserName, 'perf-employee-select', 'Select Employee');
    
    // Populate Offboarding dropdown too (since we are here)
    populateAdminDropdown(allUsersList, selfUserName, 'offboard-user-select', 'Select Employee to Offboard');
  }

  // 2. Load My History
  loadPerformanceHistory();
}

function loadPerformanceHistory() {
  const list = document.getElementById('perf-history-list');
  list.innerHTML = '<p class="text-color-secondary">Loading reviews...</p>';

  google.script.run
    .withSuccessHandler(reviews => {
      if (reviews.length === 0) {
        list.innerHTML = '<p class="text-color-secondary">No performance reviews found.</p>';
        return;
      }
      let html = '';
      reviews.forEach(r => {
        // Star Rating Visual
        const stars = '‚≠ê'.repeat(r.rating);
        html += `
          <div class="request-list-item">
            <div class="item-details">
              <h4>${r.year} - ${r.period} Review</h4>
              <p><strong>Rating:</strong> ${r.rating}/5 ${stars}</p>
              <p style="white-space: pre-wrap; margin-top:5px;">${r.comments}</p>
              <small class="text-color-secondary">Date: ${r.date}</small>
            </div>
          </div>
        `;
      });
      list.innerHTML = html;
    })
    .withFailureHandler(err => list.innerHTML = `<p class="status-message error visible">${err.message}</p>`)
    .webGetPerformanceHistory(null); // null = get my own
}

function submitPerformanceReview() {
  const data = {
    employeeEmail: document.getElementById('perf-employee-select').value,
    period: document.getElementById('perf-period').value,
    year: document.getElementById('perf-year').value,
    rating: document.getElementById('perf-rating').value,
    comments: document.getElementById('perf-comments').value
  };

  if (!data.employeeEmail) {
    setStatus('perf-submit-status', 'error', 'Please select an employee.');
    return;
  }

  setStatus('perf-submit-status', 'processing', 'Submitting review...');

  google.script.run
    .withSuccessHandler(msg => {
      setStatus('perf-submit-status', 'success', msg);
      document.getElementById('perf-comments').value = ''; // Clear comments
    })
    .withFailureHandler(err => {
      setStatus('perf-submit-status', 'error', err.message);
    })
    .webSubmitPerformanceReview(data);
}

// ====================================
// === PHASE 5: OFFBOARDING JS ===
// ====================================

function submitOffboarding() {
  const email = document.getElementById('offboard-user-select').value;
  const date = document.getElementById('offboard-date').value;
  const reason = document.getElementById('offboard-reason').value;

  if (!email || !date) {
    setStatus('offboard-status', 'error', 'Employee and Exit Date are required.');
    return;
  }

  if (!confirm(`Are you sure you want to mark ${email} as LEFT? This action cannot be easily undone.`)) return;

  setStatus('offboard-status', 'processing', 'Processing exit...');

  google.script.run
    .withSuccessHandler(msg => {
      setStatus('offboard-status', 'success', msg);
      // Optional: Refresh user list to reflect status change (would require page reload or data refresh)
    })
    .withFailureHandler(err => {
      setStatus('offboard-status', 'error', err.message);
    })
    .webOffboardEmployee({ email: email, exitDate: date, reason: reason });
}

// --- JOB BOARD LOGIC ---
function toggleJobBoard() {
    const div = document.getElementById('job-board-view');
    if (div.style.display === 'none') {
        div.style.display = 'block';
        loadJobBoard();
    } else {
        div.style.display = 'none';
    }
}

function loadJobBoard() {
    google.script.run.withSuccessHandler(jobs => {
        const container = document.getElementById('job-list-container');
        if (jobs.length === 0) { container.innerHTML = 'No active requisitions.'; return; }
        
        let html = '<table class="report-table"><thead><tr><th>Title</th><th>Manager</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        jobs.forEach(j => {
            html += `<tr>
                <td>${j.title} <br><small class="text-color-secondary">${j.dept}</small></td>
                <td>${j.manager}</td>
                <td>${j.date}</td>
                <td><span class="status-badge ${j.status === 'Open' ? 'status-approved' : 'status-denied'}">${j.status}</span></td>
                <td>
                    <button class="deny-btn" style="padding: 4px 8px; font-size: 0.8rem;" onclick="archiveJob('${j.id}')">Archive</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }).webGetRequisitions('Open');
}

function archiveJob(id) {
    if(!confirm("Archive this job post?")) return;
    google.script.run.withSuccessHandler(() => loadJobBoard()).webManageRequisition(id, 'Archive', {});
}

// --- CANDIDATE ACTIONS ---

function loadRecruitmentAdmin() { // Replaces existing loadRecruitmentAdmin
  const list = document.getElementById('candidate-list');
  list.innerHTML = '<p class="text-color-secondary">Loading pipeline...</p>';
  
  google.script.run.withSuccessHandler(candidates => {
      if (candidates.length === 0) { list.innerHTML = '<p class="text-color-secondary">No candidates found.</p>'; return; }
      
      let html = '';
      candidates.forEach(c => {
        let badgeClass = c.status === 'Hired' ? 'status-approved' : c.status === 'Rejected' ? 'status-denied' : 'status-pending';
        
        // History Check (Simulated for UI - call backend for details)
        let historyBtn = `<button class="view-btn" onclick="checkHistory('${c.email}')" style="font-size:0.75rem; margin-left:5px;">üìú History</button>`;

        let actions = '';
        if (c.status !== 'Hired' && c.status !== 'Rejected') {
          actions = `
            <div style="display:flex; gap:5px; margin-top:10px; flex-wrap:wrap;">
              <button class="view-btn" onclick="updateCandidateStatus('${c.id}', 'Active', 'Interview 1')">Interview</button>
              <button class="view-btn" style="background:var(--konecta-yellow); color:#000;" onclick="sendOffer('${c.id}')">Send Offer</button>
              <button class="submit-btn-green" onclick="openHireModal('${c.id}', '${c.name}', '${c.email}', '${c.phone}', '${c.nationalId}')">HIRE</button>
              <button class="deny-btn" onclick="openRejectModal('${c.id}')">Reject</button>
            </div>
          `;
        } else {
            actions = `<p style="margin-top:5px; font-size:0.9rem;">Process Complete.</p>`;
        }

        html += `
          <div class="request-list-item candidate-item">
            <div class="item-details">
              <h4>${c.name} <span class="text-color-secondary">(${c.position})</span> ${historyBtn}</h4>
              <p><strong>Email:</strong> ${c.email}</p>
              <p><strong>Stage:</strong> ${c.stage} | <strong>Status:</strong> <span class="status-badge ${badgeClass}">${c.status}</span></p>
              <p><a href="${c.cv}" target="_blank" style="color:var(--konecta-blue);">View CV</a></p>
            </div>
            <div class="item-actions" style="width:100%; max-width:400px; text-align:right;">
              ${actions}
            </div>
          </div>
        `;
      });
      list.innerHTML = html;
  }).webGetCandidates();
}

// --- ACTION HANDLERS ---

function checkHistory(email) {
    google.script.run.withSuccessHandler(hist => {
        let msg = hist.length > 0 ? hist.map(h => `${h.date}: ${h.position} (${h.status})`).join('\n') : "No previous applications found.";
        alert("Candidate History:\n" + msg);
    }).webGetCandidateHistory(email);
}

function openRejectModal(id) {
    document.getElementById('reject-candidate-id').value = id;
    document.getElementById('reject-modal-backdrop').style.display = 'block';
    document.getElementById('reject-modal').style.display = 'flex';
}

function closeRejectModal() {
    document.getElementById('reject-modal-backdrop').style.display = 'none';
    document.getElementById('reject-modal').style.display = 'none';
}

function submitRejection() {
    const id = document.getElementById('reject-candidate-id').value;
    const reason = document.getElementById('reject-reason').value;
    const sendEmail = document.getElementById('reject-send-email').checked;
    
    setStatus('recruitment-status', 'processing', 'Processing rejection...');
    closeRejectModal();
    
    google.script.run.withSuccessHandler(msg => {
        setStatus('recruitment-status', 'success', msg);
        loadRecruitmentAdmin();
    }).webSendRejectionEmail(id, reason, sendEmail);
}

function sendOffer(id) {
    // For simplicity, prompt for details. In production, use a modal.
    const startDate = prompt("Enter Offer Start Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
    if(!startDate) return;
    const basic = prompt("Enter Basic Salary:");
    const variable = prompt("Enter Variable/Bonus:");
    
    if(confirm(`Send offer email to candidate?\nStart: ${startDate}\nBasic: ${basic}\nVar: ${variable}`)) {
        setStatus('recruitment-status', 'processing', 'Sending offer...');
        google.script.run.withSuccessHandler(msg => {
            alert(msg);
            loadRecruitmentAdmin();
        }).webSendOfferLetter(id, {startDate, basic, variable});
    }
}

// Update submitHire to include new Variable field
function submitHire() {
    const candidateId = document.getElementById('hire-candidate-id').value;
    const hiringData = {
        // ... (Existing fields: fullName, konectaEmail, directManager, etc.)
        fullName: document.getElementById('hire-fullname').value,
        konectaEmail: document.getElementById('hire-k-email').value,
        title: document.getElementById('hire-title').value,
        department: document.getElementById('hire-dept').value,
        contractType: document.getElementById('hire-contract').value,
        hiringDate: document.getElementById('hire-date').value,
        directManager: document.getElementById('hire-direct-mgr').value,
        salary: document.getElementById('hire-salary').value,
        // NEW FIELDS
        variable: document.getElementById('hire-variable').value, 
        // ... (Include all other existing fields)
        nationalId: document.getElementById('hire-nat-id').value,
        address: document.getElementById('hire-address').value
    };
    
    // Validation logic...
    setStatus('hire-status', 'processing', 'Creating Employee Record...');
    google.script.run.withSuccessHandler(msg => {
        setStatus('hire-status', 'success', msg);
        setTimeout(() => { closeHireModal(); loadRecruitmentAdmin(); }, 2000);
    }).webHireCandidate(candidateId, hiringData);
}

// --- USER VIEW ---
function loadMyFinancials() {
  const container = document.getElementById('my-entitlements-list');
  
  google.script.run.withSuccessHandler(data => {
    // 1. Update Salary Cards
    document.getElementById('fin-basic').innerText = data.salary.basic.toLocaleString();
    document.getElementById('fin-variable').innerText = data.salary.variable.toLocaleString();
    document.getElementById('fin-total').innerText = data.salary.total.toLocaleString();

    // 2. Update List
    if (data.entitlements.length === 0) {
      container.innerHTML = '<p class="text-color-secondary">No upcoming payments found.</p>';
      return;
    }
    
    let html = '';
    data.entitlements.forEach(e => {
      let color = e.type === 'Deduction' ? 'var(--status-error-text)' : 'var(--konecta-dark)';
      html += `
        <div class="request-list-item">
          <div class="item-details">
            <h4>${e.type}</h4>
            <p>${e.desc}</p>
            <small class="text-color-secondary">Due: ${formatDate(e.date)}</small>
          </div>
          <div class="item-actions" style="text-align:right;">
            <strong style="color:${color}; font-size:1.2rem;">${Number(e.amount).toLocaleString()} ${e.currency}</strong>
            <br><span class="status-badge ${e.status === 'Paid' ? 'status-approved' : 'status-pending'}">${e.status}</span>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }).webGetMyFinancials();
}

// Hook into profile tab switcher
// Update switchProfileSubTab to call loadMyFinancials() if tabName === 'finance'

// --- ADMIN VIEW ---
function submitEntitlement() {
  const data = {
    email: document.getElementById('fin-email').value,
    type: document.getElementById('fin-type').value,
    amount: document.getElementById('fin-amount').value,
    date: document.getElementById('fin-date').value,
    desc: document.getElementById('fin-desc').value
  };
  
  if(!data.email || !data.amount) {
    setStatus('finance-status', 'error', 'Email and Amount are required.');
    return;
  }

  setStatus('finance-status', 'processing', 'Submitting...');
  
  google.script.run.withSuccessHandler(msg => {
    setStatus('finance-status', 'success', msg);
    // Clear form
    document.getElementById('fin-amount').value = '';
    document.getElementById('fin-desc').value = '';
  }).withFailureHandler(err => {
    setStatus('finance-status', 'error', err.message);
  }).webSubmitEntitlement(data);
}

function uploadFinanceCSV() {
  const fileInput = document.getElementById('fin-csv-upload');
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const data = parseCSV(text); // Uses existing helper
    
    setStatus('finance-status', 'processing', `Uploading ${data.length} records...`);
    
    google.script.run.withSuccessHandler(msg => {
      setStatus('finance-status', 'success', msg);
    }).withFailureHandler(err => {
      setStatus('finance-status', 'error', err.message);
    }).webUploadEntitlementsCSV(data);
  };
  reader.readAsText(file);
}

/**
 * REUSABLE COMPONENT: Searchable Multi-Select Dropdown
 * UPDATED: Now accepts a defaultVal to pre-select an option.
 */
function renderGlobalUserSelector(containerId, users, placeholder, isMulti, onCallback, defaultVal = null) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = '';
  container.className = 'multi-select-wrapper';

  // State: Initialize with default value if provided
  let selectedValues = new Set();
  if (defaultVal) {
      if (Array.isArray(defaultVal)) defaultVal.forEach(v => selectedValues.add(v));
      else selectedValues.add(defaultVal);
  }

  // UI Elements
  const trigger = document.createElement('div');
  trigger.className = 'multi-select-trigger';
  // Placeholder will be updated by updateUI() immediately if there is a default
  trigger.innerHTML = `<span class="trigger-text">${placeholder}</span><span class="arrow">‚ñº</span>`;
  
  const dropdown = document.createElement('div');
  dropdown.className = 'multi-select-dropdown';
  
  const searchBox = document.createElement('div');
  searchBox.className = 'dropdown-search-container';
  searchBox.innerHTML = `<input type="text" class="dropdown-search-input" placeholder="Search...">`;
  
  const list = document.createElement('ul');
  list.className = 'dropdown-options-list';

  if(isMulti) {
      const actions = document.createElement('div');
      actions.className = 'dropdown-actions';
      actions.innerHTML = `<button type="button" class="dropdown-action-btn" id="all-${containerId}">All</button> <button type="button" class="dropdown-action-btn" id="none-${containerId}">Clear</button>`;
      dropdown.appendChild(actions);
  }

  dropdown.appendChild(searchBox);
  dropdown.appendChild(list);
  container.appendChild(trigger);
  container.appendChild(dropdown);

  // Render Function
  function renderOptions(filter = '') {
    list.innerHTML = '';
    const f = filter.toLowerCase();
    const sorted = [...users].sort((a,b) => a.name.localeCompare(b.name));

    sorted.forEach(u => {
      if (u.name.toLowerCase().includes(f) || u.email.toLowerCase().includes(f)) {
        const li = document.createElement('li');
        li.className = `dropdown-option ${selectedValues.has(u.email) ? 'selected' : ''}`;
        li.dataset.email = u.email;
        li.innerHTML = `
          <input type="${isMulti ? 'checkbox' : 'radio'}" ${selectedValues.has(u.email) ? 'checked' : ''}>
          <div><div style="font-weight:500">${u.name}</div><div style="font-size:0.75rem;color:#666">${u.email}</div></div>
        `;
        li.onclick = (e) => {
            e.stopPropagation();
            toggleSelect(u.email, u.name);
        };
        list.appendChild(li);
      }
    });
  }

  function toggleSelect(email, name) {
    if (!isMulti) {
        selectedValues.clear();
        selectedValues.add(email);
        dropdown.classList.remove('open');
    } else {
        if (selectedValues.has(email)) selectedValues.delete(email);
        else selectedValues.add(email);
    }
    updateUI();
    if (onCallback) onCallback(Array.from(selectedValues));
  }

  function updateUI() {
    const count = selectedValues.size;
    const span = trigger.querySelector('.trigger-text');
    if (count === 0) {
        span.textContent = placeholder;
        span.style.color = '#666';
    } else if (count === 1) {
        const email = Array.from(selectedValues)[0];
        const user = users.find(u => u.email === email);
        span.textContent = user ? user.name : email; // Show Name
        span.style.color = '#333';
    } else {
        span.textContent = `${count} Selected`;
        span.style.color = 'var(--konecta-blue)';
    }
    
    // Re-render list to update checkboxes/highlights
    renderOptions(searchBox.querySelector('input').value);
  }

  // Events
  trigger.onclick = (e) => {
      e.stopPropagation();
      document.querySelectorAll('.multi-select-dropdown').forEach(d => { if(d!==dropdown) d.classList.remove('open'); });
      dropdown.classList.toggle('open');
      if(dropdown.classList.contains('open')) searchBox.querySelector('input').focus();
  };

  searchBox.querySelector('input').onkeyup = (e) => renderOptions(e.target.value);

  if(isMulti) {
      document.getElementById(`all-${containerId}`).onclick = (e) => {
          e.stopPropagation();
          list.querySelectorAll('li').forEach(li => selectedValues.add(li.dataset.email));
          updateUI();
          if (onCallback) onCallback(Array.from(selectedValues));
      };
      document.getElementById(`none-${containerId}`).onclick = (e) => {
          e.stopPropagation();
          selectedValues.clear();
          updateUI();
          if (onCallback) onCallback([]);
      };
  }

  // Close on click outside
  document.addEventListener('click', (e) => {
      if (!container.contains(e.target)) dropdown.classList.remove('open');
  });

  // Initial Render
  renderOptions();
  
  // *** CRITICAL FIX: Apply default value immediately ***
  if (defaultVal) {
      updateUI();
      if (onCallback) onCallback(Array.from(selectedValues));
  }
}


// --- HR ADMIN FUNCTIONS ---

function loadHrAdmin() {
  // 1. Load Pending Requests
  const reqList = document.getElementById('hr-data-requests-list');
  reqList.innerHTML = '<p class="text-color-secondary">Loading...</p>';
  google.script.run.withSuccessHandler(reqs => {
    if (reqs.length === 0) {
      reqList.innerHTML = '<p class="text-color-secondary">No pending data changes.</p>';
    } else {
      let html = '<ul style="padding-left: 20px; margin: 0;">';
      reqs.forEach(r => {
        html += `<li style="margin-bottom: 5px; font-size: 0.9rem;">
          <strong>${r.date}:</strong> ${r.user} (${r.email}) - <span style="color: var(--konecta-blue);">${r.details}</span>
        </li>`;
      });
      html += '</ul>';
      reqList.innerHTML = html;
    }
  }).webGetPendingDataChanges();

  // 2. Populate Dropdowns (Balance & Offboard)
  // Reuse the global list
  if (allUsersList.length > 0) {
    populateAdminDropdown(allUsersList, selfUserName, 'hr-balance-user-select', 'Select User');
    populateAdminDropdown(allUsersList, selfUserName, 'hr-offboard-user-select', 'Select Employee');
  }
}

function searchEmployeePII() {
  const query = document.getElementById('hr-pii-search').value;
  if (!query) return;

  setStatus('hr-pii-search-status', 'processing', 'Searching...');
  document.getElementById('hr-pii-form-container').style.display = 'none';

  google.script.run
    .withSuccessHandler(data => {
      setStatus('hr-pii-search-status', 'success', 'User found.');
      const c = data.core;
      const p = data.pii;

      document.getElementById('hr-pii-form-container').style.display = 'block';
      document.getElementById('hr-pii-header').innerText = `Editing: ${c.name} (${c.empID})`;
      document.getElementById('hr-pii-empid').value = c.empID;

      // Populate fields
      document.getElementById('hr-pii-natid').value = p.NationalID || '';
      document.getElementById('hr-pii-passport').value = p.PassportNumber || '';
      document.getElementById('hr-pii-social').value = p.SocialInsuranceNumber || '';
      document.getElementById('hr-pii-iban').value = p.IBAN || '';
      document.getElementById('hr-pii-pemail').value = p.PersonalEmail || '';
      document.getElementById('hr-pii-phone').value = p.Phone || '';
      document.getElementById('hr-pii-address').value = p.Address || '';
      document.getElementById('hr-pii-marital').value = p.MaritalStatus || 'Single';
      document.getElementById('hr-pii-basic').value = p.BasicSalary || 0;
      document.getElementById('hr-pii-variable').value = p.VariablePay || 0;
    })
    .withFailureHandler(err => {
      setStatus('hr-pii-search-status', 'error', err.message);
    })
    .webSearchEmployeePII(query);
}

function saveEmployeePII() {
  const empID = document.getElementById('hr-pii-empid').value;
  const formData = {
    NationalID: document.getElementById('hr-pii-natid').value,
    PassportNumber: document.getElementById('hr-pii-passport').value,
    SocialInsuranceNumber: document.getElementById('hr-pii-social').value,
    IBAN: document.getElementById('hr-pii-iban').value,
    PersonalEmail: document.getElementById('hr-pii-pemail').value,
    Phone: document.getElementById('hr-pii-phone').value,
    Address: document.getElementById('hr-pii-address').value,
    MaritalStatus: document.getElementById('hr-pii-marital').value,
    BasicSalary: document.getElementById('hr-pii-basic').value,
    VariablePay: document.getElementById('hr-pii-variable').value
  };

  setStatus('hr-pii-search-status', 'processing', 'Saving PII...');
  
  google.script.run
    .withSuccessHandler(msg => {
      setStatus('hr-pii-search-status', 'success', msg);
      document.getElementById('hr-pii-form-container').style.display = 'none';
      document.getElementById('hr-pii-search').value = '';
      loadHrAdmin(); // Refresh requests list if needed
    })
    .withFailureHandler(err => setStatus('hr-pii-search-status', 'error', err.message))
    .webUpdateEmployeePII(empID, formData);
}

// Wrapper for Balance Adjustment (using HR tab IDs)
function submitHrBalanceAdjustment() {
  // Temporarily map HR IDs to the backend function logic
  const userEmail = document.getElementById('hr-balance-user-select').value;
  const type = document.getElementById('hr-balance-type').value;
  const amount = parseFloat(document.getElementById('hr-balance-amount').value);
  const reason = document.getElementById('hr-balance-reason').value;

  if (!userEmail || !amount || !reason) {
    setStatus('hr-balance-status', 'error', 'All fields are required.');
    return;
  }

  setStatus('hr-balance-status', 'processing', 'Updating balance...');
  google.script.run.withSuccessHandler(msg => {
    setStatus('hr-balance-status', 'success', msg);
    document.getElementById('hr-balance-amount').value = '';
    document.getElementById('hr-balance-reason').value = '';
  }).withFailureHandler(err => setStatus('hr-balance-status', 'error', err.message))
  .webAdjustLeaveBalance(userEmail, type, amount, reason);
}

// Wrapper for Offboarding (using HR tab IDs)
function submitHrOffboarding() {
  const email = document.getElementById('hr-offboard-user-select').value;
  const date = document.getElementById('hr-offboard-date').value;
  const reason = document.getElementById('hr-offboard-reason').value;

  if (!email || !date) {
    setStatus('hr-offboard-status', 'error', 'Required fields missing.');
    return;
  }
  if (!confirm("Confirm offboarding for " + email + "?")) return;

  setStatus('hr-offboard-status', 'processing', 'Processing...');
  google.script.run.withSuccessHandler(msg => {
    setStatus('hr-offboard-status', 'success', msg);
  }).withFailureHandler(err => setStatus('hr-offboard-status', 'error', err.message))
  .webOffboardEmployee({email, exitDate: date, reason});
}



// --- OVERTIME FUNCTIONS ---

function loadOvertimeTab() {
  document.getElementById('ot-req-date').valueAsDate = new Date();
  
  // Show assignment toggle for managers
  if (['admin','superadmin','manager','project_manager'].includes(selfRole)) {
      document.getElementById('ot-assign-toggle').style.display = 'block';
      populateAdminDropdown(allUsersList, selfUserName, 'ot-employee-select', 'Select Agent');
  }
  loadOvertimeRequests();
}

function toggleOtAssignment() {
    const isAssign = document.getElementById('ot-is-assignment').checked;
    document.getElementById('ot-employee-select-wrapper').style.display = isAssign ? 'block' : 'none';
}


function submitOtRequest() {
  const isAssignment = document.getElementById('ot-is-assignment').checked;
  const targetEmail = isAssignment ? document.getElementById('ot-employee-select').value : null;

  if (isAssignment && !targetEmail) {
      setStatus('ot-status', 'error', 'Please select an agent.');
      return;
  }

  const data = {
    targetEmail: targetEmail, // Null if self-request
    date: document.getElementById('ot-req-date').value,
    type: document.getElementById('ot-req-type').value,
    startTime: document.getElementById('ot-req-start').value,
    endTime: document.getElementById('ot-req-end').value,
    reason: document.getElementById('ot-req-reason').value
  };

  setStatus('ot-status', 'processing', 'Submitting...');
  google.script.run.withSuccessHandler(msg => {
      setStatus('ot-status', 'success', msg);
      loadOvertimeRequests();
  }).withFailureHandler(err => setStatus('ot-status', 'error', err.message))
  .webSubmitOvertimeRequest(data);
}


function submitPreApproval() {
  const data = {
    email: document.getElementById('ot-employee-select').value,
    date: document.getElementById('ot-pre-date').value,
    hours: document.getElementById('ot-pre-hours').value
  };
  const comment = document.getElementById('ot-pre-comment').value;

  if (!data.email || !data.date || !data.hours) {
    alert("Please fill in Employee, Date, and Hours.");
    return;
  }

  google.script.run
    .withSuccessHandler(msg => {
      alert(msg);
      loadOvertimeRequests();
    })
    .withFailureHandler(err => alert("Error: " + err.message))
    .webActionOvertime(null, 'Pre-Approve', comment, data);
}

function loadOvertimeRequests() {
  const filter = document.getElementById('ot-filter-status').value;
  const list = document.getElementById('ot-request-list');
  list.innerHTML = '<p class="text-color-secondary">Loading...</p>';

  google.script.run.withSuccessHandler(reqs => {
      if(reqs.length === 0) { list.innerHTML = '<p class="text-color-secondary">No records found.</p>'; return; }
      
      let html = '';
      reqs.forEach(r => {
          let actions = '';
          // Show buttons if Pending AND User has permission
          if (r.status.includes('Pending') && ['admin','superadmin','manager','project_manager'].includes(selfRole)) {
              actions = `
                <div style="margin-top:8px;">
                   <button class="approve-btn" onclick="actionOvertime('${r.id}','Approved')">Approve</button>
                   <button class="deny-btn" onclick="actionOvertime('${r.id}','Denied')">Deny</button>
                </div>`;
          }

          html += `
            <div class="request-list-item">
                <div class="item-details">
                    <h4>${r.name} <span class="status-tag status-info">${r.type}</span></h4>
                    <p><strong>Date:</strong> ${r.date}</p>
                    <p class="text-color-secondary" style="font-size:0.85rem;">Time: ${r.time} (${r.hours}h)</p>
                    <p class="text-color-secondary" style="font-size:0.85rem;">By: ${r.initiatedBy}</p>
                    <div style="display:flex; gap:10px; margin-top:5px; font-size:0.8rem;">
                        <span style="color:${r.directStatus==='Approved'?'green':'orange'}">Direct: ${r.directStatus}</span>
                        <span style="color:${r.projectStatus==='Approved'?'green':'orange'}">Project: ${r.projectStatus}</span>
                    </div>
                </div>
                <div class="item-actions">
                    <span class="status-badge ${r.status==='Approved'?'status-approved':r.status==='Denied'?'status-denied':'status-pending'}">${r.status}</span>
                    ${actions}
                </div>
            </div>`;
      });
      list.innerHTML = html;
  }).webGetOvertimeRequests(filter);
}

function actionOvertime(id, action) {
  const comment = prompt(`Optional comment for ${action}:`) || "";
  
  // Visual feedback
  const list = document.getElementById('ot-request-list');
  list.style.opacity = '0.5';

  google.script.run
    .withSuccessHandler(msg => {
      alert(msg);
      list.style.opacity = '1';
      loadOvertimeRequests();
    })
    .withFailureHandler(err => {
        list.style.opacity = '1';
        alert("Error: " + err.message);
    })
    .webActionOvertime(id, action, comment);
}

// --- PHASE 6: BREAK CONFIG EDITOR JS ---

function loadBreakConfig() {
  const container = document.getElementById('break-config-container');
  container.innerHTML = '<p class="text-color-secondary">Loading rules...</p>';
  
  google.script.run
    .withSuccessHandler(configs => {
      let html = '';
      configs.forEach((conf, index) => {
        html += `
          <div class="form-row break-rule-row" style="border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:10px;">
            <div class="form-group" style="flex:2;">
              <label>Break Type</label>
              <input type="text" class="rule-type" value="${conf.type}" readonly style="background-color: var(--input-bg); font-weight:bold;">
            </div>
            <div class="form-group">
              <label>Default (Sec)</label>
              <input type="number" class="rule-default" value="${conf.defaultDur}">
              <small class="text-color-secondary">${Math.floor(conf.defaultDur/60)} mins</small>
            </div>
            <div class="form-group">
              <label>Max Allowed (Sec)</label>
              <input type="number" class="rule-max" value="${conf.maxDur}">
              <small class="text-color-secondary">${Math.floor(conf.maxDur/60)} mins</small>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    })
    .withFailureHandler(err => {
      container.innerHTML = `<p class="status-message error visible">${err.message}</p>`;
    })
    .webGetBreakConfig();
}

function saveBreakConfig() {
  const rows = document.querySelectorAll('.break-rule-row');
  const newConfigs = [];
  
  rows.forEach(row => {
    newConfigs.push({
      type: row.querySelector('.rule-type').value,
      defaultDur: row.querySelector('.rule-default').value,
      maxDur: row.querySelector('.rule-max').value
    });
  });
  
  setStatus('break-config-status', 'processing', 'Saving configuration...');
  
  google.script.run
    .withSuccessHandler(msg => {
      setStatus('break-config-status', 'success', msg);
      // Refresh user info silently to apply new rules to the current session immediately
      google.script.run.withSuccessHandler(user => populateUserInfo(user)).getUserInfo();
    })
    .withFailureHandler(err => {
      setStatus('break-config-status', 'error', err.message);
    })
    .webSaveBreakConfig(newConfigs);
}

// 1. Triggered when a user is selected in the "Reporting Line" tab
function onReportingLineUserChange() {
  setTimeout(() => {
    const userEmail = document.getElementById('reporting-line-user').value;
    if (!userEmail) {
      document.getElementById('pm-change-section').style.display = 'none';
      return;
    }

    // Find user in global list
    const user = allUsersList.find(u => u.email === userEmail);
    if (user) {
      // Show section
      document.getElementById('pm-change-section').style.display = 'block';
      
      // Display Current PM
      const currentPM = user.projectManager || "None";
      const pmName = allUsersList.find(u => u.email === currentPM)?.name || currentPM;
      
      document.getElementById('current-pm-display').innerText = pmName;
      document.getElementById('current-pm-display').dataset.email = currentPM; 

      // Reset Radio to Keep
      document.querySelector('input[name="pm-action"][value="keep"]').checked = true;
      togglePMDropdown(false);
      
      // --- FIX: Use 'allAdminsList' to show only Managers/Admins in the dropdown ---
      populateAdminDropdown(allAdminsList, selfUserName, 'reporting-line-pm', 'Select New Project Manager');
    }
  }, 200); 
}
// 2. Toggles the dropdown visibility
function togglePMDropdown(show) {
  document.getElementById('pm-dropdown-wrapper').style.display = show ? 'block' : 'none';
}

// --- FINANCE ADMIN JS ---
function saveEntitlementTemplate() {
    const data = {
        name: document.getElementById('tmpl-name').value,
        type: document.getElementById('tmpl-type').value,
        amount: document.getElementById('tmpl-amount').value,
        currency: document.getElementById('tmpl-curr').value,
        description: `Template: ${document.getElementById('tmpl-name').value}`
    };
    google.script.run.withSuccessHandler(alert).webSaveEntitlementTemplate(data);
}

function loadEntitlementTemplates() {
    google.script.run.withSuccessHandler(tmpls => {
        const sel = document.getElementById('fin-apply-tmpl-select');
        sel.innerHTML = "";
        tmpls.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.text = `${t.name} (${t.amount} ${t.currency})`;
            sel.appendChild(opt);
        });
    }).webGetEntitlementTemplates();
}

function applyTemplateToUsers() {
    const tmplId = document.getElementById('fin-apply-tmpl-select').value;
    // Use the custom multi-select logic we built earlier
    // Assuming 'fin-apply-users-container' uses renderGlobalUserSelector logic
    // We need to initialize it first.
    
    // For now, let's assume we read from the dataset if initialized
    // NOTE: You must initialize this dropdown in showTab('finance-admin')
    const wrapper = document.getElementById('fin-apply-users-container');
    let emails = [];
    try { emails = JSON.parse(wrapper.dataset.value || "[]"); } catch(e){}
    
    if(emails.length === 0) { alert("Select users first."); return; }
    
    google.script.run.withSuccessHandler(alert).webApplyEntitlementTemplate(tmplId, emails);
}

// --- PROJECT ADMIN JS ---
function loadProjectDashboardData() {
    const pid = document.getElementById('project-admin-select').value;
    if(!pid) return;
    
    // Load Stats
    google.script.run.withSuccessHandler(data => {
        document.getElementById('prj-stat-total').innerText = data.stats.total;
        document.getElementById('prj-stat-agents').innerText = data.stats.agents;
        document.getElementById('prj-stat-supers').innerText = data.stats.supers;
    }).webGetProjectDashboard(pid);
    
    // Load Requests
    google.script.run.withSuccessHandler(reqs => {
        const list = document.getElementById('project-requests-list');
        let html = '';
        reqs.forEach(r => {
            html += `<div class="request-list-item">
                <div class="item-details">
                    <h4>${r.type}: ${r.user}</h4>
                    <small>${r.date}</small>
                </div>
                <span class="status-badge ${r.status === 'Approved' ? 'status-approved' : 'status-pending'}">${r.status}</span>
            </div>`;
        });
        list.innerHTML = html;
    }).webGetProjectRequests(pid);
}

function loadOffboardingTab() {
    // Populate dropdown for termination if the user is a manager/admin
    if (['admin','superadmin','manager','project_manager'].includes(selfRole)) {
        populateAdminDropdown(allUsersList, selfUserName, 'offboard-term-user', 'Select Employee');
        const section = document.getElementById('offboard-initiate-section');
        if (section) section.style.display = 'block';
    } else {
        const section = document.getElementById('offboard-initiate-section');
        if (section) section.style.display = 'none';
    }
    loadOffboardingRequests();
}

function submitResignation() {
    const date = document.getElementById('resign-date').value;
    const reason = document.getElementById('resign-reason').value;
    if(!date || !reason) { alert("Date and Reason required."); return; }
    
    if(!confirm("Are you sure you want to resign? This starts the formal process.")) return;
    
    google.script.run.withSuccessHandler(alert).webSubmitResignation(reason, date);
}

function submitTermination() {
    const email = document.getElementById('offboard-term-user').value;
    const date = document.getElementById('term-date').value;
    const reason = document.getElementById('term-reason').value;
    
    if(!email || !date || !reason) { alert("All fields required."); return; }
    
    google.script.run.withSuccessHandler(msg => {
        alert(msg);
        loadOffboardingRequests();
    }).webSubmitTermination(email, reason, date);
}

function loadOffboardingRequests() {
    const list = document.getElementById('offboarding-list');
    list.innerHTML = '<p class="text-color-secondary">Loading requests...</p>';
    
    google.script.run
        .withSuccessHandler(reqs => {
            if (!reqs || reqs.length === 0) { 
                list.innerHTML = '<p class="text-color-secondary">No pending offboarding requests found.</p>'; 
                return; 
            }
            
            let html = '';
            reqs.forEach(r => {
                let actions = '';
                // Show buttons if allowed
                if (['admin','superadmin','manager','project_manager'].includes(selfRole) && r.status !== 'Approved' && r.status !== 'Denied') {
                     actions = `
                        <div style="margin-top:8px;">
                            <button class="approve-btn" onclick="actionOffboard('${r.id}','Approved')">Approve</button>
                            <button class="deny-btn" onclick="actionOffboard('${r.id}','Denied')">Deny</button>
                        </div>
                     `;
                }
                
                let statusClass = 'status-pending';
                if (r.status === 'Approved') statusClass = 'status-approved';
                if (r.status === 'Denied') statusClass = 'status-denied';
                
                html += `
                    <div class="request-list-item">
                        <div class="item-details">
                            <h4>${r.type}: ${r.name}</h4>
                            <p><strong>Exit Date:</strong> ${r.exitDate}</p>
                            <p class="text-color-secondary">${r.reason}</p>
                            <div style="font-size:0.8rem; margin-top:5px; display:flex; gap:10px;">
                                <span style="color:${r.directStatus==='Approved'?'green':'orange'}">Direct: ${r.directStatus}</span>
                                <span style="color:${r.projectStatus==='Approved'?'green':'orange'}">Project: ${r.projectStatus}</span>
                                <span style="color:${r.hrStatus==='Approved'?'green':'orange'}">HR: ${r.hrStatus}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <span class="status-badge ${statusClass}">${r.status}</span>
                            ${actions}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        })
        .withFailureHandler(err => {
            // Show the error on screen
            list.innerHTML = `<p class="status-message error visible">Error loading requests: ${err.message}</p>`;
        })
        .webGetOffboardingRequests();
}

function actionOffboard(id, action) {
    if(!confirm(action + " this request?")) return;
    google.script.run.withSuccessHandler(msg => {
        alert(msg);
        loadOffboardingRequests();
    }).webActionOffboarding(id, action, "");
}


// [index.html] REPLACE loadAnalyticsTab
function loadAnalyticsTab() {
    // 1. Initialize User Select
    if (['admin','superadmin','manager','project_manager'].includes(selfRole)) {
        // Prepare list of ALL emails for default selection
        const allEmails = allUsersList.map(u => u.email);
        
        // Populate with all emails selected by default
        populateAdminDropdown(allUsersList, selfUserName, 'analytics-user', 'Select Users', allEmails);
    } else {
        // Agent View: Locked to self
        const container = document.getElementById('analytics-user-select-container');
        const myEmail = allUsersList.find(u => u.name === selfUserName)?.email || selfUserName;
        
        // Manually set dataset value for the reader functions
        container.dataset.value = JSON.stringify([myEmail]);
        
        container.innerHTML = `
            <div style="padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color-secondary);">
                Locked: <strong>${selfUserName}</strong>
            </div>`;
    }
    
    // 2. Set Default Dates
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('an-start-date').valueAsDate = firstDay;
    document.getElementById('an-end-date').valueAsDate = today;
    
    setStatus('analytics-status', '', '');
}

function loadAnalyticsData() {
    const start = document.getElementById('an-start-date').value;
    const end = document.getElementById('an-end-date').value;
    
    // Get Users from dataset (Multi-Select)
    const container = document.getElementById('analytics-user-select-container');
    let targetEmails = [];
    try {
        targetEmails = JSON.parse(container.dataset.value || "[]");
    } catch(e) { console.error("JSON Parse Error", e); }

    // Validation
    if (!start || !end) {
        setStatus('analytics-status', 'error', 'Please select both Start and End dates.');
        return;
    }
    if (targetEmails.length === 0) {
        setStatus('analytics-status', 'error', 'Please select at least one User.');
        return;
    }
    if (new Date(end) < new Date(start)) {
        setStatus('analytics-status', 'error', 'End Date cannot be before Start Date.');
        return;
    }

    const filter = {
        startDate: start,
        endDate: end,
        targetEmails: targetEmails // Send Array
    };

    setStatus('analytics-status', 'processing', `Crunching numbers for ${targetEmails.length} users...`);
    
    google.script.run
        .withSuccessHandler(data => {
            setStatus('analytics-status', 'success', 'Report generated successfully.');
            renderAnalytics(data);
        })
        .withFailureHandler(err => {
            setStatus('analytics-status', 'error', err.message);
        })
        .webGetAnalyticsData(filter);
}

function renderAnalytics(data) {
    // 1. Metrics (Same as before)
    const m = data.metrics;
    document.getElementById('an-stat-adherence').innerText = `${m.adherence}%`;
    document.getElementById('an-stat-shrinkage').innerText = `${m.shrinkage}%`;
    document.getElementById('an-stat-lateness').innerText = `${m.latenessMins}m`;
    document.getElementById('an-stat-worked').innerText = `${m.workedHours}h`;

    // 2. Timeline Grid Construction
    const container = document.getElementById('analytics-heatmap-container');
    const dates = Object.keys(data.timeline).sort();
    
    if (dates.length === 0) {
        container.innerHTML = '<p class="text-color-secondary">No activity found.</p>';
        return;
    }

    let html = '';

    // A. Draw the Time Scale Header (Once per day block or top)
    const renderScale = () => {
        let scaleHtml = '<div class="timeline-scale">';
        for (let i = 0; i < 24; i++) {
            scaleHtml += `<div class="scale-hour">${i}:00</div>`;
        }
        scaleHtml += '</div>';
        return scaleHtml;
    };

    // B. Draw Background Grid (48 columns for 30mins)
    const renderBgGrid = () => {
        let grid = '<div class="timeline-grid-bg">';
        for (let i = 0; i < 48; i++) { // 24 hours * 2
            grid += `<div class="grid-col"></div>`;
        }
        grid += '</div>';
        return grid;
    };

    // Iterate Dates
    dates.forEach(date => {
        html += `<h4 style="margin: 20px 0 10px 0; color:var(--konecta-blue); border-bottom:1px solid var(--border-color);">${date}</h4>`;
        html += `<div class="timeline-container">`;
        html += renderScale(); // 00:00 - 23:00 Header

        const agents = data.timeline[date];
        for (const [agentName, dataObj] of Object.entries(agents)) {
            const sched = dataObj.schedule;
            
            html += `
                <div class="timeline-agent-row">
                    <div class="timeline-agent-info">
                        <strong>${agentName}</strong><br>
                        <small class="text-color-secondary">${sched.type || 'Off'}</small>
                        <br><small style="font-size:0.7rem;">${sched.start || ''} - ${sched.end || ''}</small>
                    </div>
                    <div class="timeline-track-area">
                        ${renderBgGrid()}
                        ${renderAdvancedBars(dataObj)}
                    </div>
                </div>
            `;
        }
        html += `</div>`; // End Container
    });
    
    container.innerHTML = html;
}

// NEW: Renders Ghost Schedule, Actuals, and Flags
function renderAdvancedBars(dataObj) {
    const events = dataObj.events;
    const flags = dataObj.flags;
    const sched = dataObj.schedule;
    
    let html = '';
    
    // Helper: Time (HH:mm) to Percentage (0-100%)
    const getPos = (timeStr) => {
        if (!timeStr) return null;
        const [h, m] = timeStr.split(':').map(Number);
        const totalMins = (h * 60) + m;
        return (totalMins / 1440) * 100;
    };

    const getWidth = (start, end) => {
        const s = getPos(start);
        const e = getPos(end);
        if (s === null || e === null) return 0;
        let w = e - s;
        if (w < 0) w = (100 - s) + getPos(end); // Overnight handling roughly
        return w;
    };

    // 1. Render Ghost Schedule Bar (Background)
    if (sched.start && sched.end) {
        const left = getPos(sched.start);
        const width = getWidth(sched.start, sched.end);
        html += `<div class="t-bar t-sched" style="left:${left}%; width:${width}%;" title="Scheduled: ${sched.start}-${sched.end}">Scheduled</div>`;
    }

    // 2. Render Actual Activity Bars
    events.forEach(ev => {
        const left = getPos(ev.start);
        const width = getWidth(ev.start, ev.end);
        let cls = 't-work';
        if (ev.type === 'Break') cls = 't-break';
        if (ev.type === 'Lunch') cls = 't-lunch';
        if (ev.type === 'Aux') cls = 't-aux';
        
        html += `<div class="t-bar ${cls}" style="left:${left}%; width:${width}%;" title="${ev.label}: ${ev.start} - ${ev.end}">${ev.label}</div>`;
    });

    // 3. Render Flags
    flags.forEach(flag => {
        const left = getPos(flag.time);
        let icon = '!';
        let cls = 'flag-late';
        
        if (flag.type === 'EarlyLeave') { icon = 'üö™'; cls = 'flag-early'; }
        if (flag.type === 'Adherence') { icon = '‚ö°'; cls = 'flag-window'; } // Break Violation
        if (flag.type === 'NoShow') { icon = 'üö´'; cls = 'flag-noshow'; }
        if (flag.type === 'Lateness') { icon = '‚è∞'; }

        // Adjust position slightly to not overlap exactly on the line
        html += `<div class="t-flag ${cls}" style="left:calc(${left}% - 7px);" data-msg="${flag.msg}">${icon}</div>`;
    });

    return html;
}

// Helper to position bars based on time (00:00 to 24:00)
function renderTimelineBars(events) {
    let bars = '';
    const dayStart = 0; // 0 minutes (Midnight)
    const dayEnd = 1440; // 24 hours * 60
    
    const timeToMins = (t) => {
        if(!t) return 0;
        const p = t.split(':');
        return parseInt(p[0])*60 + parseInt(p[1]);
    };

    events.forEach(ev => {
        const startMins = timeToMins(ev.start);
        const endMins = timeToMins(ev.end);
        const duration = endMins - startMins;
        
        if (duration > 0) {
            const left = (startMins / dayEnd) * 100;
            const width = (duration / dayEnd) * 100;
            bars += `<div class="timeline-bar bar-${ev.type}" style="left:${left}%; width:${width}%;" title="${ev.label}: ${ev.start}-${ev.end}"></div>`;
        }
    });
    return bars;
}

function downloadPayrollReport() {
    const start = document.getElementById('an-start-date').value;
    const end = document.getElementById('an-end-date').value;
    
    const container = document.getElementById('analytics-user-select-container');
    let targetEmails = [];
    try {
        targetEmails = JSON.parse(container.dataset.value || "[]");
    } catch(e) {}

    // Validation
    if (!start || !end) {
        setStatus('analytics-status', 'error', 'Please select dates for the payroll export.');
        return;
    }
    if (targetEmails.length === 0) {
        setStatus('analytics-status', 'error', 'Please select at least one User.');
        return;
    }
    
    setStatus('analytics-status', 'processing', 'Generating Payroll CSV...');

    google.script.run
        .withSuccessHandler(csvData => {
            if (!csvData || csvData.length === 0) {
                setStatus('analytics-status', 'error', 'No data found for this period. Try extending the date range.');
                return;
            }
            
            // ... (CSV generation logic remains the same) ...
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Name,Email,Status,Login,Logout,Net Worked Hours,Lateness (Mins),Early Leave (Mins),Break Exceed (Mins),Lunch Exceed (Mins),Approved OT (Hours),OT Type,IsAbsent\r\n";

            csvData.forEach(row => {
                csvContent += `${row.Date},"${row.Name}","${row.Email}",${row.Status},${row.Login},${row.Logout},${row.NetWorkedHours},${row.LatenessMins},${row.EarlyLeaveMins},${row.BreakExceedMins},${row.LunchExceedMins},${row.ApprovedOTHours},${row.OTType},${row.IsAbsent}\r\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Payroll_Export_${start}_to_${end}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setStatus('analytics-status', 'success', 'Download started.');
        })
        .withFailureHandler(err => {
            setStatus('analytics-status', 'error', err.message);
        })
        .webGetPayrollExportData(start, end, targetEmails);
}


      // Initialize
      document.addEventListener("DOMContentLoaded", function() {
        loadUserInfo(); 
        
        // --- PHASE 6: AUTO-REFRESH ---
        // Refresh data every 600 seconds to keep the dashboard and status live
        setInterval(() => {
            if (!document.hidden) { // Only refresh if tab is visible
                console.log("Auto-refreshing data...");
                refreshCurrentData();
            }
        }, 600000);
        // -----------------------------

        // Set default dates
        const today = new Date();
        document.getElementById('schedule-start-date').valueAsDate = today;
        document.getElementById('leave-start-date').valueAsDate = today;
        document.getElementById('history-start-date').valueAsDate = today; 
        document.getElementById('history-end-date').valueAsDate = today; 
        document.getElementById('manual-punch-date').valueAsDate = today; 
        document.getElementById('admin-leave-start-date').valueAsDate = today; 
        document.getElementById('dashboard-date').valueAsDate = today;
        document.getElementById('coaching-session-date').valueAsDate = today;
        
        // Event Listeners
        document.getElementById('coaching-session-date').addEventListener('change', updateWeekNumber);
        
        // Initial Loads
        loadTemplateList();
        updateWeekNumber();
        calculateOverallScore();
        loadProjectsDropdown();
        toggleTimeFields();
      });
   </script>
   
   
   <!-- 
    ==================================================================
    == MODALS (Moved to end of body, styles are in <head>)
    ==================================================================
    -->
    
    <!-- Coaching Detail Modal -->
    <div id="coaching-detail-modal-backdrop" class="modal-backdrop"></div>
    <div id="coaching-detail-modal" class="modal">
      <div class="modal-header">
        <h2>Coaching Session Details</h2>
        <button class="close-btn" onclick="closeCoachingDetails()">&times;</button>
      </div>
      <div id="coaching-detail-modal-body" class="modal-body">
        <p class="text-color-secondary">Loading details...</p>
      </div>
      <div class="modal-footer">
        <button id="coaching-detail-export-btn" type="button" class="export-btn" style="display: none; margin-right: auto;" onclick="exportSessionDetails()">Export Details</button>
        <button type="button" class="btn-primary" onclick="closeCoachingDetails()">Close</button>
      </div>
    </div>
  
    <!-- New User Supervisor Modal -->
    <div id="supervisor-modal-backdrop" class="modal-backdrop"></div>
    <div id="supervisor-modal" class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Complete Your Registration</h2>
      </div>
      <div class="modal-body">
        <p class="text-color-secondary">Please fill in your details and select your reporting lines.</p>
        
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="reg-phone" placeholder="+20...">
        </div>
        <div class="form-group">
          <label>Home Address</label>
          <input type="text" id="reg-address" placeholder="Full Address">
        </div>

        <hr class="section-divider">

        <div class="form-group">
          <label>Direct Manager (Line Manager)</label>
          <select id="reg-direct-manager" required>
            <option value="">-- Select Direct Manager --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Functional / Project Manager</label>
          <select id="reg-functional-manager" required>
            <option value="">-- Select Project Manager --</option>
          </select>
        </div>

        <div id="supervisor-save-status" class="status-message"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-primary" onclick="saveMyRegistration()">Submit Registration</button>
      </div>
    </div>
    
    <!-- Generic Confirm Modal -->
    <div id="confirm-modal-backdrop" class="modal-backdrop"></div>
    <div id="confirm-modal" class="modal">
      <div class="modal-header">
        <h2 id="confirm-modal-title">Confirm Action</h2>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message" class="text-color-secondary">Are you sure you want to do this?</p>
      </div>
      <div class="modal-footer">
        <button id="confirm-modal-cancel-btn" type="button" class="btn-secondary" onclick="hideCustomConfirm()">Cancel</button>
        <button id="confirm-modal-confirm-btn" type="button" class="btn-danger">Confirm</button>
      </div>
    </div>

    <!-- Role Request Modal -->
    <div id="role-request-modal-backdrop" class="modal-backdrop"></div>
    <div id="role-request-modal" class="modal">
      <div class="modal-header">
        <h2>Request Role Upgrade</h2>
      </div>
      <div id="role-request-modal-body" class="modal-body">
        <form id="admin-request-form" class="form-container">
          <p class="text-color-secondary">If your supervisor is a 'Superadmin', you can request 'Admin' access. If you are an 'Admin', you can request 'Superadmin' access. Requests will be reviewed by the system owner.</p>
          <div class="form-group">
            <label for="admin-request-role">Role to Request</label>
            <select id="admin-request-role">
              <option value="admin">Admin</option>
              <option value="superadmin">Superadmin</option>
            </select>
          </div>
          <div class="form-group">
            <label for="admin-request-justification">Justification</label>
            <textarea id="admin-request-justification" rows="3" placeholder="Please explain why you need this role upgrade." required></textarea>
          </div>
          <div id="admin-request-status" class="status-message"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="hideRoleRequestModal()">Close</button>
        <button type="button" class="btn-primary" onclick="submitAdminRequest()">Submit Role Request</button>
      </div>
    </div>
    
    <!-- Role Approval Modal (Superadmin) -->
    <div id="role-approval-modal-backdrop" class="modal-backdrop"></div>
    <div id="role-approval-modal" class="modal">
      <div class="modal-header">
        <h2>Pending Role Upgrade Requests</h2>
        <button class="close-btn" onclick="hideRoleApprovalModal()">&times;</button>
      </div>
      <div id="role-approval-modal-body" class="modal-body">
        <div id="role-approval-status" class="status-message"></div>
        <div id="role-request-list" class="request-list" style="padding-top: 0; margin-top: 0;">
          <p class="text-color-secondary">Loading requests...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="hideRoleApprovalModal()">Close</button>
      </div>
    </div>
<!-- Requisition Modal -->
    <div id="req-modal-backdrop" class="modal-backdrop"></div>
<div id="req-modal" class="modal">
  <div class="modal-header">
    <h2>Open New Job Requisition</h2>
    <button class="close-btn" onclick="closeReqModal()">&times;</button>
  </div>
  <div class="modal-body">
    <form id="req-form" class="form-container" style="border:none; box-shadow:none; padding:0;">
      <div class="form-group"><label>Job Title</label><input type="text" id="req-title" required></div>
      <div class="form-group"><label>Department</label><input type="text" id="req-dept" required></div>
      <div class="form-group"><label>Hiring Manager Email</label><input type="email" id="req-manager" placeholder="manager@konecta.com" required></div>
      <div class="form-group"><label>Job Description</label><textarea id="req-desc" rows="4"></textarea></div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn-secondary" onclick="closeReqModal()">Cancel</button>
    <button class="btn-primary" onclick="submitRequisition()">Open Position</button>
  </div>
</div>
    <!-- Hiring Wizard Modal -->

    <div id="hire-modal-backdrop" class="modal-backdrop"></div>
<div id="hire-modal" class="modal" style="max-width: 900px; max-height: 95vh;">
  <div class="modal-header">
    <h2>Finalize Hiring Details</h2>
    <button class="close-btn" onclick="closeHireModal()">&times;</button>
  </div>
  <div class="modal-body">
    <p class="text-color-secondary">Please complete the employee profile to generate the contract and access.</p>
    <form id="hire-form" class="form-container" style="border:none; box-shadow:none; padding:0;">
      <input type="hidden" id="hire-candidate-id">
      
      <h3 style="font-size:1rem; color:var(--konecta-blue); border-bottom:1px solid #eee; padding-bottom:5px;">Contract & Role</h3>
      <div class="form-row">
        <div class="form-group"><label>Full Legal Name</label><input type="text" id="hire-fullname" required></div>
        <div class="form-group"><label>Konecta Email (Created by IT)</label><input type="email" id="hire-k-email" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Job Title</label><input type="text" id="hire-title" required></div>
        <div class="form-group"><label>Department</label><input type="text" id="hire-dept" required></div>
        <div class="form-group"><label>Job Level</label><input type="text" id="hire-level"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Contract Type</label>
          <select id="hire-contract">
            <option value="Permanent">Permanent</option>
            <option value="Temporary">Temporary</option>
            <option value="Internship">Internship</option>
          </select>
        </div>
        <div class="form-group"><label>Hiring Date</label><input type="date" id="hire-date" required></div>
        <div class="form-group"><label>Probation End Date</label><input type="date" id="hire-probation"></div>
      </div>

      <h3 style="font-size:1rem; color:var(--konecta-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">Reporting Line</h3>
      <div class="form-row">
        <div class="form-group"><label>Direct Manager Email</label><input type="email" id="hire-direct-mgr" required></div>
        <div class="form-group"><label>Project Manager Email</label><input type="email" id="hire-project-mgr"></div>
      </div>
      <div class="form-row">
        
        <div class="form-group"><label>Dotted Line Manager</label><input type="email" id="hire-dotted-mgr"></div>
      </div>

      <h3 style="font-size:1rem; color:var(--konecta-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">Financials & PII</h3>
      <div class="form-row">
        <div class="form-group"><label>Basic Salary</label><input type="number" id="hire-salary" required></div>
        <div class="form-group"><label>Hourly Rate (Optional)</label><input type="number" id="hire-hourly"></div>
        <div class="form-group"><label>Bonus Plan</label><input type="text" id="hire-bonus"></div>
        <div class="form-group"><label>Variable/Bonus</label><input type="number" id="hire-variable"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>National ID</label><input type="text" id="hire-nat-id" required></div>
        <div class="form-group"><label>Social Insurance No.</label><input type="text" id="hire-social"></div>
        <div class="form-group"><label>Passport No.</label><input type="text" id="hire-passport"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Birth Date</label><input type="date" id="hire-dob" required></div>
        <div class="form-group"><label>Marital Status</label>
          <select id="hire-marital">
            <option value="Single">Single</option>
            <option value="Married">Married</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label>Home Address</label><input type="text" id="hire-address" required></div>
      <div class="form-group"><label>Emergency Contact (Name - Relation - Phone)</label><input type="text" id="hire-emergency"></div>
    </form>
    <div id="hire-status" class="status-message"></div>
  </div>
  <div class="modal-footer">
    <button class="btn-secondary" onclick="closeHireModal()">Cancel</button>
    <button class="btn-primary submit-btn-green" onclick="submitHire()">Confirm Hire & Create Account</button>
  </div>
</div>

<!-- Rejection Modal -->
<div id="reject-modal-backdrop" class="modal-backdrop"></div>
<div id="reject-modal" class="modal">
  <div class="modal-header"><h2>Reject Candidate</h2></div>
  <div class="modal-body">
    <input type="hidden" id="reject-candidate-id">
    <label>Reason for Rejection (Internal)</label>
    <select id="reject-reason" class="form-group" style="width:100%; margin-bottom:10px;">
        <option value="Skills Mismatch">Skills Mismatch</option>
        <option value="Culture Fit">Culture Fit</option>
        <option value="Salary Expectations">Salary Expectations</option>
        <option value="Position Filled">Position Filled</option>
        <option value="Other">Other</option>
    </select>
    <div class="form-group">
        <input type="checkbox" id="reject-send-email" checked> 
        <label for="reject-send-email" style="display:inline;">Send Automated Rejection Email</label>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn-secondary" onclick="closeRejectModal()">Cancel</button>
    <button class="btn-danger" onclick="submitRejection()">Confirm Rejection</button>
  </div>
</div>

  </body>
</html>
